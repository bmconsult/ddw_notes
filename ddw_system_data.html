<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DDW System Data Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f2f2f7;
            color: #000;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2a5298 0%, #1e3a6b 100%);
            color: white;
            padding: max(env(safe-area-inset-top), 20px) 20px 20px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .breadcrumb {
            margin-top: 8px;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            background: white;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 77px;
            z-index: 90;
        }

        .tab-btn {
            padding: 8px 14px;
            border-radius: 20px;
            background: #f2f2f7;
            border: none;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .tab-btn.active {
            background: #2a5298;
            color: white;
        }

        /* Content */
        .content {
            padding: 16px;
            padding-bottom: 80px;
        }

        .data-section {
            display: none;
        }

        .data-section.active {
            display: block;
        }

        /* Form Sections */
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #2a5298;
            padding-bottom: 12px;
            border-bottom: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #2a5298;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        /* Save Button */
        .save-btn {
            position: fixed;
            bottom: max(env(safe-area-inset-bottom), 20px);
            right: 20px;
            background: #28a745;
            color: white;
            padding: 16px 24px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
            cursor: pointer;
            z-index: 99;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .save-btn:active {
            transform: scale(0.95);
        }

        /* List Items */
        .list-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #2a5298;
        }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .list-item-title {
            font-weight: 600;
            color: #2a5298;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .add-item-btn {
            width: 100%;
            padding: 12px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        .add-item-btn:active {
            background: #1e3a6b;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8e8e93;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        /* Deficiency Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-open {
            background: #f8d7da;
            color: #721c24;
        }

        .status-progress {
            background: #fff3cd;
            color: #856404;
        }

        .status-closed {
            background: #d4edda;
            color: #155724;
        }

        .type-significant {
            background: #dc3545;
            color: white;
        }

        .type-minor {
            background: #ffc107;
            color: #000;
        }

        .type-recommendation {
            background: #17a2b8;
            color: white;
        }
    
        /* List Item Cards */
        .list-item-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .list-item-header {
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .list-item-body {
            padding: 12px 16px;
        }
        
        .list-item-body > div {
            margin-bottom: 6px;
        }
        
        .list-item-body > div:last-child {
            margin-bottom: 0;
        }
        
        .list-item-actions {
            display: flex;
            gap: 6px;
            margin-left: auto;
        }
        
        .btn-edit, .btn-delete, .btn-add {
            padding: 4px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background: #ffc107;
            color: #000;
        }
        
        .btn-edit:hover {
            background: #ffb300;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .btn-add {
            background: #28a745;
            color: white;
        }
        
        .btn-add:hover {
            background: #218838;
        }
        
        /* Badges */
        .badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-green {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-red {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-orange {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-blue {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .badge-gray {
            background: #e9ecef;
            color: #6c757d;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }
        
        .modal-close:hover,
        .modal-close:focus {
            color: #000;
        }
        
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2a5298;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            background: #6c757d;
            color: white;
            transition: all 0.2s;
        }
        
        .modal-btn:hover {
            opacity: 0.9;
        }
        
        .modal-btn-primary {
            background: #2a5298;
        }
        
        .modal-btn-primary:hover {
            background: #1e3c72;
        }

</style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1 id="headerTitle">üìä System Data</h1>
            <button class="back-btn" onclick="goBack()">‚Üê Back</button>
        </div>
        <div class="breadcrumb" id="breadcrumb">Loading...</div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="dataTabs">
        <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
        <button class="tab-btn" onclick="switchTab('permits')">Permits</button>
        <button class="tab-btn" onclick="switchTab('sources')">Sources</button>
        <button class="tab-btn" onclick="switchTab('treatment')">Treatment</button>
        <button class="tab-btn" onclick="switchTab('distribution')">Distribution</button>
        <button class="tab-btn" onclick="switchTab('storage')">Storage</button>
        <button class="tab-btn" onclick="switchTab('pumps')">Pumps</button>
        <button class="tab-btn" onclick="switchTab('monitoring')">Monitoring</button>
        <button class="tab-btn" onclick="switchTab('management')">Management</button>
        <button class="tab-btn" onclick="switchTab('operators')">Operators</button>
        <button class="tab-btn" onclick="switchTab('deficiencies')">Deficiencies</button>
        <button class="tab-btn" onclick="switchTab('inspection')">Inspection History</button>
    </div>

    <!-- Content -->
    <div class="content">
        <!-- Overview Section -->
        <div class="data-section active" id="overview-section">
            <div class="form-section">
                <div class="section-title">System Overview</div>
                <div class="form-group">
                    <label class="form-label">PWS Number</label>
                    <input type="text" class="form-input" id="pws-number" placeholder="CA0000000">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">System Classification</label>
                        <select class="form-select" id="classification">
                            <option value="">Select...</option>
                            <option value="CWS">CWS - Community</option>
                            <option value="NTNC">NTNC - Non-Transient Non-Community</option>
                            <option value="TNC">TNC - Transient Non-Community</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Population Served</label>
                        <input type="number" class="form-input" id="population" placeholder="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Service Connections</label>
                        <input type="number" class="form-input" id="connections" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ownership Type</label>
                        <select class="form-select" id="ownership">
                            <option value="">Select...</option>
                            <option value="Public">Public</option>
                            <option value="Private">Private</option>
                            <option value="Mutual">Mutual</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Primary Contact Name</label>
                    <input type="text" class="form-input" id="contact-name" placeholder="Full Name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Contact Phone</label>
                        <input type="tel" class="form-input" id="contact-phone" placeholder="(555) 555-5555">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Email</label>
                        <input type="email" class="form-input" id="contact-email" placeholder="email@example.com">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Service Area Description</label>
                    <textarea class="form-textarea" id="service-area" placeholder="Describe the service area, location, topography, climate..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">System Address/Location</label>
                    <textarea class="form-textarea" id="location" placeholder="Street address, city, county..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Last Sanitary Survey</label>
                        <input type="date" class="form-input" id="last-survey">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next Survey Due</label>
                        <input type="date" class="form-input" id="next-survey">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-title">System History & Context</div>
                <div class="form-group">
                    <label class="form-label">System History Summary</label>
                    <textarea class="form-textarea" id="system-history" rows="4" placeholder="When was the system built? Major expansions or modifications? Significant events (contamination incidents, failures, emergencies)? How has the system evolved over time?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Known Vulnerabilities & Challenges</label>
                    <textarea class="form-textarea" id="known-vulnerabilities" rows="3" placeholder="Known problem areas, aging infrastructure concerns, capacity limitations, water quality challenges, geographical constraints, etc."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Service Area Characteristics</label>
                    <textarea class="form-textarea" id="service-area-characteristics" rows="3" placeholder="Community demographics, growth trends, seasonal population changes, development plans, economic factors affecting the system..."></textarea>
                </div>
            </div>
        </div>

        <!-- Permits Section -->
        <div class="data-section" id="permits-section">
            <div class="form-section">
                <div class="section-title">Current Permit</div>
                <div class="form-group">
                    <label class="form-label">Permit Number</label>
                    <input type="text" class="form-input" id="permit-number" placeholder="02-XX-XXXX">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Issue Date</label>
                        <input type="date" class="form-input" id="permit-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Permit Status</label>
                        <select class="form-select" id="permit-status">
                            <option value="">Select...</option>
                            <option value="Active">Active</option>
                            <option value="Pending Amendment">Pending Amendment</option>
                            <option value="Expired">Expired</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Outstanding Permit Conditions</label>
                    <textarea class="form-textarea" id="permit-conditions" placeholder="List any outstanding conditions..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Amendments</div>
                <div id="amendments-list"></div>
                <button class="add-item-btn" onclick="addAmendment()">+ Add Amendment</button>
            </div>

            <div class="form-section">
                <div class="section-title">Compliance History (Past 3 Years)</div>
                <div class="form-group">
                    <label class="form-label">Violations</label>
                    <textarea class="form-textarea" id="violations" placeholder="List violations, dates, status, resolution..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">MCL Exceedances</label>
                    <textarea class="form-textarea" id="mcl-exceedances" placeholder="List MCL exceedances, contaminants, dates..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Compliance Notes</label>
                    <textarea class="form-textarea" id="compliance-notes" placeholder="Additional compliance information..."></textarea>
                </div>
            </div>
        </div>

        <!-- Sources Section -->
        <div class="data-section" id="sources-section">
            <div class="form-section">
                <div class="section-title">Source Water Overview & Protection</div>
                <div class="form-group">
                    <label class="form-label">Overall Source Type</label>
                    <select class="form-select" id="overall-source-type">
                        <option value="">Select...</option>
                        <option value="Groundwater Only">Groundwater Only</option>
                        <option value="Surface Water Only">Surface Water Only</option>
                        <option value="GWI">Groundwater Under Influence (GWI)</option>
                        <option value="Mixed">Mixed Sources</option>
                        <option value="Purchased">100% Purchased Water</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Cross-Connection Control Program</label>
                    <textarea class="form-textarea" id="ccc-program" placeholder="Describe the CCC program: coordinator, survey date, policies, backflow device testing compliance..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Source Water Protection Measures</label>
                    <textarea class="form-textarea" id="swp-measures" placeholder="Wellhead protection programs, watershed management, source water assessments..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Watershed/Aquifer Concerns</label>
                    <textarea class="form-textarea" id="source-concerns" placeholder="Known contaminants, threats, monitoring trends..."></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-title">Individual Water Sources</div>
                <div id="sources-list"></div>
                <button class="add-item-btn" onclick="addSource()">+ Add Water Source</button>
            </div>
        </div>

        <!-- Treatment Section -->
        <div class="data-section" id="treatment-section">
            <div class="form-section">
                <div class="section-title">Overall Treatment Classification & Capacity</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Treatment Classification</label>
                        <select class="form-select" id="treatment-class">
                            <option value="">Select...</option>
                            <option value="T1">T1</option>
                            <option value="T2">T2</option>
                            <option value="T3">T3</option>
                            <option value="T4">T4</option>
                            <option value="T5">T5</option>
                            <option value="None">No Treatment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Rated Capacity (MGD)</label>
                        <input type="number" step="0.01" class="form-input" id="treatment-capacity" placeholder="0.00">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">General Treatment Type</label>
                    <input type="text" class="form-input" id="treatment-type" placeholder="e.g., Conventional, Membrane, Blending">
                </div>
                <div class="form-group">
                    <label class="form-label">Treatment Processes Overview</label>
                    <textarea class="form-textarea" id="treatment-processes" placeholder="List all treatment processes used across all facilities..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Operations Plan Date</label>
                    <input type="date" class="form-input" id="ops-plan-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Overall Treatment Challenges/Notes</label>
                    <textarea class="form-textarea" id="treatment-notes" placeholder="System-wide water quality challenges, seasonal issues, performance notes..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Treatment Performance Assessment</label>
                    <textarea class="form-textarea" id="treatment-performance" rows="3" placeholder="How is treatment performing? Compliance trends? Areas of excellence? Areas needing improvement? Process optimization efforts?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Recent Improvements & Upgrades</label>
                    <textarea class="form-textarea" id="treatment-improvements" rows="3" placeholder="Recent modifications, equipment installations, process changes, capital projects completed, performance enhancements..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Treatment Facilities</div>
                <div id="treatment-facilities-list"></div>
                <button class="add-item-btn" onclick="addTreatmentFacility()">+ Add Treatment Facility</button>
            </div>

            <div class="form-section">
                <div class="section-title">Chemical Storage (System-Wide)</div>
                <div id="chemicals-list"></div>
                <button class="add-item-btn" onclick="addChemical()">+ Add Chemical</button>
            </div>
        </div>

        <!-- Distribution Section -->
        <div class="data-section" id="distribution-section">
            <div class="form-section">
                <div class="section-title">Distribution System</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Distribution Classification</label>
                        <select class="form-select" id="dist-class">
                            <option value="">Select...</option>
                            <option value="D1">D1</option>
                            <option value="D2">D2</option>
                            <option value="D3">D3</option>
                            <option value="D4">D4</option>
                            <option value="D5">D5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Pipe Miles</label>
                        <input type="number" step="0.1" class="form-input" id="pipe-miles" placeholder="0.0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Pressure Zones</label>
                    <input type="text" class="form-input" id="pressure-zones" placeholder="e.g., Zone 1, Zone 2, High Zone">
                </div>
                <div class="form-group">
                    <label class="form-label">Pipe Materials & Ages</label>
                    <textarea class="form-textarea" id="pipe-materials" placeholder="AC: 60% (avg 50 yrs), DI: 20% (avg 30 yrs), PVC: 15% (avg 20 yrs), etc."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Valve Count</label>
                        <input type="number" class="form-input" id="valve-count" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hydrant Count</label>
                        <input type="number" class="form-input" id="hydrant-count" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Valve Exercise Program</label>
                    <textarea class="form-textarea" id="valve-program" placeholder="Frequency, % exercised annually, schedule..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Flushing Program</label>
                    <textarea class="form-textarea" id="flushing-program" placeholder="Frequency, dead-end flushing schedule..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Main Break History</label>
                    <input type="text" class="form-input" id="main-breaks" placeholder="Average breaks per year">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Cross-Connection Control</div>
                <div class="form-group">
                    <label class="form-label">Program Coordinator</label>
                    <input type="text" class="form-input" id="ccc-coordinator" placeholder="Name & Certification">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Last Survey Date</label>
                        <input type="date" class="form-input" id="ccc-survey-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Backflow Device Count</label>
                        <input type="number" class="form-input" id="backflow-count" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Test Compliance Rate</label>
                    <input type="text" class="form-input" id="test-compliance" placeholder="e.g., 98%">
                </div>
            </div>
        </div>

        <!-- Storage Section -->
        <div class="data-section" id="storage-section">
            <div class="form-section">
                <div class="section-title">Overall Storage Capacity & Adequacy</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Total Storage Capacity (MG)</label>
                        <input type="number" step="0.01" class="form-input" id="total-storage-capacity" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Redundancy Adequate?</label>
                        <select class="form-select" id="storage-redundancy">
                            <option value="">Select...</option>
                            <option value="Yes">Yes - Can meet demands with largest tank out of service</option>
                            <option value="No">No - Insufficient redundancy</option>
                            <option value="Marginal">Marginal - Depends on demand</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Overall Storage System Notes</label>
                    <textarea class="form-textarea" id="storage-notes" placeholder="System-wide storage adequacy, turnover concerns, water age issues..."></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-title">Individual Storage Tanks</div>
                <div id="storage-list"></div>
                <button class="add-item-btn" onclick="addStorage()">+ Add Storage Tank</button>
            </div>
        </div>

        <!-- Pumps Section -->
        <div class="data-section" id="pumps-section">
            <div class="form-section">
                <div class="section-title">Overall Pumping Capacity & Strategy</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Total System Pumping Capacity (GPM)</label>
                        <input type="number" class="form-input" id="total-pump-capacity" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Backup Power Strategy</label>
                        <select class="form-select" id="backup-power-strategy">
                            <option value="">Select...</option>
                            <option value="All Critical">All Critical Stations Have Backup</option>
                            <option value="Partial">Partial Backup Coverage</option>
                            <option value="None">No Backup Power</option>
                            <option value="Grid Tied">Grid Tied with Manual Transfer</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Pumping System Notes</label>
                    <textarea class="form-textarea" id="pumping-notes" placeholder="Overall system reliability, redundancy strategy, concerns..."></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-title">Pump Stations & Equipment</div>
                <div id="pumps-list"></div>
                <button class="add-item-btn" onclick="addPumpStation()">+ Add Pump Station</button>
            </div>
        </div>

        <!-- Monitoring Section -->
        <div class="data-section" id="monitoring-section">
            <div class="form-section">
                <div class="section-title">Primary Standards Monitoring</div>
                <div class="form-group">
                    <label class="form-label">IOC Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="ioc-schedule" placeholder="Triennial - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">Nitrate Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="nitrate-schedule" placeholder="Quarterly/Annual - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">VOC Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="voc-schedule" placeholder="Triennial - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">SOC Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="soc-schedule" placeholder="2Q/3yrs - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">Radionuclides Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="rad-schedule" placeholder="6-9 years - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">Active Waivers</label>
                    <textarea class="form-textarea" id="waivers" placeholder="List waivers and expiration dates..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Bacteriological (TCR/rTCR)</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Required Samples/Month</label>
                        <input type="number" class="form-input" id="tcr-samples" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">BSSP Approval Date</label>
                        <input type="date" class="form-input" id="bssp-date">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Last TCR Detection</label>
                    <input type="date" class="form-input" id="last-tcr">
                </div>
                <div class="form-group">
                    <label class="form-label">Level 1/2 Assessments</label>
                    <textarea class="form-textarea" id="assessments" placeholder="List any assessments and dates..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Disinfection Byproducts</div>
                <div class="form-group">
                    <label class="form-label">TTHM/HAA5 Monitoring Frequency</label>
                    <select class="form-select" id="dbp-freq">
                        <option value="">Select...</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="Reduced">Reduced</option>
                        <option value="N/A">N/A</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Sample Locations</label>
                    <input type="text" class="form-input" id="dbp-locations" placeholder="Number of locations">
                </div>
                <div class="form-group">
                    <label class="form-label">Recent LRAA Values</label>
                    <input type="text" class="form-input" id="lraa-values" placeholder="TTHM: XX ¬µg/L, HAA5: XX ¬µg/L">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Lead & Copper Rule</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">LCR Schedule</label>
                        <select class="form-select" id="lcr-schedule">
                            <option value="">Select...</option>
                            <option value="Annual">Annual</option>
                            <option value="Triennial">Triennial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Sample Date</label>
                        <input type="date" class="form-input" id="lcr-date">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">90th Percentile Values</label>
                    <input type="text" class="form-input" id="lcr-90th" placeholder="Lead: XX ¬µg/L, Copper: XX ¬µg/L">
                </div>
                <div class="form-group">
                    <label class="form-label">Service Line Inventory Status</label>
                    <textarea class="form-textarea" id="service-lines" placeholder="Completion status, lead lines identified, replacement plan..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">SWTR Compliance (if applicable)</div>
                <div class="form-group">
                    <label class="form-label">CT Compliance</label>
                    <textarea class="form-textarea" id="ct-compliance" placeholder="Contact time requirements, baffling factors..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Turbidity Compliance</label>
                    <input type="text" class="form-input" id="turbidity-compliance" placeholder="CFE turbidity range">
                </div>
                <div class="form-group">
                    <label class="form-label">Monthly Reporting Status</label>
                    <select class="form-select" id="swtr-reporting">
                        <option value="">Select...</option>
                        <option value="Current">Current</option>
                        <option value="Overdue">Overdue</option>
                        <option value="N/A">N/A</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Reporting Compliance</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">eAR Submission Status</label>
                        <select class="form-select" id="ear-status">
                            <option value="">Select...</option>
                            <option value="Current">Current</option>
                            <option value="Incomplete">Incomplete</option>
                            <option value="Overdue">Overdue</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CCR Distribution Date</label>
                        <input type="date" class="form-input" id="ccr-date">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Overdue Reports</label>
                    <textarea class="form-textarea" id="overdue-reports" placeholder="List any overdue reports..."></textarea>
                </div>
            </div>
        </div>

        <!-- Management Section -->
        <div class="data-section" id="management-section">
            <div class="form-section">
                <div class="section-title">Organization</div>
                <div class="form-group">
                    <label class="form-label">Ownership Structure</label>
                    <textarea class="form-textarea" id="ownership-structure" placeholder="Describe ownership and management structure..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Staffing Levels</label>
                    <textarea class="form-textarea" id="staffing" placeholder="Number of staff, roles, adequacy..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Emergency Contact Info</label>
                    <textarea class="form-textarea" id="emergency-contact" placeholder="24/7 contact information..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Planning Documents</div>
                <div class="form-group">
                    <label class="form-label">Capital Improvement Plan Date</label>
                    <input type="date" class="form-input" id="cip-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Urban Water Management Plan Date</label>
                    <input type="date" class="form-input" id="uwmp-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Water Shortage Contingency Plan Date</label>
                    <input type="date" class="form-input" id="wscp-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Emergency Response Plan Date</label>
                    <input type="date" class="form-input" id="erp-date">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Reliability & Redundancy</div>
                <div class="form-group">
                    <label class="form-label">SCADA System</label>
                    <textarea class="form-textarea" id="scada" placeholder="SCADA capabilities, monitoring, control..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Alarm Systems</label>
                    <textarea class="form-textarea" id="alarms" placeholder="Types of alarms, monitoring, response..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Backup Power</label>
                    <textarea class="form-textarea" id="backup-power" placeholder="Generator locations, capacity, fuel type..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Redundancy Notes</label>
                    <textarea class="form-textarea" id="redundancy" placeholder="Redundant equipment, spare parts inventory..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Security</div>
                <div class="form-group">
                    <label class="form-label">Physical Security Measures</label>
                    <textarea class="form-textarea" id="physical-security" placeholder="Fencing, locks, cameras, intrusion alarms..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">IT Security Program</label>
                    <textarea class="form-textarea" id="it-security" placeholder="Cybersecurity measures, training, protocols..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Risk & Resilience Assessment Date</label>
                    <input type="date" class="form-input" id="rra-date">
                    <small style="color: #6c757d;">Required for systems >3,300 population</small>
                </div>
                <div class="form-group">
                    <label class="form-label">EPRP Update Date</label>
                    <input type="date" class="form-input" id="eprp-date">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Climate Vulnerability</div>
                <div class="form-group">
                    <label class="form-label">eAR Climate Assessment Status</label>
                    <select class="form-select" id="climate-status">
                        <option value="">Select...</option>
                        <option value="Complete">Complete</option>
                        <option value="Incomplete">Incomplete</option>
                        <option value="Not Started">Not Started</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Identified Vulnerabilities</label>
                    <textarea class="form-textarea" id="vulnerabilities" placeholder="Drought, flooding, wildfire, landslide, extreme weather..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Mitigation Actions</label>
                    <textarea class="form-textarea" id="mitigation" placeholder="Actions taken or planned to address vulnerabilities..."></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-title">System Performance & Operational Context</div>
                <div class="form-group">
                    <label class="form-label">Overall System Performance Assessment</label>
                    <textarea class="form-textarea" id="performance-assessment" rows="4" placeholder="How is the system performing overall? Trends (improving/declining)? Areas of excellence? Areas of concern? Reliability issues? Water quality performance?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Operator Comments & Concerns</label>
                    <textarea class="form-textarea" id="operator-comments" rows="3" placeholder="Staff observations, recurring problems, resource limitations, training needs, operational challenges, maintenance concerns..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Recent System Changes & Improvements</label>
                    <textarea class="form-textarea" id="recent-improvements" rows="3" placeholder="Recent modifications, equipment installations, process changes, capital projects completed in the last 2-3 years..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Future Plans & Goals</label>
                    <textarea class="form-textarea" id="future-plans" rows="3" placeholder="System vision, planned initiatives, major challenges to address, long-term goals, anticipated capital improvements..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Outstanding Issues & Actions</label>
                    <textarea class="form-textarea" id="outstanding-issues" rows="3" placeholder="Prior deficiencies and current status, compliance orders, ongoing projects, items needing follow-up..."></textarea>
                </div>
            </div>
        </div>

        <!-- Operators Section -->
        <div class="data-section" id="operators-section">
            <div class="form-section">
                <div class="section-title">Chief Treatment Operator</div>
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="chief-treatment-name" placeholder="Full Name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cert Level</label>
                        <select class="form-select" id="chief-treatment-level">
                            <option value="">Select...</option>
                            <option value="T1">T1</option>
                            <option value="T2">T2</option>
                            <option value="T3">T3</option>
                            <option value="T4">T4</option>
                            <option value="T5">T5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cert Number</label>
                        <input type="text" class="form-input" id="chief-treatment-cert" placeholder="XXXXX">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Cert Expiration</label>
                    <input type="date" class="form-input" id="chief-treatment-exp">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Chief Distribution Operator</div>
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="chief-dist-name" placeholder="Full Name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cert Level</label>
                        <select class="form-select" id="chief-dist-level">
                            <option value="">Select...</option>
                            <option value="D1">D1</option>
                            <option value="D2">D2</option>
                            <option value="D3">D3</option>
                            <option value="D4">D4</option>
                            <option value="D5">D5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cert Number</label>
                        <input type="text" class="form-input" id="chief-dist-cert" placeholder="XXXXX">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Cert Expiration</label>
                    <input type="date" class="form-input" id="chief-dist-exp">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Shift Operators</div>
                <div id="shift-operators-list"></div>
                <button class="add-item-btn" onclick="addShiftOperator()">+ Add Shift Operator</button>
            </div>

            <div class="form-section">
                <div class="section-title">Staffing</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Required Treatment Cert</label>
                        <input type="text" class="form-input" id="req-treatment-cert" placeholder="e.g., T3">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Required Distribution Cert</label>
                        <input type="text" class="form-input" id="req-dist-cert" placeholder="e.g., D3">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Staffing Adequacy Notes</label>
                    <textarea class="form-textarea" id="staffing-notes" placeholder="Number of operators, 24/7 coverage, succession planning..."></textarea>
                </div>
            </div>
        </div>

        <!-- Deficiencies Section -->
        <div class="data-section" id="deficiencies-section">
            <div class="form-section">
                <div class="section-title">Previous Deficiencies</div>
                <div id="deficiencies-list"></div>
                <button class="add-item-btn" onclick="addDeficiency()">+ Add Deficiency</button>
            </div>
        </div>

        <!-- Inspection History Section -->
        <div class="data-section" id="inspection-section">
            <div class="form-section">
                <div class="section-title">Prior Sanitary Survey</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Previous Survey Date</label>
                        <input type="date" class="form-input" id="prior-survey-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Inspector Name</label>
                        <input type="text" class="form-input" id="prior-inspector" placeholder="Name of inspector">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Key Findings from Prior Survey</label>
                    <textarea class="form-textarea" id="prior-findings" rows="4" placeholder="Significant findings, deficiencies identified, major recommendations from the previous sanitary survey..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Resolution of Prior Issues</label>
                    <textarea class="form-textarea" id="prior-resolutions" rows="3" placeholder="What was done to address previous findings? Status of prior deficiencies? Actions taken since last survey?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Continuing Issues</label>
                    <textarea class="form-textarea" id="continuing-issues" rows="3" placeholder="Any issues from prior surveys that remain unresolved or are recurring concerns?"></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Current Inspection Planning</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Current Inspection Date</label>
                        <input type="date" class="form-input" id="current-inspection-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Inspector(s)</label>
                        <input type="text" class="form-input" id="current-inspectors" placeholder="Name(s) of inspector(s)">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Pre-Inspection Notes</label>
                    <textarea class="form-textarea" id="pre-inspection-notes" rows="3" placeholder="Items to focus on, areas of concern to investigate, follow-up from prior survey, questions to ask..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Follow-Up Items</label>
                    <textarea class="form-textarea" id="follow-up-items" rows="3" placeholder="Items requiring follow-up after this inspection, scheduled re-inspections, outstanding information requests..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Compliance History Context</div>
                <div class="form-group">
                    <label class="form-label">Historical Violations</label>
                    <textarea class="form-textarea" id="historical-violations" rows="3" placeholder="Summary of significant violations from past 5-10 years, patterns, trends, resolutions..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Enforcement Actions</label>
                    <textarea class="form-textarea" id="enforcement-actions" rows="3" placeholder="Prior enforcement actions (ACOs, CAOs, etc.), current compliance orders, enforcement history..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">System Responsiveness</label>
                    <textarea class="form-textarea" id="system-responsiveness" rows="3" placeholder="How responsive is the system to regulatory requirements? Track record of addressing issues? Quality of communication with DDW?"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <button class="save-btn" onclick="saveAllData()">üíæ Save All</button>

    <script>
        // App State
        let appData = {
            systems: [],
            version: '4.0'
        };

        let currentSystemId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Get system ID from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            currentSystemId = urlParams.get('systemId');
            
            if (!currentSystemId) {
                alert('No system selected');
                window.location.href = 'ddw_field_inspector.html';
                return;
            }
            
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system) {
                alert('System not found');
                window.location.href = 'ddw_field_inspector.html';
                return;
            }
            
            // Initialize system data structure if not exists
            if (!system.systemData) {
                system.systemData = {
                    overview: {},
                    permits: { amendments: [] },
                    sources: {
                        overallType: '',
                        cccProgram: '',
                        swpMeasures: '',
                        concerns: '',
                        list: [] // Individual sources
                    },
                    treatment: { 
                        classification: '',
                        capacity: '',
                        type: '',
                        processes: '',
                        opsPlanDate: '',
                        notes: '',
                        facilities: [], // Individual treatment facilities
                        chemicals: [] // System-wide chemicals
                    },
                    distribution: {},
                    storage: {
                        totalCapacity: '',
                        redundancyAdequate: '',
                        notes: '',
                        tanks: [] // Individual tanks
                    },
                    pumps: {
                        totalCapacity: '',
                        backupPowerStrategy: '',
                        notes: '',
                        stations: [] // Individual pump stations, each with pumps array
                    },
                    monitoring: {},
                    management: {},
                    operators: { chief: {}, shift: [] },
                    deficiencies: []
                };
            }
            
            updateHeader();
            loadAllData();
        });

        // Data persistence
        function loadData() {
            const savedData = localStorage.getItem('ddwFieldInspectorV4');
            if (savedData) {
                appData = JSON.parse(savedData);
            }
        }

        function saveData() {
            localStorage.setItem('ddwFieldInspectorV4', JSON.stringify(appData));
        }

        // Navigation
        function updateHeader() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (system) {
                document.getElementById('headerTitle').textContent = system.name;
                document.getElementById('breadcrumb').textContent = 'System Data Management';
            }
        }

        function goBack() {
            window.location.href = 'ddw_field_inspector.html';
        }

        // Tab switching
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update sections
            document.querySelectorAll('.data-section').forEach(section => section.classList.remove('active'));
            document.getElementById(tab + '-section').classList.add('active');
        }

        // Load all data into forms
        function loadAllData() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system || !system.systemData) return;
            
            const data = system.systemData;
            
            // Overview
            if (data.overview) {
                setValueIfExists('pws-number', data.overview.pwsNumber);
                setValueIfExists('classification', data.overview.classification);
                setValueIfExists('population', data.overview.population);
                setValueIfExists('connections', data.overview.connections);
                setValueIfExists('ownership', data.overview.ownership);
                setValueIfExists('contact-name', data.overview.contactName);
                setValueIfExists('contact-phone', data.overview.contactPhone);
                setValueIfExists('contact-email', data.overview.contactEmail);
                setValueIfExists('service-area', data.overview.serviceArea);
                setValueIfExists('location', data.overview.location);
                setValueIfExists('last-survey', data.overview.lastSurvey);
                setValueIfExists('next-survey', data.overview.nextSurvey);
                setValueIfExists('system-history', data.overview.systemHistory);
                setValueIfExists('known-vulnerabilities', data.overview.knownVulnerabilities);
                setValueIfExists('service-area-characteristics', data.overview.serviceAreaCharacteristics);
            }
            
            // Permits
            if (data.permits) {
                setValueIfExists('permit-number', data.permits.permitNumber);
                setValueIfExists('permit-date', data.permits.permitDate);
                setValueIfExists('permit-status', data.permits.permitStatus);
                setValueIfExists('permit-conditions', data.permits.permitConditions);
                setValueIfExists('violations', data.permits.violations);
                setValueIfExists('mcl-exceedances', data.permits.mclExceedances);
                setValueIfExists('compliance-notes', data.permits.complianceNotes);
                renderAmendments();
            }
            
            // Sources
            if (data.sources) {
                setValueIfExists('overall-source-type', data.sources.overallType);
                setValueIfExists('ccc-program', data.sources.cccProgram);
                setValueIfExists('swp-measures', data.sources.swpMeasures);
                setValueIfExists('source-concerns', data.sources.concerns);
            }
            renderSources();
            
            // Treatment
            if (data.treatment) {
                setValueIfExists('treatment-class', data.treatment.classification);
                setValueIfExists('treatment-capacity', data.treatment.capacity);
                setValueIfExists('treatment-type', data.treatment.type);
                setValueIfExists('treatment-processes', data.treatment.processes);
                setValueIfExists('ops-plan-date', data.treatment.opsPlanDate);
                setValueIfExists('treatment-notes', data.treatment.notes);
                setValueIfExists('treatment-performance', data.treatment.performance);
                setValueIfExists('treatment-improvements', data.treatment.improvements);
                renderTreatmentFacilities();
                renderChemicals();
            }
            
            // Distribution
            if (data.distribution) {
                setValueIfExists('dist-class', data.distribution.classification);
                setValueIfExists('pipe-miles', data.distribution.pipeMiles);
                setValueIfExists('pressure-zones', data.distribution.pressureZones);
                setValueIfExists('pipe-materials', data.distribution.pipeMaterials);
                setValueIfExists('valve-count', data.distribution.valveCount);
                setValueIfExists('hydrant-count', data.distribution.hydrantCount);
                setValueIfExists('valve-program', data.distribution.valveProgram);
                setValueIfExists('flushing-program', data.distribution.flushingProgram);
                setValueIfExists('main-breaks', data.distribution.mainBreaks);
                setValueIfExists('ccc-coordinator', data.distribution.cccCoordinator);
                setValueIfExists('ccc-survey-date', data.distribution.cccSurveyDate);
                setValueIfExists('backflow-count', data.distribution.backflowCount);
                setValueIfExists('test-compliance', data.distribution.testCompliance);
            }
            
            // Storage
            if (data.storage) {
                setValueIfExists('total-storage-capacity', data.storage.totalCapacity);
                setValueIfExists('storage-redundancy', data.storage.redundancyAdequate);
                setValueIfExists('storage-notes', data.storage.notes);
            }
            renderStorage();
            
            // Pumps
            if (data.pumps) {
                setValueIfExists('total-pump-capacity', data.pumps.totalCapacity);
                setValueIfExists('backup-power-strategy', data.pumps.backupPowerStrategy);
                setValueIfExists('pumping-notes', data.pumps.notes);
            }
            renderPumps();
            
            // Monitoring
            if (data.monitoring) {
                setValueIfExists('ioc-schedule', data.monitoring.iocSchedule);
                setValueIfExists('nitrate-schedule', data.monitoring.nitrateSchedule);
                setValueIfExists('voc-schedule', data.monitoring.vocSchedule);
                setValueIfExists('soc-schedule', data.monitoring.socSchedule);
                setValueIfExists('rad-schedule', data.monitoring.radSchedule);
                setValueIfExists('waivers', data.monitoring.waivers);
                setValueIfExists('tcr-samples', data.monitoring.tcrSamples);
                setValueIfExists('bssp-date', data.monitoring.bsspDate);
                setValueIfExists('last-tcr', data.monitoring.lastTcr);
                setValueIfExists('assessments', data.monitoring.assessments);
                setValueIfExists('dbp-freq', data.monitoring.dbpFreq);
                setValueIfExists('dbp-locations', data.monitoring.dbpLocations);
                setValueIfExists('lraa-values', data.monitoring.lraaValues);
                setValueIfExists('lcr-schedule', data.monitoring.lcrSchedule);
                setValueIfExists('lcr-date', data.monitoring.lcrDate);
                setValueIfExists('lcr-90th', data.monitoring.lcr90th);
                setValueIfExists('service-lines', data.monitoring.serviceLines);
                setValueIfExists('ct-compliance', data.monitoring.ctCompliance);
                setValueIfExists('turbidity-compliance', data.monitoring.turbidityCompliance);
                setValueIfExists('swtr-reporting', data.monitoring.swtrReporting);
                setValueIfExists('ear-status', data.monitoring.earStatus);
                setValueIfExists('ccr-date', data.monitoring.ccrDate);
                setValueIfExists('overdue-reports', data.monitoring.overdueReports);
            }
            
            // Management
            if (data.management) {
                setValueIfExists('ownership-structure', data.management.ownershipStructure);
                setValueIfExists('staffing', data.management.staffing);
                setValueIfExists('emergency-contact', data.management.emergencyContact);
                setValueIfExists('cip-date', data.management.cipDate);
                setValueIfExists('uwmp-date', data.management.uwmpDate);
                setValueIfExists('wscp-date', data.management.wscpDate);
                setValueIfExists('erp-date', data.management.erpDate);
                setValueIfExists('scada', data.management.scada);
                setValueIfExists('alarms', data.management.alarms);
                setValueIfExists('backup-power', data.management.backupPower);
                setValueIfExists('redundancy', data.management.redundancy);
                setValueIfExists('physical-security', data.management.physicalSecurity);
                setValueIfExists('it-security', data.management.itSecurity);
                setValueIfExists('rra-date', data.management.rraDate);
                setValueIfExists('eprp-date', data.management.eprpDate);
                setValueIfExists('climate-status', data.management.climateStatus);
                setValueIfExists('vulnerabilities', data.management.vulnerabilities);
                setValueIfExists('mitigation', data.management.mitigation);
                setValueIfExists('performance-assessment', data.management.performanceAssessment);
                setValueIfExists('operator-comments', data.management.operatorComments);
                setValueIfExists('recent-improvements', data.management.recentImprovements);
                setValueIfExists('future-plans', data.management.futurePlans);
                setValueIfExists('outstanding-issues', data.management.outstandingIssues);
            }
            
            // Operators
            if (data.operators) {
                setValueIfExists('chief-treatment-name', data.operators.chiefTreatmentName);
                setValueIfExists('chief-treatment-level', data.operators.chiefTreatmentLevel);
                setValueIfExists('chief-treatment-cert', data.operators.chiefTreatmentCert);
                setValueIfExists('chief-treatment-exp', data.operators.chiefTreatmentExp);
                setValueIfExists('chief-dist-name', data.operators.chiefDistName);
                setValueIfExists('chief-dist-level', data.operators.chiefDistLevel);
                setValueIfExists('chief-dist-cert', data.operators.chiefDistCert);
                setValueIfExists('chief-dist-exp', data.operators.chiefDistExp);
                setValueIfExists('req-treatment-cert', data.operators.reqTreatmentCert);
                setValueIfExists('req-dist-cert', data.operators.reqDistCert);
                setValueIfExists('staffing-notes', data.operators.staffingNotes);
                renderShiftOperators();
            }
            
            // Deficiencies
            renderDeficiencies();
            
            // Inspection History
            if (data.inspectionHistory) {
                setValueIfExists('prior-survey-date', data.inspectionHistory.priorSurveyDate);
                setValueIfExists('prior-inspector', data.inspectionHistory.priorInspector);
                setValueIfExists('prior-findings', data.inspectionHistory.priorFindings);
                setValueIfExists('prior-resolutions', data.inspectionHistory.priorResolutions);
                setValueIfExists('continuing-issues', data.inspectionHistory.continuingIssues);
                setValueIfExists('current-inspection-date', data.inspectionHistory.currentInspectionDate);
                setValueIfExists('current-inspectors', data.inspectionHistory.currentInspectors);
                setValueIfExists('pre-inspection-notes', data.inspectionHistory.preInspectionNotes);
                setValueIfExists('follow-up-items', data.inspectionHistory.followUpItems);
                setValueIfExists('historical-violations', data.inspectionHistory.historicalViolations);
                setValueIfExists('enforcement-actions', data.inspectionHistory.enforcementActions);
                setValueIfExists('system-responsiveness', data.inspectionHistory.systemResponsiveness);
            }
        }

        function setValueIfExists(id, value) {
            const element = document.getElementById(id);
            if (element && value !== undefined && value !== null) {
                element.value = value;
            }
        }

        // Save all data
        function saveAllData() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system) return;
            
            if (!system.systemData) {
                system.systemData = {};
            }
            
            // Overview
            system.systemData.overview = {
                pwsNumber: document.getElementById('pws-number').value,
                classification: document.getElementById('classification').value,
                population: document.getElementById('population').value,
                connections: document.getElementById('connections').value,
                ownership: document.getElementById('ownership').value,
                contactName: document.getElementById('contact-name').value,
                contactPhone: document.getElementById('contact-phone').value,
                contactEmail: document.getElementById('contact-email').value,
                serviceArea: document.getElementById('service-area').value,
                location: document.getElementById('location').value,
                lastSurvey: document.getElementById('last-survey').value,
                nextSurvey: document.getElementById('next-survey').value
            };
            
            // Permits
            if (!system.systemData.permits) system.systemData.permits = { amendments: [] };
            system.systemData.permits.permitNumber = document.getElementById('permit-number').value;
            system.systemData.permits.permitDate = document.getElementById('permit-date').value;
            system.systemData.permits.permitStatus = document.getElementById('permit-status').value;
            system.systemData.permits.permitConditions = document.getElementById('permit-conditions').value;
            system.systemData.permits.violations = document.getElementById('violations').value;
            system.systemData.permits.mclExceedances = document.getElementById('mcl-exceedances').value;
            system.systemData.permits.complianceNotes = document.getElementById('compliance-notes').value;
            
            // Treatment
            if (!system.systemData.treatment) system.systemData.treatment = { chemicals: [] };
            system.systemData.treatment.classification = document.getElementById('treatment-class').value;
            system.systemData.treatment.capacity = document.getElementById('treatment-capacity').value;
            system.systemData.treatment.type = document.getElementById('treatment-type').value;
            system.systemData.treatment.processes = document.getElementById('treatment-processes').value;
            system.systemData.treatment.opsPlanDate = document.getElementById('ops-plan-date').value;
            system.systemData.treatment.notes = document.getElementById('treatment-notes').value;
            
            // Distribution
            if (!system.systemData.distribution) system.systemData.distribution = {};
            system.systemData.distribution.classification = document.getElementById('dist-class').value;
            system.systemData.distribution.pipeMiles = document.getElementById('pipe-miles').value;
            system.systemData.distribution.pressureZones = document.getElementById('pressure-zones').value;
            system.systemData.distribution.pipeMaterials = document.getElementById('pipe-materials').value;
            system.systemData.distribution.valveCount = document.getElementById('valve-count').value;
            system.systemData.distribution.hydrantCount = document.getElementById('hydrant-count').value;
            system.systemData.distribution.valveProgram = document.getElementById('valve-program').value;
            system.systemData.distribution.flushingProgram = document.getElementById('flushing-program').value;
            system.systemData.distribution.mainBreaks = document.getElementById('main-breaks').value;
            system.systemData.distribution.cccCoordinator = document.getElementById('ccc-coordinator').value;
            system.systemData.distribution.cccSurveyDate = document.getElementById('ccc-survey-date').value;
            system.systemData.distribution.backflowCount = document.getElementById('backflow-count').value;
            system.systemData.distribution.testCompliance = document.getElementById('test-compliance').value;
            
            // Monitoring
            if (!system.systemData.monitoring) system.systemData.monitoring = {};
            system.systemData.monitoring.iocSchedule = document.getElementById('ioc-schedule').value;
            system.systemData.monitoring.nitrateSchedule = document.getElementById('nitrate-schedule').value;
            system.systemData.monitoring.vocSchedule = document.getElementById('voc-schedule').value;
            system.systemData.monitoring.socSchedule = document.getElementById('soc-schedule').value;
            system.systemData.monitoring.radSchedule = document.getElementById('rad-schedule').value;
            system.systemData.monitoring.waivers = document.getElementById('waivers').value;
            system.systemData.monitoring.tcrSamples = document.getElementById('tcr-samples').value;
            system.systemData.monitoring.bsspDate = document.getElementById('bssp-date').value;
            system.systemData.monitoring.lastTcr = document.getElementById('last-tcr').value;
            system.systemData.monitoring.assessments = document.getElementById('assessments').value;
            system.systemData.monitoring.dbpFreq = document.getElementById('dbp-freq').value;
            system.systemData.monitoring.dbpLocations = document.getElementById('dbp-locations').value;
            system.systemData.monitoring.lraaValues = document.getElementById('lraa-values').value;
            system.systemData.monitoring.lcrSchedule = document.getElementById('lcr-schedule').value;
            system.systemData.monitoring.lcrDate = document.getElementById('lcr-date').value;
            system.systemData.monitoring.lcr90th = document.getElementById('lcr-90th').value;
            system.systemData.monitoring.serviceLines = document.getElementById('service-lines').value;
            system.systemData.monitoring.ctCompliance = document.getElementById('ct-compliance').value;
            system.systemData.monitoring.turbidityCompliance = document.getElementById('turbidity-compliance').value;
            system.systemData.monitoring.swtrReporting = document.getElementById('swtr-reporting').value;
            system.systemData.monitoring.earStatus = document.getElementById('ear-status').value;
            system.systemData.monitoring.ccrDate = document.getElementById('ccr-date').value;
            system.systemData.monitoring.overdueReports = document.getElementById('overdue-reports').value;
            
            // Management
            if (!system.systemData.management) system.systemData.management = {};
            system.systemData.management.ownershipStructure = document.getElementById('ownership-structure').value;
            system.systemData.management.staffing = document.getElementById('staffing').value;
            system.systemData.management.emergencyContact = document.getElementById('emergency-contact').value;
            system.systemData.management.cipDate = document.getElementById('cip-date').value;
            system.systemData.management.uwmpDate = document.getElementById('uwmp-date').value;
            system.systemData.management.wscpDate = document.getElementById('wscp-date').value;
            system.systemData.management.erpDate = document.getElementById('erp-date').value;
            system.systemData.management.scada = document.getElementById('scada').value;
            system.systemData.management.alarms = document.getElementById('alarms').value;
            system.systemData.management.backupPower = document.getElementById('backup-power').value;
            system.systemData.management.redundancy = document.getElementById('redundancy').value;
            system.systemData.management.physicalSecurity = document.getElementById('physical-security').value;
            system.systemData.management.itSecurity = document.getElementById('it-security').value;
            system.systemData.management.rraDate = document.getElementById('rra-date').value;
            system.systemData.management.eprpDate = document.getElementById('eprp-date').value;
            system.systemData.management.climateStatus = document.getElementById('climate-status').value;
            system.systemData.management.vulnerabilities = document.getElementById('vulnerabilities').value;
            system.systemData.management.mitigation = document.getElementById('mitigation').value;
            
            // Operators
            if (!system.systemData.operators) system.systemData.operators = { shiftOperators: [] };
            system.systemData.operators.chiefTreatmentName = document.getElementById('chief-treatment-name').value;
            system.systemData.operators.chiefTreatmentLevel = document.getElementById('chief-treatment-level').value;
            system.systemData.operators.chiefTreatmentCert = document.getElementById('chief-treatment-cert').value;
            system.systemData.operators.chiefTreatmentExp = document.getElementById('chief-treatment-exp').value;
            system.systemData.operators.chiefDistName = document.getElementById('chief-dist-name').value;
            system.systemData.operators.chiefDistLevel = document.getElementById('chief-dist-level').value;
            system.systemData.operators.chiefDistCert = document.getElementById('chief-dist-cert').value;
            system.systemData.operators.chiefDistExp = document.getElementById('chief-dist-exp').value;
            system.systemData.operators.reqTreatmentCert = document.getElementById('req-treatment-cert').value;
            system.systemData.operators.reqDistCert = document.getElementById('req-dist-cert').value;
            system.systemData.operators.staffingNotes = document.getElementById('staffing-notes').value;
            
            saveData();
            
            // Visual feedback
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úì Saved!';
            btn.style.background = '#28a745';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        // Placeholder render functions (to be implemented)
        function renderAmendments() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const container = document.getElementById('amendments-list');
            if (!system.systemData.permits.amendments || system.systemData.permits.amendments.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div style="color: #8e8e93;">No amendments added yet</div></div>';
            } else {
                // Will implement full rendering later
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px;">Amendments list (coming soon)</div>';
            }
        }

        // ========== RENDERING FUNCTIONS ==========
        
        // Amendments
        function renderAmendments() {
            const container = document.getElementById('amendments-list');
            if (!currentSystemData.permits || !currentSystemData.permits.amendments || currentSystemData.permits.amendments.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No amendments added yet</div>';
                return;
            }
            container.innerHTML = currentSystemData.permits.amendments.map((amend, i) => `
                <div class="list-item-card">
                    <div class="list-item-header">
                        <strong>Amendment #${amend.number || i+1}</strong>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editAmendment(${i})">Edit</button>
                            <button class="btn-delete" onclick="deleteAmendment(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>Date:</strong> ${amend.date || 'N/A'}</div>
                        <div><strong>Purpose:</strong> ${amend.purpose || 'N/A'}</div>
                    </div>
                </div>
            `).join('');
        }

        function addAmendment() {
            showModal(`
                <h3>Add Amendment</h3>
                <div class="form-group">
                    <label>Amendment Number</label>
                    <input type="text" id="modal-amend-number" class="form-input" placeholder="e.g., 1, 2, 3">
                </div>
                <div class="form-group">
                    <label>Date Issued</label>
                    <input type="date" id="modal-amend-date" class="form-input">
                </div>
                <div class="form-group">
                    <label>Purpose</label>
                    <textarea id="modal-amend-purpose" class="form-textarea" rows="3" placeholder="Reason for amendment..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveAmendment()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveAmendment(index = null) {
            const amendment = {
                number: document.getElementById('modal-amend-number').value,
                date: document.getElementById('modal-amend-date').value,
                purpose: document.getElementById('modal-amend-purpose').value
            };
            
            if (!currentSystemData.permits) currentSystemData.permits = {};
            if (!currentSystemData.permits.amendments) currentSystemData.permits.amendments = [];
            
            if (index !== null) {
                currentSystemData.permits.amendments[index] = amendment;
            } else {
                currentSystemData.permits.amendments.push(amendment);
            }
            
            hideModal();
            renderAmendments();
            saveData();
        }

        function editAmendment(index) {
            const amend = currentSystemData.permits.amendments[index];
            showModal(`
                <h3>Edit Amendment</h3>
                <div class="form-group">
                    <label>Amendment Number</label>
                    <input type="text" id="modal-amend-number" class="form-input" value="${amend.number || ''}">
                </div>
                <div class="form-group">
                    <label>Date Issued</label>
                    <input type="date" id="modal-amend-date" class="form-input" value="${amend.date || ''}">
                </div>
                <div class="form-group">
                    <label>Purpose</label>
                    <textarea id="modal-amend-purpose" class="form-textarea" rows="3">${amend.purpose || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveAmendment(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteAmendment(index) {
            if (confirm('Delete this amendment?')) {
                currentSystemData.permits.amendments.splice(index, 1);
                renderAmendments();
                saveData();
            }
        }

        // Sources (with well construction details)
        function renderSources() {
            const container = document.getElementById('sources-list');
            if (!currentSystemData.sources || !currentSystemData.sources.list || currentSystemData.sources.list.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No sources added yet</div>';
                return;
            }
            container.innerHTML = currentSystemData.sources.list.map((src, i) => `
                <div class="list-item-card">
                    <div class="list-item-header">
                        <strong>${src.name || 'Unnamed Source'}</strong> 
                        <span class="badge badge-${src.status === 'Active' ? 'green' : 'gray'}">${src.status || 'Unknown'}</span>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editSource(${i})">Edit</button>
                            <button class="btn-delete" onclick="deleteSource(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>PS Code:</strong> ${src.psCode || 'N/A'}</div>
                        <div><strong>Type:</strong> ${src.type || 'N/A'} | <strong>Capacity:</strong> ${src.capacity || 'N/A'} MGD</div>
                        ${src.constructionDate ? `<div><strong>Construction:</strong> ${src.constructionDate}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function addSource() {
            showModal(`
                <h3>Add Water Source</h3>
                <div class="form-group">
                    <label>Source Name *</label>
                    <input type="text" id="modal-src-name" class="form-input" placeholder="e.g., Well #1, Surface Water Intake">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>PS Code</label>
                        <input type="text" id="modal-src-ps" class="form-input" placeholder="CA#######_###_###">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-src-type" class="form-select">
                            <option value="">Select...</option>
                            <option>Groundwater</option>
                            <option>Surface Water</option>
                            <option>Purchased</option>
                            <option>Emergency</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Status</label>
                        <select id="modal-src-status" class="form-select">
                            <option>Active</option>
                            <option>Standby</option>
                            <option>Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Capacity (MGD)</label>
                        <input type="number" step="0.01" id="modal-src-capacity" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Construction Date</label>
                    <input type="date" id="modal-src-date" class="form-input">
                </div>
                <div class="form-group">
                    <label>Well Details (if GW)</label>
                    <textarea id="modal-src-well" class="form-textarea" rows="3" placeholder="Casing depth, diameter, material; Annular seal depth; Screen depth and slot size"></textarea>
                </div>
                <div class="form-group">
                    <label>DWSAP Evaluation Date</label>
                    <input type="date" id="modal-src-dwsap" class="form-input">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-src-notes" class="form-textarea" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveSource()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveSource(index = null) {
            const source = {
                name: document.getElementById('modal-src-name').value,
                psCode: document.getElementById('modal-src-ps').value,
                type: document.getElementById('modal-src-type').value,
                status: document.getElementById('modal-src-status').value,
                capacity: document.getElementById('modal-src-capacity').value,
                constructionDate: document.getElementById('modal-src-date').value,
                wellDetails: document.getElementById('modal-src-well').value,
                dwsapDate: document.getElementById('modal-src-dwsap').value,
                notes: document.getElementById('modal-src-notes').value
            };
            
            if (!currentSystemData.sources) currentSystemData.sources = { list: [] };
            if (!currentSystemData.sources.list) currentSystemData.sources.list = [];
            
            if (index !== null) {
                currentSystemData.sources.list[index] = source;
            } else {
                currentSystemData.sources.list.push(source);
            }
            
            hideModal();
            renderSources();
            saveData();
        }

        function editSource(index) {
            const src = currentSystemData.sources.list[index];
            showModal(`
                <h3>Edit Water Source</h3>
                <div class="form-group">
                    <label>Source Name *</label>
                    <input type="text" id="modal-src-name" class="form-input" value="${src.name || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>PS Code</label>
                        <input type="text" id="modal-src-ps" class="form-input" value="${src.psCode || ''}">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-src-type" class="form-select">
                            <option value="">Select...</option>
                            <option ${src.type === 'Groundwater' ? 'selected' : ''}>Groundwater</option>
                            <option ${src.type === 'Surface Water' ? 'selected' : ''}>Surface Water</option>
                            <option ${src.type === 'Purchased' ? 'selected' : ''}>Purchased</option>
                            <option ${src.type === 'Emergency' ? 'selected' : ''}>Emergency</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Status</label>
                        <select id="modal-src-status" class="form-select">
                            <option ${src.status === 'Active' ? 'selected' : ''}>Active</option>
                            <option ${src.status === 'Standby' ? 'selected' : ''}>Standby</option>
                            <option ${src.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Capacity (MGD)</label>
                        <input type="number" step="0.01" id="modal-src-capacity" class="form-input" value="${src.capacity || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Construction Date</label>
                    <input type="date" id="modal-src-date" class="form-input" value="${src.constructionDate || ''}">
                </div>
                <div class="form-group">
                    <label>Well Details (if GW)</label>
                    <textarea id="modal-src-well" class="form-textarea" rows="3">${src.wellDetails || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>DWSAP Evaluation Date</label>
                    <input type="date" id="modal-src-dwsap" class="form-input" value="${src.dwsapDate || ''}">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-src-notes" class="form-textarea" rows="2">${src.notes || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveSource(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteSource(index) {
            if (confirm('Delete this source?')) {
                currentSystemData.sources.list.splice(index, 1);
                renderSources();
                saveData();
            }
        }

        // ========== TREATMENT FACILITIES ==========
        function renderTreatmentFacilities() {
            const container = document.getElementById('treatment-facilities-list');
            if (!currentSystemData.treatment || !currentSystemData.treatment.facilities || currentSystemData.treatment.facilities.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No treatment facilities added yet</div>';
                return;
            }
            container.innerHTML = currentSystemData.treatment.facilities.map((facility, i) => `
                <div class="list-item-card" style="border-left: 4px solid #28a745;">
                    <div class="list-item-header" style="background: #f0fff0;">
                        <strong style="color: #28a745;">üè≠ ${facility.name || 'Unnamed Facility'}</strong>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editTreatmentFacility(${i})">Edit Facility</button>
                            <button class="btn-delete" onclick="deleteTreatmentFacility(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>Capacity:</strong> ${facility.capacity || 'N/A'} MGD | <strong>Classification:</strong> ${facility.classification || 'N/A'}</div>
                        <div><strong>Processes:</strong> ${facility.processes || 'N/A'}</div>
                        ${facility.location ? `<div><strong>Location:</strong> ${facility.location}</div>` : ''}
                        
                        <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>Individual Filters/Processes (${(facility.filters || []).length})</strong>
                                <button class="btn-add" style="font-size: 0.85rem; padding: 4px 12px;" onclick="addIndividualFilter(${i})">+ Add Filter</button>
                            </div>
                            ${(facility.filters || []).length === 0 ? 
                                '<div style="color: #8e8e93; text-align: center; padding: 10px;">No filters/processes added</div>' :
                                facility.filters.map((filter, j) => `
                                    <div style="border: 1px solid #e9ecef; padding: 8px; margin: 5px 0; border-radius: 4px; background: #fafafa;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <strong>${filter.name || `Filter #${j+1}`}</strong>
                                                ${filter.type ? ` | ${filter.type}` : ''}
                                                ${filter.capacity ? ` | ${filter.capacity} MGD` : ''}
                                                ${filter.media ? ` | ${filter.media}` : ''}
                                            </div>
                                            <div>
                                                <button class="btn-edit" style="font-size: 0.8rem; padding: 2px 8px;" onclick="editIndividualFilter(${i}, ${j})">Edit</button>
                                                <button class="btn-delete" style="font-size: 0.8rem; padding: 2px 8px;" onclick="deleteIndividualFilter(${i}, ${j})">Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addTreatmentFacility() {
            showModal(`
                <h3>Add Treatment Facility</h3>
                <div class="form-group">
                    <label>Facility Name *</label>
                    <input type="text" id="modal-facility-name" class="form-input" placeholder="e.g., Main WTP, Well #1 Chlorination">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="modal-facility-location" class="form-input" placeholder="Address or description">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity (MGD)</label>
                        <input type="number" step="0.01" id="modal-facility-capacity" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Classification</label>
                        <select id="modal-facility-class" class="form-select">
                            <option value="">Select...</option>
                            <option value="T1">T1</option>
                            <option value="T2">T2</option>
                            <option value="T3">T3</option>
                            <option value="T4">T4</option>
                            <option value="T5">T5</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Treatment Processes</label>
                    <textarea id="modal-facility-processes" class="form-textarea" rows="3" placeholder="e.g., Coagulation, Sedimentation, Filtration, Disinfection"></textarea>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-facility-notes" class="form-textarea" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveTreatmentFacility()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveTreatmentFacility(index = null) {
            const facility = {
                name: document.getElementById('modal-facility-name').value,
                location: document.getElementById('modal-facility-location').value,
                capacity: document.getElementById('modal-facility-capacity').value,
                classification: document.getElementById('modal-facility-class').value,
                processes: document.getElementById('modal-facility-processes').value,
                notes: document.getElementById('modal-facility-notes').value,
                filters: []
            };
            
            if (!currentSystemData.treatment.facilities) {
                currentSystemData.treatment.facilities = [];
            }
            
            if (index !== null) {
                // Preserve existing filters when editing facility
                facility.filters = currentSystemData.treatment.facilities[index].filters || [];
                currentSystemData.treatment.facilities[index] = facility;
            } else {
                currentSystemData.treatment.facilities.push(facility);
            }
            
            hideModal();
            renderTreatmentFacilities();
            saveData();
        }

        function editTreatmentFacility(index) {
            const facility = currentSystemData.treatment.facilities[index];
            showModal(`
                <h3>Edit Treatment Facility</h3>
                <div class="form-group">
                    <label>Facility Name *</label>
                    <input type="text" id="modal-facility-name" class="form-input" value="${facility.name || ''}">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="modal-facility-location" class="form-input" value="${facility.location || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity (MGD)</label>
                        <input type="number" step="0.01" id="modal-facility-capacity" class="form-input" value="${facility.capacity || ''}">
                    </div>
                    <div class="form-group">
                        <label>Classification</label>
                        <select id="modal-facility-class" class="form-select">
                            <option value="">Select...</option>
                            <option value="T1" ${facility.classification === 'T1' ? 'selected' : ''}>T1</option>
                            <option value="T2" ${facility.classification === 'T2' ? 'selected' : ''}>T2</option>
                            <option value="T3" ${facility.classification === 'T3' ? 'selected' : ''}>T3</option>
                            <option value="T4" ${facility.classification === 'T4' ? 'selected' : ''}>T4</option>
                            <option value="T5" ${facility.classification === 'T5' ? 'selected' : ''}>T5</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Treatment Processes</label>
                    <textarea id="modal-facility-processes" class="form-textarea" rows="3">${facility.processes || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-facility-notes" class="form-textarea" rows="2">${facility.notes || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveTreatmentFacility(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteTreatmentFacility(index) {
            if (confirm('Delete this treatment facility and all its filters?')) {
                currentSystemData.treatment.facilities.splice(index, 1);
                renderTreatmentFacilities();
                saveData();
            }
        }

        // Individual Filters (nested within treatment facilities)
        function addIndividualFilter(facilityIndex) {
            showModal(`
                <h3>Add Individual Filter/Process</h3>
                <p style="color: #666; margin-bottom: 15px;">Adding to: <strong>${currentSystemData.treatment.facilities[facilityIndex].name}</strong></p>
                <div class="form-group">
                    <label>Filter Name/ID *</label>
                    <input type="text" id="modal-filter-name" class="form-input" placeholder="e.g., Filter #1, Rapid Sand Filter A">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-filter-type" class="form-select">
                            <option value="">Select...</option>
                            <option value="Rapid Sand">Rapid Sand Filter</option>
                            <option value="Dual Media">Dual Media Filter</option>
                            <option value="Pressure Filter">Pressure Filter</option>
                            <option value="Membrane">Membrane (UF/MF)</option>
                            <option value="Slow Sand">Slow Sand Filter</option>
                            <option value="Cartridge">Cartridge Filter</option>
                            <option value="Bag Filter">Bag Filter</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Capacity (MGD)</label>
                        <input type="number" step="0.001" id="modal-filter-capacity" class="form-input" placeholder="0.000">
                    </div>
                </div>
                <div class="form-group">
                    <label>Filter Media</label>
                    <input type="text" id="modal-filter-media" class="form-input" placeholder="e.g., 24 in sand / 12 in anthracite">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Current Turbidity (NTU)</label>
                        <input type="number" step="0.01" id="modal-filter-turbidity" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Condition</label>
                        <select id="modal-filter-condition" class="form-select">
                            <option value="">Select...</option>
                            <option value="Good">Good</option>
                            <option value="Fair">Fair</option>
                            <option value="Poor">Poor</option>
                            <option value="Out of Service">Out of Service</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Backwash Frequency (days)</label>
                        <input type="number" id="modal-filter-backwash" class="form-input" placeholder="e.g., 3">
                    </div>
                    <div class="form-group">
                        <label>Last Media Replacement</label>
                        <input type="date" id="modal-filter-media-date" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Performance Notes</label>
                    <textarea id="modal-filter-notes" class="form-textarea" rows="2" placeholder="Filter performance, issues, maintenance needs..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveIndividualFilter(${facilityIndex})" class="modal-btn modal-btn-primary">Save Filter</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveIndividualFilter(facilityIndex, filterIndex = null) {
            const filter = {
                name: document.getElementById('modal-filter-name').value,
                type: document.getElementById('modal-filter-type').value,
                capacity: document.getElementById('modal-filter-capacity').value,
                media: document.getElementById('modal-filter-media').value,
                turbidity: document.getElementById('modal-filter-turbidity').value,
                condition: document.getElementById('modal-filter-condition').value,
                backwashFrequency: document.getElementById('modal-filter-backwash').value,
                lastMediaReplacement: document.getElementById('modal-filter-media-date').value,
                notes: document.getElementById('modal-filter-notes').value
            };
            
            if (!currentSystemData.treatment.facilities[facilityIndex].filters) {
                currentSystemData.treatment.facilities[facilityIndex].filters = [];
            }
            
            if (filterIndex !== null) {
                currentSystemData.treatment.facilities[facilityIndex].filters[filterIndex] = filter;
            } else {
                currentSystemData.treatment.facilities[facilityIndex].filters.push(filter);
            }
            
            hideModal();
            renderTreatmentFacilities();
            saveData();
        }

        function editIndividualFilter(facilityIndex, filterIndex) {
            const filter = currentSystemData.treatment.facilities[facilityIndex].filters[filterIndex];
            showModal(`
                <h3>Edit Individual Filter/Process</h3>
                <p style="color: #666; margin-bottom: 15px;">Editing filter in: <strong>${currentSystemData.treatment.facilities[facilityIndex].name}</strong></p>
                <div class="form-group">
                    <label>Filter Name/ID *</label>
                    <input type="text" id="modal-filter-name" class="form-input" value="${filter.name || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-filter-type" class="form-select">
                            <option value="">Select...</option>
                            <option value="Rapid Sand" ${filter.type === 'Rapid Sand' ? 'selected' : ''}>Rapid Sand Filter</option>
                            <option value="Dual Media" ${filter.type === 'Dual Media' ? 'selected' : ''}>Dual Media Filter</option>
                            <option value="Pressure Filter" ${filter.type === 'Pressure Filter' ? 'selected' : ''}>Pressure Filter</option>
                            <option value="Membrane" ${filter.type === 'Membrane' ? 'selected' : ''}>Membrane (UF/MF)</option>
                            <option value="Slow Sand" ${filter.type === 'Slow Sand' ? 'selected' : ''}>Slow Sand Filter</option>
                            <option value="Cartridge" ${filter.type === 'Cartridge' ? 'selected' : ''}>Cartridge Filter</option>
                            <option value="Bag Filter" ${filter.type === 'Bag Filter' ? 'selected' : ''}>Bag Filter</option>
                            <option value="Other" ${filter.type === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Capacity (MGD)</label>
                        <input type="number" step="0.001" id="modal-filter-capacity" class="form-input" value="${filter.capacity || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Filter Media</label>
                    <input type="text" id="modal-filter-media" class="form-input" value="${filter.media || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Current Turbidity (NTU)</label>
                        <input type="number" step="0.01" id="modal-filter-turbidity" class="form-input" value="${filter.turbidity || ''}">
                    </div>
                    <div class="form-group">
                        <label>Condition</label>
                        <select id="modal-filter-condition" class="form-select">
                            <option value="">Select...</option>
                            <option value="Good" ${filter.condition === 'Good' ? 'selected' : ''}>Good</option>
                            <option value="Fair" ${filter.condition === 'Fair' ? 'selected' : ''}>Fair</option>
                            <option value="Poor" ${filter.condition === 'Poor' ? 'selected' : ''}>Poor</option>
                            <option value="Out of Service" ${filter.condition === 'Out of Service' ? 'selected' : ''}>Out of Service</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Backwash Frequency (days)</label>
                        <input type="number" id="modal-filter-backwash" class="form-input" value="${filter.backwashFrequency || ''}">
                    </div>
                    <div class="form-group">
                        <label>Last Media Replacement</label>
                        <input type="date" id="modal-filter-media-date" class="form-input" value="${filter.lastMediaReplacement || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Performance Notes</label>
                    <textarea id="modal-filter-notes" class="form-textarea" rows="2">${filter.notes || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveIndividualFilter(${facilityIndex}, ${filterIndex})" class="modal-btn modal-btn-primary">Save Changes</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteIndividualFilter(facilityIndex, filterIndex) {
            if (confirm('Delete this filter?')) {
                currentSystemData.treatment.facilities[facilityIndex].filters.splice(filterIndex, 1);
                renderTreatmentFacilities();
                saveData();
            }
        }

        // Chemicals
        function renderChemicals() {
            const container = document.getElementById('chemicals-list');
            if (!currentSystemData.treatment || !currentSystemData.treatment.chemicals || currentSystemData.treatment.chemicals.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No chemicals added yet</div>';
                return;
            }
            container.innerHTML = currentSystemData.treatment.chemicals.map((chem, i) => `
                <div class="list-item-card">
                    <div class="list-item-header">
                        <strong>${chem.name || 'Unnamed Chemical'}</strong>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editChemical(${i})">Edit</button>
                            <button class="btn-delete" onclick="deleteChemical(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>NSF 60 Cert:</strong> ${chem.nsfCert || 'N/A'}</div>
                        <div><strong>Dosage:</strong> ${chem.dosage || 'N/A'} | <strong>Storage:</strong> ${chem.storage || 'N/A'}</div>
                    </div>
                </div>
            `).join('');
        }

        function addChemical() {
            showModal(`
                <h3>Add Chemical</h3>
                <div class="form-group">
                    <label>Chemical Name *</label>
                    <input type="text" id="modal-chem-name" class="form-input" placeholder="e.g., Chlorine, Sodium Hydroxide">
                </div>
                <div class="form-group">
                    <label>NSF 60 Certification #</label>
                    <input type="text" id="modal-chem-nsf" class="form-input">
                </div>
                <div class="form-group">
                    <label>Dosage Rate</label>
                    <input type="text" id="modal-chem-dosage" class="form-input" placeholder="e.g., 2-4 mg/L">
                </div>
                <div class="form-group">
                    <label>Storage Volume</label>
                    <input type="text" id="modal-chem-storage" class="form-input" placeholder="e.g., 5000 gallons">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveChemical()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveChemical(index = null) {
            const chemical = {
                name: document.getElementById('modal-chem-name').value,
                nsfCert: document.getElementById('modal-chem-nsf').value,
                dosage: document.getElementById('modal-chem-dosage').value,
                storage: document.getElementById('modal-chem-storage').value
            };
            
            if (!currentSystemData.treatment) currentSystemData.treatment = {};
            if (!currentSystemData.treatment.chemicals) currentSystemData.treatment.chemicals = [];
            
            if (index !== null) {
                currentSystemData.treatment.chemicals[index] = chemical;
            } else {
                currentSystemData.treatment.chemicals.push(chemical);
            }
            
            hideModal();
            renderChemicals();
            saveData();
        }

        function editChemical(index) {
            const chem = currentSystemData.treatment.chemicals[index];
            showModal(`
                <h3>Edit Chemical</h3>
                <div class="form-group">
                    <label>Chemical Name *</label>
                    <input type="text" id="modal-chem-name" class="form-input" value="${chem.name || ''}">
                </div>
                <div class="form-group">
                    <label>NSF 60 Certification #</label>
                    <input type="text" id="modal-chem-nsf" class="form-input" value="${chem.nsfCert || ''}">
                </div>
                <div class="form-group">
                    <label>Dosage Rate</label>
                    <input type="text" id="modal-chem-dosage" class="form-input" value="${chem.dosage || ''}">
                </div>
                <div class="form-group">
                    <label>Storage Volume</label>
                    <input type="text" id="modal-chem-storage" class="form-input" value="${chem.storage || ''}">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveChemical(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteChemical(index) {
            if (confirm('Delete this chemical?')) {
                currentSystemData.treatment.chemicals.splice(index, 1);
                renderChemicals();
                saveData();
            }
        }

        // Storage
        function renderStorage() {
            const container = document.getElementById('storage-list');
            if (!currentSystemData.storage || !currentSystemData.storage.tanks || currentSystemData.storage.tanks.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No storage tanks added yet</div>';
                return;
            }
            container.innerHTML = currentSystemData.storage.tanks.map((tank, i) => `
                <div class="list-item-card">
                    <div class="list-item-header">
                        <strong>${tank.name || 'Unnamed Tank'}</strong>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editStorage(${i})">Edit</button>
                            <button class="btn-delete" onclick="deleteStorage(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>Type:</strong> ${tank.type || 'N/A'} | <strong>Material:</strong> ${tank.material || 'N/A'}</div>
                        <div><strong>Capacity:</strong> ${tank.capacity || 'N/A'} MG | <strong>Zone:</strong> ${tank.zone || 'N/A'}</div>
                        <div><strong>Year Built:</strong> ${tank.year || 'N/A'}</div>
                    </div>
                </div>
            `).join('');
        }

        function addStorage() {
            showModal(`
                <h3>Add Storage Tank</h3>
                <div class="form-group">
                    <label>Tank Name *</label>
                    <input type="text" id="modal-tank-name" class="form-input" placeholder="e.g., Reservoir #1">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-tank-type" class="form-select">
                            <option value="">Select...</option>
                            <option>Elevated</option>
                            <option>Ground</option>
                            <option>Standby</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Material</label>
                        <select id="modal-tank-material" class="form-select">
                            <option value="">Select...</option>
                            <option>Steel</option>
                            <option>Concrete</option>
                            <option>Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity (MG)</label>
                        <input type="number" step="0.1" id="modal-tank-capacity" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Pressure Zone</label>
                        <input type="text" id="modal-tank-zone" class="form-input">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Year Built</label>
                        <input type="number" id="modal-tank-year" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Last Inspection</label>
                        <input type="date" id="modal-tank-insp" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Last Cleaning</label>
                    <input type="date" id="modal-tank-clean" class="form-input">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-tank-notes" class="form-textarea" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveStorage()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveStorage(index = null) {
            const tank = {
                name: document.getElementById('modal-tank-name').value,
                type: document.getElementById('modal-tank-type').value,
                material: document.getElementById('modal-tank-material').value,
                capacity: document.getElementById('modal-tank-capacity').value,
                zone: document.getElementById('modal-tank-zone').value,
                year: document.getElementById('modal-tank-year').value,
                lastInspection: document.getElementById('modal-tank-insp').value,
                lastCleaning: document.getElementById('modal-tank-clean').value,
                notes: document.getElementById('modal-tank-notes').value
            };
            
            if (!currentSystemData.storage) currentSystemData.storage = { tanks: [] };
            if (!currentSystemData.storage.tanks) currentSystemData.storage.tanks = [];
            
            if (index !== null) {
                currentSystemData.storage.tanks[index] = tank;
            } else {
                currentSystemData.storage.tanks.push(tank);
            }
            
            hideModal();
            renderStorage();
            saveData();
        }

        function editStorage(index) {
            const tank = currentSystemData.storage.tanks[index];
            showModal(`
                <h3>Edit Storage Tank</h3>
                <div class="form-group">
                    <label>Tank Name *</label>
                    <input type="text" id="modal-tank-name" class="form-input" value="${tank.name || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-tank-type" class="form-select">
                            <option value="">Select...</option>
                            <option ${tank.type === 'Elevated' ? 'selected' : ''}>Elevated</option>
                            <option ${tank.type === 'Ground' ? 'selected' : ''}>Ground</option>
                            <option ${tank.type === 'Standby' ? 'selected' : ''}>Standby</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Material</label>
                        <select id="modal-tank-material" class="form-select">
                            <option value="">Select...</option>
                            <option ${tank.material === 'Steel' ? 'selected' : ''}>Steel</option>
                            <option ${tank.material === 'Concrete' ? 'selected' : ''}>Concrete</option>
                            <option ${tank.material === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity (MG)</label>
                        <input type="number" step="0.1" id="modal-tank-capacity" class="form-input" value="${tank.capacity || ''}">
                    </div>
                    <div class="form-group">
                        <label>Pressure Zone</label>
                        <input type="text" id="modal-tank-zone" class="form-input" value="${tank.zone || ''}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Year Built</label>
                        <input type="number" id="modal-tank-year" class="form-input" value="${tank.year || ''}">
                    </div>
                    <div class="form-group">
                        <label>Last Inspection</label>
                        <input type="date" id="modal-tank-insp" class="form-input" value="${tank.lastInspection || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Last Cleaning</label>
                    <input type="date" id="modal-tank-clean" class="form-input" value="${tank.lastCleaning || ''}">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-tank-notes" class="form-textarea" rows="2">${tank.notes || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveStorage(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteStorage(index) {
            if (confirm('Delete this storage tank?')) {
                currentSystemData.storage.tanks.splice(index, 1);
                renderStorage();
                saveData();
            }
        }

        // ========== PUMP STATIONS WITH NESTED INDIVIDUAL PUMPS ==========
        function renderPumps() {
            const container = document.getElementById('pumps-list');
            if (!currentSystemData.pumps || !currentSystemData.pumps.stations || currentSystemData.pumps.stations.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No pump stations added yet</div>';
                return;
            }
            container.innerHTML = currentSystemData.pumps.stations.map((station, i) => `
                <div class="list-item-card" style="border-left: 4px solid #fd7e14;">
                    <div class="list-item-header" style="background: #fff8f2;">
                        <strong style="color: #fd7e14;">üîß ${station.name || 'Unnamed Station'}</strong>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editPumpStation(${i})">Edit Station</button>
                            <button class="btn-delete" onclick="deletePumpStation(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>Location:</strong> ${station.location || 'N/A'}</div>
                        <div><strong>Service:</strong> ${station.serviceType || 'N/A'} | <strong>Zone:</strong> ${station.zone || 'N/A'}</div>
                        <div><strong>Backup Power:</strong> ${station.backupPower || 'N/A'}</div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>Individual Pumps (${(station.pumps || []).length})</strong>
                                <button class="btn-add" style="font-size: 0.85rem; padding: 4px 12px;" onclick="addIndividualPump(${i})">+ Add Pump</button>
                            </div>
                            ${(station.pumps || []).length === 0 ? 
                                '<div style="color: #8e8e93; text-align: center; padding: 10px;">No pumps added</div>' :
                                station.pumps.map((pump, j) => `
                                    <div style="border: 1px solid #e9ecef; padding: 8px; margin: 5px 0; border-radius: 4px; background: #fafafa;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <strong>${pump.name || `Pump #${j+1}`}</strong>
                                                ${pump.type ? ` | ${pump.type}` : ''}
                                                ${pump.hp ? ` | ${pump.hp} HP` : ''}
                                                ${pump.capacity ? ` | ${pump.capacity} GPM` : ''}
                                            </div>
                                            <div>
                                                <button class="btn-edit" style="font-size: 0.8rem; padding: 2px 8px;" onclick="editIndividualPump(${i}, ${j})">Edit</button>
                                                <button class="btn-delete" style="font-size: 0.8rem; padding: 2px 8px;" onclick="deleteIndividualPump(${i}, ${j})">Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addPumpStation() {
            showModal(`
                <h3>Add Pump Station</h3>
                <div class="form-group">
                    <label>Station Name *</label>
                    <input type="text" id="modal-station-name" class="form-input" placeholder="e.g., Wellhead PS, Zone 2 Booster">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="modal-station-location" class="form-input" placeholder="e.g., 123 Main St">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Service Type</label>
                        <select id="modal-station-service" class="form-select">
                            <option value="">Select...</option>
                            <option>Raw Water</option>
                            <option>Finished Water</option>
                            <option>Booster</option>
                            <option>High Service</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pressure Zone</label>
                        <input type="text" id="modal-station-zone" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Backup Power</label>
                    <select id="modal-station-backup" class="form-select">
                        <option value="">Select...</option>
                        <option>Generator</option>
                        <option>Portable Generator</option>
                        <option>None</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-station-notes" class="form-textarea" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="savePumpStation()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function savePumpStation(index = null) {
            const station = {
                name: document.getElementById('modal-station-name').value,
                location: document.getElementById('modal-station-location').value,
                serviceType: document.getElementById('modal-station-service').value,
                zone: document.getElementById('modal-station-zone').value,
                backupPower: document.getElementById('modal-station-backup').value,
                notes: document.getElementById('modal-station-notes').value,
                pumps: []
            };
            
            if (!currentSystemData.pumps) currentSystemData.pumps = { stations: [] };
            if (!currentSystemData.pumps.stations) currentSystemData.pumps.stations = [];
            
            if (index !== null) {
                station.pumps = currentSystemData.pumps.stations[index].pumps || [];
                currentSystemData.pumps.stations[index] = station;
            } else {
                currentSystemData.pumps.stations.push(station);
            }
            
            hideModal();
            renderPumps();
            saveData();
        }

        function editPumpStation(index) {
            const station = currentSystemData.pumps.stations[index];
            showModal(`
                <h3>Edit Pump Station</h3>
                <div class="form-group">
                    <label>Station Name *</label>
                    <input type="text" id="modal-station-name" class="form-input" value="${station.name || ''}">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="modal-station-location" class="form-input" value="${station.location || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Service Type</label>
                        <select id="modal-station-service" class="form-select">
                            <option value="">Select...</option>
                            <option ${station.serviceType === 'Raw Water' ? 'selected' : ''}>Raw Water</option>
                            <option ${station.serviceType === 'Finished Water' ? 'selected' : ''}>Finished Water</option>
                            <option ${station.serviceType === 'Booster' ? 'selected' : ''}>Booster</option>
                            <option ${station.serviceType === 'High Service' ? 'selected' : ''}>High Service</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pressure Zone</label>
                        <input type="text" id="modal-station-zone" class="form-input" value="${station.zone || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Backup Power</label>
                    <select id="modal-station-backup" class="form-select">
                        <option value="">Select...</option>
                        <option ${station.backupPower === 'Generator' ? 'selected' : ''}>Generator</option>
                        <option ${station.backupPower === 'Portable Generator' ? 'selected' : ''}>Portable Generator</option>
                        <option ${station.backupPower === 'None' ? 'selected' : ''}>None</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-station-notes" class="form-textarea" rows="2">${station.notes || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="savePumpStation(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deletePumpStation(index) {
            if (confirm('Delete this pump station and all its pumps?')) {
                currentSystemData.pumps.stations.splice(index, 1);
                renderPumps();
                saveData();
            }
        }

        // Individual Pumps (nested within stations)
        function addIndividualPump(stationIndex) {
            showModal(`
                <h3>Add Individual Pump</h3>
                <p style="color: #666; margin-bottom: 15px;">Adding pump to: <strong>${currentSystemData.pumpStations[stationIndex].name}</strong></p>
                <div class="form-group">
                    <label>Pump Name/ID *</label>
                    <input type="text" id="modal-pump-name" class="form-input" placeholder="e.g., Pump A, Pump #1">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-pump-type" class="form-select">
                            <option value="">Select...</option>
                            <option>Vertical Turbine</option>
                            <option>Submersible</option>
                            <option>Centrifugal</option>
                            <option>Booster</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Horsepower (HP)</label>
                        <input type="number" id="modal-pump-hp" class="form-input">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity (GPM)</label>
                        <input type="number" id="modal-pump-capacity" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="modal-pump-status" class="form-select">
                            <option>Active</option>
                            <option>Standby</option>
                            <option>Out of Service</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-pump-notes" class="form-textarea" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveIndividualPump(${stationIndex})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveIndividualPump(stationIndex, pumpIndex = null) {
            const pump = {
                name: document.getElementById('modal-pump-name').value,
                type: document.getElementById('modal-pump-type').value,
                hp: document.getElementById('modal-pump-hp').value,
                capacity: document.getElementById('modal-pump-capacity').value,
                status: document.getElementById('modal-pump-status').value,
                notes: document.getElementById('modal-pump-notes').value
            };
            
            if (!currentSystemData.pumps.stations[stationIndex].pumps) {
                currentSystemData.pumps.stations[stationIndex].pumps = [];
            }
            
            if (pumpIndex !== null) {
                currentSystemData.pumps.stations[stationIndex].pumps[pumpIndex] = pump;
            } else {
                currentSystemData.pumps.stations[stationIndex].pumps.push(pump);
            }
            
            hideModal();
            renderPumps();
            saveData();
        }

        function editIndividualPump(stationIndex, pumpIndex) {
            const pump = currentSystemData.pumps.stations[stationIndex].pumps[pumpIndex];
            showModal(`
                <h3>Edit Individual Pump</h3>
                <p style="color: #666; margin-bottom: 15px;">Editing pump in: <strong>${currentSystemData.pumps.stations[stationIndex].name}</strong></p>
                <div class="form-group">
                    <label>Pump Name/ID *</label>
                    <input type="text" id="modal-pump-name" class="form-input" value="${pump.name || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-pump-type" class="form-select">
                            <option value="">Select...</option>
                            <option ${pump.type === 'Vertical Turbine' ? 'selected' : ''}>Vertical Turbine</option>
                            <option ${pump.type === 'Submersible' ? 'selected' : ''}>Submersible</option>
                            <option ${pump.type === 'Centrifugal' ? 'selected' : ''}>Centrifugal</option>
                            <option ${pump.type === 'Booster' ? 'selected' : ''}>Booster</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Horsepower (HP)</label>
                        <input type="number" id="modal-pump-hp" class="form-input" value="${pump.hp || ''}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity (GPM)</label>
                        <input type="number" id="modal-pump-capacity" class="form-input" value="${pump.capacity || ''}">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="modal-pump-status" class="form-select">
                            <option ${pump.status === 'Active' ? 'selected' : ''}>Active</option>
                            <option ${pump.status === 'Standby' ? 'selected' : ''}>Standby</option>
                            <option ${pump.status === 'Out of Service' ? 'selected' : ''}>Out of Service</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-pump-notes" class="form-textarea" rows="2">${pump.notes || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveIndividualPump(${stationIndex}, ${pumpIndex})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteIndividualPump(stationIndex, pumpIndex) {
            if (confirm('Delete this pump?')) {
                currentSystemData.pumps.stations[stationIndex].pumps.splice(pumpIndex, 1);
                renderPumps();
                saveData();
            }
        }

        // Shift Operators
        function renderShiftOperators() {
            const container = document.getElementById('shift-operators-list');
            if (!currentSystemData.operators || !currentSystemData.operators.shift || currentSystemData.operators.shift.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No shift operators added yet</div>';
                return;
            }
            container.innerHTML = currentSystemData.operators.shift.map((op, i) => `
                <div class="list-item-card">
                    <div class="list-item-header">
                        <strong>${op.name || 'Unnamed Operator'}</strong>
                        <span class="badge badge-blue">${op.certLevel || 'N/A'}</span>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editShiftOperator(${i})">Edit</button>
                            <button class="btn-delete" onclick="deleteShiftOperator(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>Cert #:</strong> ${op.certNumber || 'N/A'} | <strong>Expires:</strong> ${op.expiration || 'N/A'}</div>
                    </div>
                </div>
            `).join('');
        }

        function addShiftOperator() {
            showModal(`
                <h3>Add Shift Operator</h3>
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="modal-op-name" class="form-input" placeholder="Full Name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cert Level</label>
                        <select id="modal-op-level" class="form-select">
                            <option value="">Select...</option>
                            <option>T1</option>
                            <option>T2</option>
                            <option>T3</option>
                            <option>T4</option>
                            <option>T5</option>
                            <option>D1</option>
                            <option>D2</option>
                            <option>D3</option>
                            <option>D4</option>
                            <option>D5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cert Number</label>
                        <input type="text" id="modal-op-cert" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Expiration Date</label>
                    <input type="date" id="modal-op-exp" class="form-input">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveShiftOperator()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveShiftOperator(index = null) {
            const operator = {
                name: document.getElementById('modal-op-name').value,
                certLevel: document.getElementById('modal-op-level').value,
                certNumber: document.getElementById('modal-op-cert').value,
                expiration: document.getElementById('modal-op-exp').value
            };
            
            if (!currentSystemData.operators) currentSystemData.operators = {};
            if (!currentSystemData.operators.shift) currentSystemData.operators.shift = [];
            
            if (index !== null) {
                currentSystemData.operators.shift[index] = operator;
            } else {
                currentSystemData.operators.shift.push(operator);
            }
            
            hideModal();
            renderShiftOperators();
            saveData();
        }

        function editShiftOperator(index) {
            const op = currentSystemData.operators.shift[index];
            showModal(`
                <h3>Edit Shift Operator</h3>
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="modal-op-name" class="form-input" value="${op.name || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cert Level</label>
                        <select id="modal-op-level" class="form-select">
                            <option value="">Select...</option>
                            <option ${op.certLevel === 'T1' ? 'selected' : ''}>T1</option>
                            <option ${op.certLevel === 'T2' ? 'selected' : ''}>T2</option>
                            <option ${op.certLevel === 'T3' ? 'selected' : ''}>T3</option>
                            <option ${op.certLevel === 'T4' ? 'selected' : ''}>T4</option>
                            <option ${op.certLevel === 'T5' ? 'selected' : ''}>T5</option>
                            <option ${op.certLevel === 'D1' ? 'selected' : ''}>D1</option>
                            <option ${op.certLevel === 'D2' ? 'selected' : ''}>D2</option>
                            <option ${op.certLevel === 'D3' ? 'selected' : ''}>D3</option>
                            <option ${op.certLevel === 'D4' ? 'selected' : ''}>D4</option>
                            <option ${op.certLevel === 'D5' ? 'selected' : ''}>D5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cert Number</label>
                        <input type="text" id="modal-op-cert" class="form-input" value="${op.certNumber || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Expiration Date</label>
                    <input type="date" id="modal-op-exp" class="form-input" value="${op.expiration || ''}">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveShiftOperator(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteShiftOperator(index) {
            if (confirm('Delete this shift operator?')) {
                currentSystemData.operators.shift.splice(index, 1);
                renderShiftOperators();
                saveData();
            }
        }

        // Deficiencies
        function renderDeficiencies() {
            const container = document.getElementById('deficiencies-list');
            if (!currentSystemData.deficiencies || currentSystemData.deficiencies.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No deficiencies added yet</div>';
                return;
            }
            
            const typeColors = { 'Significant': 'red', 'Minor': 'orange', 'Recommendation': 'blue' };
            const statusColors = { 'Open': 'red', 'In Progress': 'orange', 'Closed': 'green' };
            
            container.innerHTML = currentSystemData.deficiencies.map((def, i) => `
                <div class="list-item-card">
                    <div class="list-item-header">
                        <strong>Element ${def.element || '?'}</strong>
                        <span class="badge badge-${typeColors[def.type] || 'gray'}">${def.type || 'N/A'}</span>
                        <span class="badge badge-${statusColors[def.status] || 'gray'}">${def.status || 'Unknown'}</span>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editDeficiency(${i})">Edit</button>
                            <button class="btn-delete" onclick="deleteDeficiency(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>Description:</strong> ${def.description || 'N/A'}</div>
                        ${def.citation ? `<div><strong>Citation:</strong> ${def.citation}</div>` : ''}
                        ${def.dueDate ? `<div><strong>Due:</strong> ${def.dueDate}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function addDeficiency() {
            showModal(`
                <h3>Add Deficiency</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Element (1-8) *</label>
                        <select id="modal-def-element" class="form-select">
                            <option value="">Select...</option>
                            <option value="1">1 - Sources</option>
                            <option value="2">2 - Treatment</option>
                            <option value="3">3 - Distribution</option>
                            <option value="4">4 - Storage</option>
                            <option value="5">5 - Pumps</option>
                            <option value="6">6 - Monitoring</option>
                            <option value="7">7 - Management</option>
                            <option value="8">8 - Operators</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="modal-def-type" class="form-select">
                            <option value="">Select...</option>
                            <option>Significant</option>
                            <option>Minor</option>
                            <option>Recommendation</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="modal-def-desc" class="form-textarea" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Regulatory Citation</label>
                    <input type="text" id="modal-def-citation" class="form-input" placeholder="e.g., 22 CCR ¬ß64560">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Date Identified</label>
                        <input type="date" id="modal-def-date" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="modal-def-due" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Status *</label>
                    <select id="modal-def-status" class="form-select">
                        <option>Open</option>
                        <option>In Progress</option>
                        <option>Resolved</option>
                        <option>Closed</option>
                        <option>Ongoing</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Target Completion Date</label>
                        <input type="date" id="modal-def-target" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Actual Completion Date</label>
                        <input type="date" id="modal-def-completed" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Corrective Action Taken</label>
                    <textarea id="modal-def-action" class="form-textarea" rows="2" placeholder="What was done to address this deficiency?"></textarea>
                </div>
                <div class="form-group">
                    <label>Resolution Notes</label>
                    <textarea id="modal-def-resolution" class="form-textarea" rows="2" placeholder="Additional notes on resolution, verification, follow-up needed..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveDeficiency()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveDeficiency(index = null) {
            const deficiency = {
                element: document.getElementById('modal-def-element').value,
                type: document.getElementById('modal-def-type').value,
                description: document.getElementById('modal-def-desc').value,
                citation: document.getElementById('modal-def-citation').value,
                dateIdentified: document.getElementById('modal-def-date').value,
                dueDate: document.getElementById('modal-def-due').value,
                status: document.getElementById('modal-def-status').value,
                targetCompletion: document.getElementById('modal-def-target').value,
                actualCompletion: document.getElementById('modal-def-completed').value,
                correctiveAction: document.getElementById('modal-def-action').value,
                resolution: document.getElementById('modal-def-resolution').value
            };
            
            if (!currentSystemData.deficiencies) currentSystemData.deficiencies = [];
            
            if (index !== null) {
                currentSystemData.deficiencies[index] = deficiency;
            } else {
                currentSystemData.deficiencies.push(deficiency);
            }
            
            hideModal();
            renderDeficiencies();
            saveData();
        }

        function editDeficiency(index) {
            const def = currentSystemData.deficiencies[index];
            showModal(`
                <h3>Edit Deficiency</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Element (1-8) *</label>
                        <select id="modal-def-element" class="form-select">
                            <option value="">Select...</option>
                            <option value="1" ${def.element === '1' ? 'selected' : ''}>1 - Sources</option>
                            <option value="2" ${def.element === '2' ? 'selected' : ''}>2 - Treatment</option>
                            <option value="3" ${def.element === '3' ? 'selected' : ''}>3 - Distribution</option>
                            <option value="4" ${def.element === '4' ? 'selected' : ''}>4 - Storage</option>
                            <option value="5" ${def.element === '5' ? 'selected' : ''}>5 - Pumps</option>
                            <option value="6" ${def.element === '6' ? 'selected' : ''}>6 - Monitoring</option>
                            <option value="7" ${def.element === '7' ? 'selected' : ''}>7 - Management</option>
                            <option value="8" ${def.element === '8' ? 'selected' : ''}>8 - Operators</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="modal-def-type" class="form-select">
                            <option value="">Select...</option>
                            <option ${def.type === 'Significant' ? 'selected' : ''}>Significant</option>
                            <option ${def.type === 'Minor' ? 'selected' : ''}>Minor</option>
                            <option ${def.type === 'Recommendation' ? 'selected' : ''}>Recommendation</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="modal-def-desc" class="form-textarea" rows="3">${def.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Regulatory Citation</label>
                    <input type="text" id="modal-def-citation" class="form-input" value="${def.citation || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Date Identified</label>
                        <input type="date" id="modal-def-date" class="form-input" value="${def.dateIdentified || ''}">
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="modal-def-due" class="form-input" value="${def.dueDate || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Status *</label>
                    <select id="modal-def-status" class="form-select">
                        <option ${def.status === 'Open' ? 'selected' : ''}>Open</option>
                        <option ${def.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                        <option ${def.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                        <option ${def.status === 'Closed' ? 'selected' : ''}>Closed</option>
                        <option ${def.status === 'Ongoing' ? 'selected' : ''}>Ongoing</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Target Completion Date</label>
                        <input type="date" id="modal-def-target" class="form-input" value="${def.targetCompletion || ''}">
                    </div>
                    <div class="form-group">
                        <label>Actual Completion Date</label>
                        <input type="date" id="modal-def-completed" class="form-input" value="${def.actualCompletion || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Corrective Action Taken</label>
                    <textarea id="modal-def-action" class="form-textarea" rows="2">${def.correctiveAction || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Resolution Notes</label>
                    <textarea id="modal-def-resolution" class="form-textarea" rows="2">${def.resolution || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveDeficiency(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteDeficiency(index) {
            if (confirm('Delete this deficiency?')) {
                currentSystemData.deficiencies.splice(index, 1);
                renderDeficiencies();
                saveData();
            }
        }
        
        // ========== MODAL FUNCTIONS ==========
        
        function showModal(content) {
            const modal = document.getElementById('globalModal');
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = content;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function hideModal() {
            const modal = document.getElementById('globalModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('globalModal');
            if (event.target === modal) {
                hideModal();
            }
        }
        
        // ========== HELPER FUNCTION FOR CURRENT SYSTEM DATA ==========
        
        function getCurrentSystemData() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system) return null;
            
            if (!system.systemData) {
                system.systemData = {
                    overview: {},
                    permits: { amendments: [] },
                    sources: {
                        overallType: '',
                        cccProgram: '',
                        swpMeasures: '',
                        concerns: '',
                        list: []
                    },
                    treatment: {
                        classification: '',
                        capacity: '',
                        type: '',
                        processes: '',
                        opsPlanDate: '',
                        notes: '',
                        facilities: [],
                        chemicals: []
                    },
                    distribution: {},
                    storage: {
                        totalCapacity: '',
                        redundancyAdequate: '',
                        notes: '',
                        tanks: []
                    },
                    pumps: {
                        totalCapacity: '',
                        backupPowerStrategy: '',
                        notes: '',
                        stations: []
                    },
                    monitoring: {},
                    management: {},
                    operators: { chief: {}, shift: [] },
                    deficiencies: [],
                    inspectionHistory: {}
                };
            }
            
            // Migration: Convert old data structures to new ones
            if (system.systemData.sources && Array.isArray(system.systemData.sources)) {
                system.systemData.sources = {
                    overallType: '',
                    cccProgram: '',
                    swpMeasures: '',
                    concerns: '',
                    list: system.systemData.sources
                };
            }
            
            if (system.systemData.storage && Array.isArray(system.systemData.storage)) {
                system.systemData.storage = {
                    totalCapacity: '',
                    redundancyAdequate: '',
                    notes: '',
                    tanks: system.systemData.storage
                };
            }
            
            if (system.systemData.pumps && Array.isArray(system.systemData.pumps)) {
                system.systemData.pumps = {
                    totalCapacity: '',
                    backupPowerStrategy: '',
                    notes: '',
                    stations: system.systemData.pumps
                };
            }
            
            if (system.systemData.pumpStations) {
                if (!system.systemData.pumps || Array.isArray(system.systemData.pumps)) {
                    system.systemData.pumps = {
                        totalCapacity: '',
                        backupPowerStrategy: '',
                        notes: '',
                        stations: system.systemData.pumpStations
                    };
                }
                delete system.systemData.pumpStations;
            }
            
            // Ensure nested structures exist
            if (!system.systemData.sources.list) system.systemData.sources.list = [];
            if (!system.systemData.storage.tanks) system.systemData.storage.tanks = [];
            if (!system.systemData.pumps.stations) system.systemData.pumps.stations = [];
            if (!system.systemData.treatment.facilities) system.systemData.treatment.facilities = [];
            
            // Ensure each treatment facility has a filters array
            if (system.systemData.treatment.facilities) {
                system.systemData.treatment.facilities.forEach(facility => {
                    if (!facility.filters) facility.filters = [];
                });
            }
            
            return system.systemData;
        }
        
        // Create a proxy for easy access
        Object.defineProperty(window, 'currentSystemData', {
            get: function() {
                return getCurrentSystemData();
            }
        });
        
    </script>
    
    <!-- Global Modal -->
    <div id="globalModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="hideModal()">&times;</span>
            <div id="modalBody">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>
</body>
</html>
