<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DDW System Data Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f2f2f7;
            color: #000;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2a5298 0%, #1e3a6b 100%);
            color: white;
            padding: max(env(safe-area-inset-top), 20px) 20px 20px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .breadcrumb {
            margin-top: 8px;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            background: white;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 77px;
            z-index: 90;
        }

        .tab-btn {
            padding: 8px 14px;
            border-radius: 20px;
            background: #f2f2f7;
            border: none;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .tab-btn.active {
            background: #2a5298;
            color: white;
        }

        /* Content */
        .content {
            padding: 16px;
            padding-bottom: 80px;
        }

        .data-section {
            display: none;
        }

        .data-section.active {
            display: block;
        }

        /* Form Sections */
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #2a5298;
            padding-bottom: 12px;
            border-bottom: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #2a5298;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        /* Save Button */
        .save-btn {
            position: fixed;
            bottom: max(env(safe-area-inset-bottom), 20px);
            right: 20px;
            background: #28a745;
            color: white;
            padding: 16px 24px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
            cursor: pointer;
            z-index: 99;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .save-btn:active {
            transform: scale(0.95);
        }

        /* List Items */
        .list-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #2a5298;
        }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .list-item-title {
            font-weight: 600;
            color: #2a5298;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .add-item-btn {
            width: 100%;
            padding: 12px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        .add-item-btn:active {
            background: #1e3a6b;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8e8e93;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        /* Deficiency Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-open {
            background: #f8d7da;
            color: #721c24;
        }

        .status-progress {
            background: #fff3cd;
            color: #856404;
        }

        .status-closed {
            background: #d4edda;
            color: #155724;
        }

        .type-significant {
            background: #dc3545;
            color: white;
        }

        .type-minor {
            background: #ffc107;
            color: #000;
        }

        .type-recommendation {
            background: #17a2b8;
            color: white;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2a5298;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn-primary {
            background: #2a5298;
            color: white;
        }

        .modal-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .edit-btn {
            background: #ffc107;
            color: #000;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1 id="headerTitle">üìä System Data</h1>
            <button class="back-btn" onclick="goBack()">‚Üê Back</button>
        </div>
        <div class="breadcrumb" id="breadcrumb">Loading...</div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="dataTabs">
        <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
        <button class="tab-btn" onclick="switchTab('permits')">Permits</button>
        <button class="tab-btn" onclick="switchTab('sources')">Sources</button>
        <button class="tab-btn" onclick="switchTab('treatment')">Treatment</button>
        <button class="tab-btn" onclick="switchTab('distribution')">Distribution</button>
        <button class="tab-btn" onclick="switchTab('storage')">Storage</button>
        <button class="tab-btn" onclick="switchTab('pumps')">Pumps</button>
        <button class="tab-btn" onclick="switchTab('monitoring')">Monitoring</button>
        <button class="tab-btn" onclick="switchTab('management')">Management</button>
        <button class="tab-btn" onclick="switchTab('operators')">Operators</button>
        <button class="tab-btn" onclick="switchTab('deficiencies')">Deficiencies</button>
    </div>

    <!-- Content -->
    <div class="content">
        <!-- Overview Section -->
        <div class="data-section active" id="overview-section">
            <div class="form-section">
                <div class="section-title">System Overview</div>
                <div class="form-group">
                    <label class="form-label">PWS Number</label>
                    <input type="text" class="form-input" id="pws-number" placeholder="CA0000000">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">System Classification</label>
                        <select class="form-select" id="classification">
                            <option value="">Select...</option>
                            <option value="CWS">CWS - Community</option>
                            <option value="NTNC">NTNC - Non-Transient Non-Community</option>
                            <option value="TNC">TNC - Transient Non-Community</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Population Served</label>
                        <input type="number" class="form-input" id="population" placeholder="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Service Connections</label>
                        <input type="number" class="form-input" id="connections" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ownership Type</label>
                        <select class="form-select" id="ownership">
                            <option value="">Select...</option>
                            <option value="Public">Public</option>
                            <option value="Private">Private</option>
                            <option value="Mutual">Mutual</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Primary Contact Name</label>
                    <input type="text" class="form-input" id="contact-name" placeholder="Full Name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Contact Phone</label>
                        <input type="tel" class="form-input" id="contact-phone" placeholder="(555) 555-5555">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Email</label>
                        <input type="email" class="form-input" id="contact-email" placeholder="email@example.com">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Service Area Description</label>
                    <textarea class="form-textarea" id="service-area" placeholder="Describe the service area, location, topography, climate..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">System Address/Location</label>
                    <textarea class="form-textarea" id="location" placeholder="Street address, city, county..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Last Sanitary Survey</label>
                        <input type="date" class="form-input" id="last-survey">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next Survey Due</label>
                        <input type="date" class="form-input" id="next-survey">
                    </div>
                </div>
            </div>
        </div>

        <!-- Permits Section -->
        <div class="data-section" id="permits-section">
            <div class="form-section">
                <div class="section-title">Current Permit</div>
                <div class="form-group">
                    <label class="form-label">Permit Number</label>
                    <input type="text" class="form-input" id="permit-number" placeholder="02-XX-XXXX">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Issue Date</label>
                        <input type="date" class="form-input" id="permit-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Permit Status</label>
                        <select class="form-select" id="permit-status">
                            <option value="">Select...</option>
                            <option value="Active">Active</option>
                            <option value="Pending Amendment">Pending Amendment</option>
                            <option value="Expired">Expired</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Outstanding Permit Conditions</label>
                    <textarea class="form-textarea" id="permit-conditions" placeholder="List any outstanding conditions..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Amendments</div>
                <div id="amendments-list"></div>
                <button class="add-item-btn" onclick="addAmendment()">+ Add Amendment</button>
            </div>

            <div class="form-section">
                <div class="section-title">Compliance History (Past 3 Years)</div>
                <div class="form-group">
                    <label class="form-label">Violations</label>
                    <textarea class="form-textarea" id="violations" placeholder="List violations, dates, status, resolution..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">MCL Exceedances</label>
                    <textarea class="form-textarea" id="mcl-exceedances" placeholder="List MCL exceedances, contaminants, dates..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Compliance Notes</label>
                    <textarea class="form-textarea" id="compliance-notes" placeholder="Additional compliance information..."></textarea>
                </div>
            </div>
        </div>

        <!-- Sources Section -->
        <div class="data-section" id="sources-section">
            <div class="form-section">
                <div class="section-title">Water Sources</div>
                <div id="sources-list"></div>
                <button class="add-item-btn" onclick="addSource()">+ Add Source</button>
            </div>
        </div>

        <!-- Treatment Section -->
        <div class="data-section" id="treatment-section">
            <div class="form-section">
                <div class="section-title">Treatment Information</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Treatment Classification</label>
                        <select class="form-select" id="treatment-class">
                            <option value="">Select...</option>
                            <option value="T1">T1</option>
                            <option value="T2">T2</option>
                            <option value="T3">T3</option>
                            <option value="T4">T4</option>
                            <option value="T5">T5</option>
                            <option value="None">No Treatment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rated Capacity (MGD)</label>
                        <input type="number" step="0.01" class="form-input" id="treatment-capacity" placeholder="0.00">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Treatment Type</label>
                    <input type="text" class="form-input" id="treatment-type" placeholder="e.g., Conventional, Membrane, Blending">
                </div>
                <div class="form-group">
                    <label class="form-label">Treatment Processes</label>
                    <textarea class="form-textarea" id="treatment-processes" placeholder="List all treatment processes (coagulation, sedimentation, filtration, disinfection, etc.)"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Operations Plan Date</label>
                    <input type="date" class="form-input" id="ops-plan-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Treatment Challenges/Notes</label>
                    <textarea class="form-textarea" id="treatment-notes" placeholder="Water quality challenges, seasonal issues, performance notes..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Chemical Storage</div>
                <div id="chemicals-list"></div>
                <button class="add-item-btn" onclick="addChemical()">+ Add Chemical</button>
            </div>
        </div>

        <!-- Distribution Section -->
        <div class="data-section" id="distribution-section">
            <div class="form-section">
                <div class="section-title">Distribution System</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Distribution Classification</label>
                        <select class="form-select" id="dist-class">
                            <option value="">Select...</option>
                            <option value="D1">D1</option>
                            <option value="D2">D2</option>
                            <option value="D3">D3</option>
                            <option value="D4">D4</option>
                            <option value="D5">D5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Pipe Miles</label>
                        <input type="number" step="0.1" class="form-input" id="pipe-miles" placeholder="0.0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Pressure Zones</label>
                    <input type="text" class="form-input" id="pressure-zones" placeholder="e.g., Zone 1, Zone 2, High Zone">
                </div>
                <div class="form-group">
                    <label class="form-label">Pipe Materials & Ages</label>
                    <textarea class="form-textarea" id="pipe-materials" placeholder="AC: 60% (avg 50 yrs), DI: 20% (avg 30 yrs), PVC: 15% (avg 20 yrs), etc."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Valve Count</label>
                        <input type="number" class="form-input" id="valve-count" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hydrant Count</label>
                        <input type="number" class="form-input" id="hydrant-count" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Valve Exercise Program</label>
                    <textarea class="form-textarea" id="valve-program" placeholder="Frequency, % exercised annually, schedule..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Flushing Program</label>
                    <textarea class="form-textarea" id="flushing-program" placeholder="Frequency, dead-end flushing schedule..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Main Break History</label>
                    <input type="text" class="form-input" id="main-breaks" placeholder="Average breaks per year">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Cross-Connection Control</div>
                <div class="form-group">
                    <label class="form-label">Program Coordinator</label>
                    <input type="text" class="form-input" id="ccc-coordinator" placeholder="Name & Certification">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Last Survey Date</label>
                        <input type="date" class="form-input" id="ccc-survey-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Backflow Device Count</label>
                        <input type="number" class="form-input" id="backflow-count" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Test Compliance Rate</label>
                    <input type="text" class="form-input" id="test-compliance" placeholder="e.g., 98%">
                </div>
            </div>
        </div>

        <!-- Storage Section -->
        <div class="data-section" id="storage-section">
            <div class="form-section">
                <div class="section-title">Finished Water Storage Tanks</div>
                <div id="storage-list"></div>
                <button class="add-item-btn" onclick="addStorage()">+ Add Storage Tank</button>
            </div>
        </div>

        <!-- Pumps Section -->
        <div class="data-section" id="pumps-section">
            <div class="form-section">
                <div class="section-title">Pump Stations</div>
                <div id="pumps-list"></div>
                <button class="add-item-btn" onclick="addPump()">+ Add Pump Station</button>
            </div>
        </div>

        <!-- Monitoring Section -->
        <div class="data-section" id="monitoring-section">
            <div class="form-section">
                <div class="section-title">Primary Standards Monitoring</div>
                <div class="form-group">
                    <label class="form-label">IOC Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="ioc-schedule" placeholder="Triennial - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">Nitrate Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="nitrate-schedule" placeholder="Quarterly/Annual - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">VOC Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="voc-schedule" placeholder="Triennial - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">SOC Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="soc-schedule" placeholder="2Q/3yrs - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">Radionuclides Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="rad-schedule" placeholder="6-9 years - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">Active Waivers</label>
                    <textarea class="form-textarea" id="waivers" placeholder="List waivers and expiration dates..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Bacteriological (TCR/rTCR)</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Required Samples/Month</label>
                        <input type="number" class="form-input" id="tcr-samples" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">BSSP Approval Date</label>
                        <input type="date" class="form-input" id="bssp-date">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Last TCR Detection</label>
                    <input type="date" class="form-input" id="last-tcr">
                </div>
                <div class="form-group">
                    <label class="form-label">Level 1/2 Assessments</label>
                    <textarea class="form-textarea" id="assessments" placeholder="List any assessments and dates..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Disinfection Byproducts</div>
                <div class="form-group">
                    <label class="form-label">TTHM/HAA5 Monitoring Frequency</label>
                    <select class="form-select" id="dbp-freq">
                        <option value="">Select...</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="Reduced">Reduced</option>
                        <option value="N/A">N/A</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Sample Locations</label>
                    <input type="text" class="form-input" id="dbp-locations" placeholder="Number of locations">
                </div>
                <div class="form-group">
                    <label class="form-label">Recent LRAA Values</label>
                    <input type="text" class="form-input" id="lraa-values" placeholder="TTHM: XX ¬µg/L, HAA5: XX ¬µg/L">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Lead & Copper Rule</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">LCR Schedule</label>
                        <select class="form-select" id="lcr-schedule">
                            <option value="">Select...</option>
                            <option value="Annual">Annual</option>
                            <option value="Triennial">Triennial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Sample Date</label>
                        <input type="date" class="form-input" id="lcr-date">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">90th Percentile Values</label>
                    <input type="text" class="form-input" id="lcr-90th" placeholder="Lead: XX ¬µg/L, Copper: XX ¬µg/L">
                </div>
                <div class="form-group">
                    <label class="form-label">Service Line Inventory Status</label>
                    <textarea class="form-textarea" id="service-lines" placeholder="Completion status, lead lines identified, replacement plan..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">SWTR Compliance (if applicable)</div>
                <div class="form-group">
                    <label class="form-label">CT Compliance</label>
                    <textarea class="form-textarea" id="ct-compliance" placeholder="Contact time requirements, baffling factors..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Turbidity Compliance</label>
                    <input type="text" class="form-input" id="turbidity-compliance" placeholder="CFE turbidity range">
                </div>
                <div class="form-group">
                    <label class="form-label">Monthly Reporting Status</label>
                    <select class="form-select" id="swtr-reporting">
                        <option value="">Select...</option>
                        <option value="Current">Current</option>
                        <option value="Overdue">Overdue</option>
                        <option value="N/A">N/A</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Reporting Compliance</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">eAR Submission Status</label>
                        <select class="form-select" id="ear-status">
                            <option value="">Select...</option>
                            <option value="Current">Current</option>
                            <option value="Incomplete">Incomplete</option>
                            <option value="Overdue">Overdue</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CCR Distribution Date</label>
                        <input type="date" class="form-input" id="ccr-date">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Overdue Reports</label>
                    <textarea class="form-textarea" id="overdue-reports" placeholder="List any overdue reports..."></textarea>
                </div>
            </div>
        </div>

        <!-- Management Section -->
        <div class="data-section" id="management-section">
            <div class="form-section">
                <div class="section-title">Organization</div>
                <div class="form-group">
                    <label class="form-label">Ownership Structure</label>
                    <textarea class="form-textarea" id="ownership-structure" placeholder="Describe ownership and management structure..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Staffing Levels</label>
                    <textarea class="form-textarea" id="staffing" placeholder="Number of staff, roles, adequacy..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Emergency Contact Info</label>
                    <textarea class="form-textarea" id="emergency-contact" placeholder="24/7 contact information..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Planning Documents</div>
                <div class="form-group">
                    <label class="form-label">Capital Improvement Plan Date</label>
                    <input type="date" class="form-input" id="cip-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Urban Water Management Plan Date</label>
                    <input type="date" class="form-input" id="uwmp-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Water Shortage Contingency Plan Date</label>
                    <input type="date" class="form-input" id="wscp-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Emergency Response Plan Date</label>
                    <input type="date" class="form-input" id="erp-date">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Reliability & Redundancy</div>
                <div class="form-group">
                    <label class="form-label">SCADA System</label>
                    <textarea class="form-textarea" id="scada" placeholder="SCADA capabilities, monitoring, control..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Alarm Systems</label>
                    <textarea class="form-textarea" id="alarms" placeholder="Types of alarms, monitoring, response..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Backup Power</label>
                    <textarea class="form-textarea" id="backup-power" placeholder="Generator locations, capacity, fuel type..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Redundancy Notes</label>
                    <textarea class="form-textarea" id="redundancy" placeholder="Redundant equipment, spare parts inventory..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Security</div>
                <div class="form-group">
                    <label class="form-label">Physical Security Measures</label>
                    <textarea class="form-textarea" id="physical-security" placeholder="Fencing, locks, cameras, intrusion alarms..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">IT Security Program</label>
                    <textarea class="form-textarea" id="it-security" placeholder="Cybersecurity measures, training, protocols..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Risk & Resilience Assessment Date</label>
                    <input type="date" class="form-input" id="rra-date">
                    <small style="color: #6c757d;">Required for systems >3,300 population</small>
                </div>
                <div class="form-group">
                    <label class="form-label">EPRP Update Date</label>
                    <input type="date" class="form-input" id="eprp-date">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Climate Vulnerability</div>
                <div class="form-group">
                    <label class="form-label">eAR Climate Assessment Status</label>
                    <select class="form-select" id="climate-status">
                        <option value="">Select...</option>
                        <option value="Complete">Complete</option>
                        <option value="Incomplete">Incomplete</option>
                        <option value="Not Started">Not Started</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Identified Vulnerabilities</label>
                    <textarea class="form-textarea" id="vulnerabilities" placeholder="Drought, flooding, wildfire, landslide, extreme weather..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Mitigation Actions</label>
                    <textarea class="form-textarea" id="mitigation" placeholder="Actions taken or planned to address vulnerabilities..."></textarea>
                </div>
            </div>
        </div>

        <!-- Operators Section -->
        <div class="data-section" id="operators-section">
            <div class="form-section">
                <div class="section-title">Chief Treatment Operator</div>
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="chief-treatment-name" placeholder="Full Name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cert Level</label>
                        <select class="form-select" id="chief-treatment-level">
                            <option value="">Select...</option>
                            <option value="T1">T1</option>
                            <option value="T2">T2</option>
                            <option value="T3">T3</option>
                            <option value="T4">T4</option>
                            <option value="T5">T5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cert Number</label>
                        <input type="text" class="form-input" id="chief-treatment-cert" placeholder="XXXXX">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Cert Expiration</label>
                    <input type="date" class="form-input" id="chief-treatment-exp">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Chief Distribution Operator</div>
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="chief-dist-name" placeholder="Full Name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cert Level</label>
                        <select class="form-select" id="chief-dist-level">
                            <option value="">Select...</option>
                            <option value="D1">D1</option>
                            <option value="D2">D2</option>
                            <option value="D3">D3</option>
                            <option value="D4">D4</option>
                            <option value="D5">D5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cert Number</label>
                        <input type="text" class="form-input" id="chief-dist-cert" placeholder="XXXXX">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Cert Expiration</label>
                    <input type="date" class="form-input" id="chief-dist-exp">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Shift Operators</div>
                <div id="shift-operators-list"></div>
                <button class="add-item-btn" onclick="addShiftOperator()">+ Add Shift Operator</button>
            </div>

            <div class="form-section">
                <div class="section-title">Staffing</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Required Treatment Cert</label>
                        <input type="text" class="form-input" id="req-treatment-cert" placeholder="e.g., T3">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Required Distribution Cert</label>
                        <input type="text" class="form-input" id="req-dist-cert" placeholder="e.g., D3">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Staffing Adequacy Notes</label>
                    <textarea class="form-textarea" id="staffing-notes" placeholder="Number of operators, 24/7 coverage, succession planning..."></textarea>
                </div>
            </div>
        </div>

        <!-- Deficiencies Section -->
        <div class="data-section" id="deficiencies-section">
            <div class="form-section">
                <div class="section-title">Previous Deficiencies</div>
                <div id="deficiencies-list"></div>
                <button class="add-item-btn" onclick="addDeficiency()">+ Add Deficiency</button>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <button class="save-btn" onclick="saveAllData()">üíæ Save All</button>

    <!-- Modal Container -->
    <div class="modal" id="modal" onclick="closeModalOnBackdrop(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Modal</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script>
        // App State
        let appData = {
            systems: [],
            version: '4.0'
        };

        let currentSystemId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Get system ID from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            currentSystemId = urlParams.get('systemId');
            
            if (!currentSystemId) {
                alert('No system selected');
                window.location.href = 'ddw_field_inspector.html';
                return;
            }
            
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system) {
                alert('System not found');
                window.location.href = 'ddw_field_inspector.html';
                return;
            }
            
            // Initialize system data structure if not exists
            if (!system.systemData) {
                system.systemData = {
                    overview: {},
                    permits: { amendments: [] },
                    sources: [],
                    treatment: { chemicals: [] },
                    distribution: {},
                    storage: [],
                    pumps: [],
                    monitoring: {},
                    management: {},
                    operators: { shiftOperators: [] },
                    deficiencies: []
                };
            }
            
            updateHeader();
            loadAllData();
        });

        // Data persistence
        function loadData() {
            const savedData = localStorage.getItem('ddwFieldInspectorV4');
            if (savedData) {
                appData = JSON.parse(savedData);
            }
        }

        function saveData() {
            localStorage.setItem('ddwFieldInspectorV4', JSON.stringify(appData));
        }

        // Navigation
        function updateHeader() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (system) {
                document.getElementById('headerTitle').textContent = system.name;
                document.getElementById('breadcrumb').textContent = 'System Data Management';
            }
        }

        function goBack() {
            window.location.href = 'ddw_field_inspector.html';
        }

        // Tab switching
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update sections
            document.querySelectorAll('.data-section').forEach(section => section.classList.remove('active'));
            document.getElementById(tab + '-section').classList.add('active');
        }

        // Load all data into forms
        function loadAllData() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system || !system.systemData) return;
            
            const data = system.systemData;
            
            // Overview
            if (data.overview) {
                setValueIfExists('pws-number', data.overview.pwsNumber);
                setValueIfExists('classification', data.overview.classification);
                setValueIfExists('population', data.overview.population);
                setValueIfExists('connections', data.overview.connections);
                setValueIfExists('ownership', data.overview.ownership);
                setValueIfExists('contact-name', data.overview.contactName);
                setValueIfExists('contact-phone', data.overview.contactPhone);
                setValueIfExists('contact-email', data.overview.contactEmail);
                setValueIfExists('service-area', data.overview.serviceArea);
                setValueIfExists('location', data.overview.location);
                setValueIfExists('last-survey', data.overview.lastSurvey);
                setValueIfExists('next-survey', data.overview.nextSurvey);
            }
            
            // Permits
            if (data.permits) {
                setValueIfExists('permit-number', data.permits.permitNumber);
                setValueIfExists('permit-date', data.permits.permitDate);
                setValueIfExists('permit-status', data.permits.permitStatus);
                setValueIfExists('permit-conditions', data.permits.permitConditions);
                setValueIfExists('violations', data.permits.violations);
                setValueIfExists('mcl-exceedances', data.permits.mclExceedances);
                setValueIfExists('compliance-notes', data.permits.complianceNotes);
                renderAmendments();
            }
            
            // Sources
            renderSources();
            
            // Treatment
            if (data.treatment) {
                setValueIfExists('treatment-class', data.treatment.classification);
                setValueIfExists('treatment-capacity', data.treatment.capacity);
                setValueIfExists('treatment-type', data.treatment.type);
                setValueIfExists('treatment-processes', data.treatment.processes);
                setValueIfExists('ops-plan-date', data.treatment.opsPlanDate);
                setValueIfExists('treatment-notes', data.treatment.notes);
                renderChemicals();
            }
            
            // Distribution
            if (data.distribution) {
                setValueIfExists('dist-class', data.distribution.classification);
                setValueIfExists('pipe-miles', data.distribution.pipeMiles);
                setValueIfExists('pressure-zones', data.distribution.pressureZones);
                setValueIfExists('pipe-materials', data.distribution.pipeMaterials);
                setValueIfExists('valve-count', data.distribution.valveCount);
                setValueIfExists('hydrant-count', data.distribution.hydrantCount);
                setValueIfExists('valve-program', data.distribution.valveProgram);
                setValueIfExists('flushing-program', data.distribution.flushingProgram);
                setValueIfExists('main-breaks', data.distribution.mainBreaks);
                setValueIfExists('ccc-coordinator', data.distribution.cccCoordinator);
                setValueIfExists('ccc-survey-date', data.distribution.cccSurveyDate);
                setValueIfExists('backflow-count', data.distribution.backflowCount);
                setValueIfExists('test-compliance', data.distribution.testCompliance);
            }
            
            // Storage
            renderStorage();
            
            // Pumps
            renderPumps();
            
            // Monitoring
            if (data.monitoring) {
                setValueIfExists('ioc-schedule', data.monitoring.iocSchedule);
                setValueIfExists('nitrate-schedule', data.monitoring.nitrateSchedule);
                setValueIfExists('voc-schedule', data.monitoring.vocSchedule);
                setValueIfExists('soc-schedule', data.monitoring.socSchedule);
                setValueIfExists('rad-schedule', data.monitoring.radSchedule);
                setValueIfExists('waivers', data.monitoring.waivers);
                setValueIfExists('tcr-samples', data.monitoring.tcrSamples);
                setValueIfExists('bssp-date', data.monitoring.bsspDate);
                setValueIfExists('last-tcr', data.monitoring.lastTcr);
                setValueIfExists('assessments', data.monitoring.assessments);
                setValueIfExists('dbp-freq', data.monitoring.dbpFreq);
                setValueIfExists('dbp-locations', data.monitoring.dbpLocations);
                setValueIfExists('lraa-values', data.monitoring.lraaValues);
                setValueIfExists('lcr-schedule', data.monitoring.lcrSchedule);
                setValueIfExists('lcr-date', data.monitoring.lcrDate);
                setValueIfExists('lcr-90th', data.monitoring.lcr90th);
                setValueIfExists('service-lines', data.monitoring.serviceLines);
                setValueIfExists('ct-compliance', data.monitoring.ctCompliance);
                setValueIfExists('turbidity-compliance', data.monitoring.turbidityCompliance);
                setValueIfExists('swtr-reporting', data.monitoring.swtrReporting);
                setValueIfExists('ear-status', data.monitoring.earStatus);
                setValueIfExists('ccr-date', data.monitoring.ccrDate);
                setValueIfExists('overdue-reports', data.monitoring.overdueReports);
            }
            
            // Management
            if (data.management) {
                setValueIfExists('ownership-structure', data.management.ownershipStructure);
                setValueIfExists('staffing', data.management.staffing);
                setValueIfExists('emergency-contact', data.management.emergencyContact);
                setValueIfExists('cip-date', data.management.cipDate);
                setValueIfExists('uwmp-date', data.management.uwmpDate);
                setValueIfExists('wscp-date', data.management.wscpDate);
                setValueIfExists('erp-date', data.management.erpDate);
                setValueIfExists('scada', data.management.scada);
                setValueIfExists('alarms', data.management.alarms);
                setValueIfExists('backup-power', data.management.backupPower);
                setValueIfExists('redundancy', data.management.redundancy);
                setValueIfExists('physical-security', data.management.physicalSecurity);
                setValueIfExists('it-security', data.management.itSecurity);
                setValueIfExists('rra-date', data.management.rraDate);
                setValueIfExists('eprp-date', data.management.eprpDate);
                setValueIfExists('climate-status', data.management.climateStatus);
                setValueIfExists('vulnerabilities', data.management.vulnerabilities);
                setValueIfExists('mitigation', data.management.mitigation);
            }
            
            // Operators
            if (data.operators) {
                setValueIfExists('chief-treatment-name', data.operators.chiefTreatmentName);
                setValueIfExists('chief-treatment-level', data.operators.chiefTreatmentLevel);
                setValueIfExists('chief-treatment-cert', data.operators.chiefTreatmentCert);
                setValueIfExists('chief-treatment-exp', data.operators.chiefTreatmentExp);
                setValueIfExists('chief-dist-name', data.operators.chiefDistName);
                setValueIfExists('chief-dist-level', data.operators.chiefDistLevel);
                setValueIfExists('chief-dist-cert', data.operators.chiefDistCert);
                setValueIfExists('chief-dist-exp', data.operators.chiefDistExp);
                setValueIfExists('req-treatment-cert', data.operators.reqTreatmentCert);
                setValueIfExists('req-dist-cert', data.operators.reqDistCert);
                setValueIfExists('staffing-notes', data.operators.staffingNotes);
                renderShiftOperators();
            }
            
            // Deficiencies
            renderDeficiencies();
        }

        function setValueIfExists(id, value) {
            const element = document.getElementById(id);
            if (element && value !== undefined && value !== null) {
                element.value = value;
            }
        }

        // Save all data
        function saveAllData() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system) return;
            
            if (!system.systemData) {
                system.systemData = {};
            }
            
            // Overview
            system.systemData.overview = {
                pwsNumber: document.getElementById('pws-number').value,
                classification: document.getElementById('classification').value,
                population: document.getElementById('population').value,
                connections: document.getElementById('connections').value,
                ownership: document.getElementById('ownership').value,
                contactName: document.getElementById('contact-name').value,
                contactPhone: document.getElementById('contact-phone').value,
                contactEmail: document.getElementById('contact-email').value,
                serviceArea: document.getElementById('service-area').value,
                location: document.getElementById('location').value,
                lastSurvey: document.getElementById('last-survey').value,
                nextSurvey: document.getElementById('next-survey').value
            };
            
            // Permits
            if (!system.systemData.permits) system.systemData.permits = { amendments: [] };
            system.systemData.permits.permitNumber = document.getElementById('permit-number').value;
            system.systemData.permits.permitDate = document.getElementById('permit-date').value;
            system.systemData.permits.permitStatus = document.getElementById('permit-status').value;
            system.systemData.permits.permitConditions = document.getElementById('permit-conditions').value;
            system.systemData.permits.violations = document.getElementById('violations').value;
            system.systemData.permits.mclExceedances = document.getElementById('mcl-exceedances').value;
            system.systemData.permits.complianceNotes = document.getElementById('compliance-notes').value;
            
            // Treatment
            if (!system.systemData.treatment) system.systemData.treatment = { chemicals: [] };
            system.systemData.treatment.classification = document.getElementById('treatment-class').value;
            system.systemData.treatment.capacity = document.getElementById('treatment-capacity').value;
            system.systemData.treatment.type = document.getElementById('treatment-type').value;
            system.systemData.treatment.processes = document.getElementById('treatment-processes').value;
            system.systemData.treatment.opsPlanDate = document.getElementById('ops-plan-date').value;
            system.systemData.treatment.notes = document.getElementById('treatment-notes').value;
            
            // Distribution
            if (!system.systemData.distribution) system.systemData.distribution = {};
            system.systemData.distribution.classification = document.getElementById('dist-class').value;
            system.systemData.distribution.pipeMiles = document.getElementById('pipe-miles').value;
            system.systemData.distribution.pressureZones = document.getElementById('pressure-zones').value;
            system.systemData.distribution.pipeMaterials = document.getElementById('pipe-materials').value;
            system.systemData.distribution.valveCount = document.getElementById('valve-count').value;
            system.systemData.distribution.hydrantCount = document.getElementById('hydrant-count').value;
            system.systemData.distribution.valveProgram = document.getElementById('valve-program').value;
            system.systemData.distribution.flushingProgram = document.getElementById('flushing-program').value;
            system.systemData.distribution.mainBreaks = document.getElementById('main-breaks').value;
            system.systemData.distribution.cccCoordinator = document.getElementById('ccc-coordinator').value;
            system.systemData.distribution.cccSurveyDate = document.getElementById('ccc-survey-date').value;
            system.systemData.distribution.backflowCount = document.getElementById('backflow-count').value;
            system.systemData.distribution.testCompliance = document.getElementById('test-compliance').value;
            
            // Monitoring
            if (!system.systemData.monitoring) system.systemData.monitoring = {};
            system.systemData.monitoring.iocSchedule = document.getElementById('ioc-schedule').value;
            system.systemData.monitoring.nitrateSchedule = document.getElementById('nitrate-schedule').value;
            system.systemData.monitoring.vocSchedule = document.getElementById('voc-schedule').value;
            system.systemData.monitoring.socSchedule = document.getElementById('soc-schedule').value;
            system.systemData.monitoring.radSchedule = document.getElementById('rad-schedule').value;
            system.systemData.monitoring.waivers = document.getElementById('waivers').value;
            system.systemData.monitoring.tcrSamples = document.getElementById('tcr-samples').value;
            system.systemData.monitoring.bsspDate = document.getElementById('bssp-date').value;
            system.systemData.monitoring.lastTcr = document.getElementById('last-tcr').value;
            system.systemData.monitoring.assessments = document.getElementById('assessments').value;
            system.systemData.monitoring.dbpFreq = document.getElementById('dbp-freq').value;
            system.systemData.monitoring.dbpLocations = document.getElementById('dbp-locations').value;
            system.systemData.monitoring.lraaValues = document.getElementById('lraa-values').value;
            system.systemData.monitoring.lcrSchedule = document.getElementById('lcr-schedule').value;
            system.systemData.monitoring.lcrDate = document.getElementById('lcr-date').value;
            system.systemData.monitoring.lcr90th = document.getElementById('lcr-90th').value;
            system.systemData.monitoring.serviceLines = document.getElementById('service-lines').value;
            system.systemData.monitoring.ctCompliance = document.getElementById('ct-compliance').value;
            system.systemData.monitoring.turbidityCompliance = document.getElementById('turbidity-compliance').value;
            system.systemData.monitoring.swtrReporting = document.getElementById('swtr-reporting').value;
            system.systemData.monitoring.earStatus = document.getElementById('ear-status').value;
            system.systemData.monitoring.ccrDate = document.getElementById('ccr-date').value;
            system.systemData.monitoring.overdueReports = document.getElementById('overdue-reports').value;
            
            // Management
            if (!system.systemData.management) system.systemData.management = {};
            system.systemData.management.ownershipStructure = document.getElementById('ownership-structure').value;
            system.systemData.management.staffing = document.getElementById('staffing').value;
            system.systemData.management.emergencyContact = document.getElementById('emergency-contact').value;
            system.systemData.management.cipDate = document.getElementById('cip-date').value;
            system.systemData.management.uwmpDate = document.getElementById('uwmp-date').value;
            system.systemData.management.wscpDate = document.getElementById('wscp-date').value;
            system.systemData.management.erpDate = document.getElementById('erp-date').value;
            system.systemData.management.scada = document.getElementById('scada').value;
            system.systemData.management.alarms = document.getElementById('alarms').value;
            system.systemData.management.backupPower = document.getElementById('backup-power').value;
            system.systemData.management.redundancy = document.getElementById('redundancy').value;
            system.systemData.management.physicalSecurity = document.getElementById('physical-security').value;
            system.systemData.management.itSecurity = document.getElementById('it-security').value;
            system.systemData.management.rraDate = document.getElementById('rra-date').value;
            system.systemData.management.eprpDate = document.getElementById('eprp-date').value;
            system.systemData.management.climateStatus = document.getElementById('climate-status').value;
            system.systemData.management.vulnerabilities = document.getElementById('vulnerabilities').value;
            system.systemData.management.mitigation = document.getElementById('mitigation').value;
            
            // Operators
            if (!system.systemData.operators) system.systemData.operators = { shiftOperators: [] };
            system.systemData.operators.chiefTreatmentName = document.getElementById('chief-treatment-name').value;
            system.systemData.operators.chiefTreatmentLevel = document.getElementById('chief-treatment-level').value;
            system.systemData.operators.chiefTreatmentCert = document.getElementById('chief-treatment-cert').value;
            system.systemData.operators.chiefTreatmentExp = document.getElementById('chief-treatment-exp').value;
            system.systemData.operators.chiefDistName = document.getElementById('chief-dist-name').value;
            system.systemData.operators.chiefDistLevel = document.getElementById('chief-dist-level').value;
            system.systemData.operators.chiefDistCert = document.getElementById('chief-dist-cert').value;
            system.systemData.operators.chiefDistExp = document.getElementById('chief-dist-exp').value;
            system.systemData.operators.reqTreatmentCert = document.getElementById('req-treatment-cert').value;
            system.systemData.operators.reqDistCert = document.getElementById('req-dist-cert').value;
            system.systemData.operators.staffingNotes = document.getElementById('staffing-notes').value;
            
            saveData();
            
            // Visual feedback
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úì Saved!';
            btn.style.background = '#28a745';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        // Placeholder render functions (to be implemented)
        function renderAmendments() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const container = document.getElementById('amendments-list');
            if (!system.systemData.permits.amendments || system.systemData.permits.amendments.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div style="color: #8e8e93;">No amendments added yet</div></div>';
            } else {
                container.innerHTML = system.systemData.permits.amendments.map((amendment, idx) => `
                    <div class="list-item">
                        <div class="list-item-header">
                            <div class="list-item-title">Amendment ${amendment.number || idx + 1}</div>
                            <div>
                                <button class="edit-btn" onclick="editAmendment(${idx})">Edit</button>
                                <button class="delete-btn" onclick="deleteAmendment(${idx})">Delete</button>
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #6c757d; margin-top: 4px;">
                            <div><strong>Date:</strong> ${amendment.date || 'N/A'}</div>
                            <div><strong>Purpose:</strong> ${amendment.purpose || 'N/A'}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function renderSources() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const container = document.getElementById('sources-list');
            if (!system.systemData.sources || system.systemData.sources.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div style="color: #8e8e93;">No sources added yet</div></div>';
            } else {
                container.innerHTML = system.systemData.sources.map((source, idx) => `
                    <div class="list-item">
                        <div class="list-item-header">
                            <div class="list-item-title">${source.name || 'Unnamed Source'}</div>
                            <div>
                                <button class="edit-btn" onclick="editSource(${idx})">Edit</button>
                                <button class="delete-btn" onclick="deleteSource(${idx})">Delete</button>
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #6c757d; margin-top: 4px;">
                            <div><strong>Type:</strong> ${source.type || 'N/A'} | <strong>Status:</strong> ${source.status || 'N/A'}</div>
                            <div><strong>PS Code:</strong> ${source.psCode || 'N/A'} | <strong>Capacity:</strong> ${source.capacity || 'N/A'} MGD</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function renderChemicals() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const container = document.getElementById('chemicals-list');
            if (!system.systemData.treatment.chemicals || system.systemData.treatment.chemicals.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div style="color: #8e8e93;">No chemicals added yet</div></div>';
            } else {
                container.innerHTML = system.systemData.treatment.chemicals.map((chemical, idx) => `
                    <div class="list-item">
                        <div class="list-item-header">
                            <div class="list-item-title">${chemical.name || 'Unnamed Chemical'}</div>
                            <div>
                                <button class="edit-btn" onclick="editChemical(${idx})">Edit</button>
                                <button class="delete-btn" onclick="deleteChemical(${idx})">Delete</button>
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #6c757d; margin-top: 4px;">
                            <div><strong>NSF Cert:</strong> ${chemical.nsfCert || 'N/A'}</div>
                            <div><strong>Dosage:</strong> ${chemical.dosage || 'N/A'} | <strong>Storage:</strong> ${chemical.storage || 'N/A'}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function renderStorage() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const container = document.getElementById('storage-list');
            if (!system.systemData.storage || system.systemData.storage.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div style="color: #8e8e93;">No storage tanks added yet</div></div>';
            } else {
                container.innerHTML = system.systemData.storage.map((tank, idx) => `
                    <div class="list-item">
                        <div class="list-item-header">
                            <div class="list-item-title">${tank.name || 'Unnamed Tank'}</div>
                            <div>
                                <button class="edit-btn" onclick="editStorage(${idx})">Edit</button>
                                <button class="delete-btn" onclick="deleteStorage(${idx})">Delete</button>
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #6c757d; margin-top: 4px;">
                            <div><strong>Type:</strong> ${tank.type || 'N/A'} | <strong>Material:</strong> ${tank.material || 'N/A'}</div>
                            <div><strong>Capacity:</strong> ${tank.capacity || 'N/A'} MG | <strong>Zone:</strong> ${tank.zone || 'N/A'}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function renderPumps() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const container = document.getElementById('pumps-list');
            if (!system.systemData.pumps || system.systemData.pumps.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div style="color: #8e8e93;">No pump stations added yet</div></div>';
            } else {
                container.innerHTML = system.systemData.pumps.map((pump, idx) => `
                    <div class="list-item">
                        <div class="list-item-header">
                            <div class="list-item-title">${pump.name || 'Unnamed Station'}</div>
                            <div>
                                <button class="edit-btn" onclick="editPump(${idx})">Edit</button>
                                <button class="delete-btn" onclick="deletePump(${idx})">Delete</button>
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #6c757d; margin-top: 4px;">
                            <div><strong>Type:</strong> ${pump.type || 'N/A'} | <strong>Count:</strong> ${pump.count || 'N/A'}</div>
                            <div><strong>Capacity:</strong> ${pump.capacity || 'N/A'} GPM | <strong>HP:</strong> ${pump.hp || 'N/A'}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function renderShiftOperators() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const container = document.getElementById('shift-operators-list');
            if (!system.systemData.operators.shiftOperators || system.systemData.operators.shiftOperators.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div style="color: #8e8e93;">No shift operators added yet</div></div>';
            } else {
                container.innerHTML = system.systemData.operators.shiftOperators.map((op, idx) => `
                    <div class="list-item">
                        <div class="list-item-header">
                            <div class="list-item-title">${op.name || 'Unnamed Operator'}</div>
                            <div>
                                <button class="edit-btn" onclick="editShiftOperator(${idx})">Edit</button>
                                <button class="delete-btn" onclick="deleteShiftOperator(${idx})">Delete</button>
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #6c757d; margin-top: 4px;">
                            <div><strong>Cert:</strong> ${op.certLevel || 'N/A'} - ${op.certNumber || 'N/A'}</div>
                            <div><strong>Expires:</strong> ${op.certExp || 'N/A'}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function renderDeficiencies() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const container = document.getElementById('deficiencies-list');
            if (!system.systemData.deficiencies || system.systemData.deficiencies.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div style="color: #8e8e93;">No deficiencies recorded yet</div></div>';
            } else {
                container.innerHTML = system.systemData.deficiencies.map((def, idx) => `
                    <div class="list-item">
                        <div class="list-item-header">
                            <div class="list-item-title">Element ${def.element || 'N/A'}: ${def.description ? def.description.substring(0, 50) + '...' : 'No description'}</div>
                            <div>
                                <button class="edit-btn" onclick="editDeficiency(${idx})">Edit</button>
                                <button class="delete-btn" onclick="deleteDeficiency(${idx})">Delete</button>
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; margin-top: 8px;">
                            <span class="status-badge type-${def.type || 'recommendation'}">${def.type || 'N/A'}</span>
                            <span class="status-badge status-${def.status || 'open'}">${def.status || 'Open'}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: #6c757d; margin-top: 4px;">
                            <div><strong>Due:</strong> ${def.dueDate || 'N/A'} | <strong>Citation:</strong> ${def.citation || 'N/A'}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Modal functions
        function showModal(title, bodyHTML) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = bodyHTML;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function closeModalOnBackdrop(event) {
            if (event.target.id === 'modal') {
                closeModal();
            }
        }

        // Amendment functions
        let editingAmendmentIdx = null;

        function addAmendment() {
            editingAmendmentIdx = null;
            showAmendmentForm();
        }

        function editAmendment(idx) {
            editingAmendmentIdx = idx;
            showAmendmentForm();
        }

        function showAmendmentForm() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const amendment = editingAmendmentIdx !== null ? system.systemData.permits.amendments[editingAmendmentIdx] : {};
            
            const html = `
                <div class="form-group">
                    <label class="form-label">Amendment Number</label>
                    <input type="text" class="form-input" id="amendment-number" value="${amendment.number || ''}" placeholder="e.g., Amendment 1">
                </div>
                <div class="form-group">
                    <label class="form-label">Issue Date</label>
                    <input type="date" class="form-input" id="amendment-date" value="${amendment.date || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Purpose/Reason</label>
                    <textarea class="form-textarea" id="amendment-purpose" placeholder="Describe the purpose of this amendment...">${amendment.purpose || ''}</textarea>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-primary" onclick="saveAmendment()">Save</button>
                    <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            `;
            
            showModal(editingAmendmentIdx !== null ? 'Edit Amendment' : 'Add Amendment', html);
        }

        function saveAmendment() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            
            const amendment = {
                number: document.getElementById('amendment-number').value,
                date: document.getElementById('amendment-date').value,
                purpose: document.getElementById('amendment-purpose').value
            };
            
            if (editingAmendmentIdx !== null) {
                system.systemData.permits.amendments[editingAmendmentIdx] = amendment;
            } else {
                if (!system.systemData.permits.amendments) system.systemData.permits.amendments = [];
                system.systemData.permits.amendments.push(amendment);
            }
            
            saveData();
            closeModal();
            renderAmendments();
        }

        function deleteAmendment(idx) {
            if (!confirm('Delete this amendment?')) return;
            const system = appData.systems.find(s => s.id === currentSystemId);
            system.systemData.permits.amendments.splice(idx, 1);
            saveData();
            renderAmendments();
        }

        // Source functions
        let editingSourceIdx = null;

        function addSource() {
            editingSourceIdx = null;
            showSourceForm();
        }

        function editSource(idx) {
            editingSourceIdx = idx;
            showSourceForm();
        }

        function showSourceForm() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const source = editingSourceIdx !== null ? system.systemData.sources[editingSourceIdx] : {};
            
            const html = `
                <div class="form-group">
                    <label class="form-label">Source Name</label>
                    <input type="text" class="form-input" id="source-name" value="${source.name || ''}" placeholder="e.g., Well #1">
                </div>
                <div class="form-group">
                    <label class="form-label">PS Code</label>
                    <input type="text" class="form-input" id="source-ps-code" value="${source.psCode || ''}" placeholder="CA0000000_001_001">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Source Type</label>
                        <select class="form-select" id="source-type">
                            <option value="">Select...</option>
                            <option value="Groundwater" ${source.type === 'Groundwater' ? 'selected' : ''}>Groundwater</option>
                            <option value="Surface Water" ${source.type === 'Surface Water' ? 'selected' : ''}>Surface Water</option>
                            <option value="Purchased" ${source.type === 'Purchased' ? 'selected' : ''}>Purchased</option>
                            <option value="Emergency" ${source.type === 'Emergency' ? 'selected' : ''}>Emergency</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="source-status">
                            <option value="">Select...</option>
                            <option value="Active" ${source.status === 'Active' ? 'selected' : ''}>Active</option>
                            <option value="Standby" ${source.status === 'Standby' ? 'selected' : ''}>Standby</option>
                            <option value="Inactive" ${source.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Capacity (MGD)</label>
                        <input type="number" step="0.01" class="form-input" id="source-capacity" value="${source.capacity || ''}" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Construction Date</label>
                        <input type="date" class="form-input" id="source-construction" value="${source.constructionDate || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Well Details (if GW)</label>
                    <textarea class="form-textarea" id="source-well-details" placeholder="Casing depth, diameter, material, screen depth...">${source.wellDetails || ''}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">DWSAP Evaluation Date</label>
                    <input type="date" class="form-input" id="source-dwsap" value="${source.dwsapDate || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="source-notes" placeholder="Water quality issues, PCAs, vulnerabilities...">${source.notes || ''}</textarea>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-primary" onclick="saveSource()">Save</button>
                    <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            `;
            
            showModal(editingSourceIdx !== null ? 'Edit Source' : 'Add Source', html);
        }

        function saveSource() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            
            const source = {
                name: document.getElementById('source-name').value,
                psCode: document.getElementById('source-ps-code').value,
                type: document.getElementById('source-type').value,
                status: document.getElementById('source-status').value,
                capacity: document.getElementById('source-capacity').value,
                constructionDate: document.getElementById('source-construction').value,
                wellDetails: document.getElementById('source-well-details').value,
                dwsapDate: document.getElementById('source-dwsap').value,
                notes: document.getElementById('source-notes').value
            };
            
            if (editingSourceIdx !== null) {
                system.systemData.sources[editingSourceIdx] = source;
            } else {
                if (!system.systemData.sources) system.systemData.sources = [];
                system.systemData.sources.push(source);
            }
            
            saveData();
            closeModal();
            renderSources();
        }

        function deleteSource(idx) {
            if (!confirm('Delete this source?')) return;
            const system = appData.systems.find(s => s.id === currentSystemId);
            system.systemData.sources.splice(idx, 1);
            saveData();
            renderSources();
        }

        // Chemical functions
        let editingChemicalIdx = null;

        function addChemical() {
            editingChemicalIdx = null;
            showChemicalForm();
        }

        function editChemical(idx) {
            editingChemicalIdx = idx;
            showChemicalForm();
        }

        function showChemicalForm() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const chemical = editingChemicalIdx !== null ? system.systemData.treatment.chemicals[editingChemicalIdx] : {};
            
            const html = `
                <div class="form-group">
                    <label class="form-label">Chemical Name</label>
                    <input type="text" class="form-input" id="chemical-name" value="${chemical.name || ''}" placeholder="e.g., Sodium Hypochlorite">
                </div>
                <div class="form-group">
                    <label class="form-label">NSF 60 Certification #</label>
                    <input type="text" class="form-input" id="chemical-nsf" value="${chemical.nsfCert || ''}" placeholder="NSF cert number">
                </div>
                <div class="form-group">
                    <label class="form-label">Dosage Rate</label>
                    <input type="text" class="form-input" id="chemical-dosage" value="${chemical.dosage || ''}" placeholder="e.g., 2-5 mg/L">
                </div>
                <div class="form-group">
                    <label class="form-label">Storage Volume</label>
                    <input type="text" class="form-input" id="chemical-storage" value="${chemical.storage || ''}" placeholder="e.g., 500 gallons">
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-primary" onclick="saveChemical()">Save</button>
                    <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            `;
            
            showModal(editingChemicalIdx !== null ? 'Edit Chemical' : 'Add Chemical', html);
        }

        function saveChemical() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            
            const chemical = {
                name: document.getElementById('chemical-name').value,
                nsfCert: document.getElementById('chemical-nsf').value,
                dosage: document.getElementById('chemical-dosage').value,
                storage: document.getElementById('chemical-storage').value
            };
            
            if (editingChemicalIdx !== null) {
                system.systemData.treatment.chemicals[editingChemicalIdx] = chemical;
            } else {
                if (!system.systemData.treatment.chemicals) system.systemData.treatment.chemicals = [];
                system.systemData.treatment.chemicals.push(chemical);
            }
            
            saveData();
            closeModal();
            renderChemicals();
        }

        function deleteChemical(idx) {
            if (!confirm('Delete this chemical?')) return;
            const system = appData.systems.find(s => s.id === currentSystemId);
            system.systemData.treatment.chemicals.splice(idx, 1);
            saveData();
            renderChemicals();
        }

        // Storage functions
        let editingStorageIdx = null;

        function addStorage() {
            editingStorageIdx = null;
            showStorageForm();
        }

        function editStorage(idx) {
            editingStorageIdx = idx;
            showStorageForm();
        }

        function showStorageForm() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const tank = editingStorageIdx !== null ? system.systemData.storage[editingStorageIdx] : {};
            
            const html = `
                <div class="form-group">
                    <label class="form-label">Tank Name/ID</label>
                    <input type="text" class="form-input" id="tank-name" value="${tank.name || ''}" placeholder="e.g., Reservoir R-1">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="tank-type">
                            <option value="">Select...</option>
                            <option value="Elevated" ${tank.type === 'Elevated' ? 'selected' : ''}>Elevated</option>
                            <option value="Ground" ${tank.type === 'Ground' ? 'selected' : ''}>Ground</option>
                            <option value="Standby" ${tank.type === 'Standby' ? 'selected' : ''}>Standby</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Material</label>
                        <select class="form-select" id="tank-material">
                            <option value="">Select...</option>
                            <option value="Steel" ${tank.material === 'Steel' ? 'selected' : ''}>Steel</option>
                            <option value="Concrete" ${tank.material === 'Concrete' ? 'selected' : ''}>Concrete</option>
                            <option value="Other" ${tank.material === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Capacity (MG)</label>
                        <input type="number" step="0.1" class="form-input" id="tank-capacity" value="${tank.capacity || ''}" placeholder="0.0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Construction Year</label>
                        <input type="number" class="form-input" id="tank-year" value="${tank.year || ''}" placeholder="YYYY">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Pressure Zone Served</label>
                    <input type="text" class="form-input" id="tank-zone" value="${tank.zone || ''}" placeholder="e.g., Zone 1">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Last Inspection</label>
                        <input type="date" class="form-input" id="tank-inspection" value="${tank.lastInspection || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Cleaning</label>
                        <input type="date" class="form-input" id="tank-cleaning" value="${tank.lastCleaning || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Condition Notes</label>
                    <textarea class="form-textarea" id="tank-notes" placeholder="Overall condition, maintenance needs...">${tank.notes || ''}</textarea>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-primary" onclick="saveStorage()">Save</button>
                    <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            `;
            
            showModal(editingStorageIdx !== null ? 'Edit Storage Tank' : 'Add Storage Tank', html);
        }

        function saveStorage() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            
            const tank = {
                name: document.getElementById('tank-name').value,
                type: document.getElementById('tank-type').value,
                material: document.getElementById('tank-material').value,
                capacity: document.getElementById('tank-capacity').value,
                year: document.getElementById('tank-year').value,
                zone: document.getElementById('tank-zone').value,
                lastInspection: document.getElementById('tank-inspection').value,
                lastCleaning: document.getElementById('tank-cleaning').value,
                notes: document.getElementById('tank-notes').value
            };
            
            if (editingStorageIdx !== null) {
                system.systemData.storage[editingStorageIdx] = tank;
            } else {
                if (!system.systemData.storage) system.systemData.storage = [];
                system.systemData.storage.push(tank);
            }
            
            saveData();
            closeModal();
            renderStorage();
        }

        function deleteStorage(idx) {
            if (!confirm('Delete this storage tank?')) return;
            const system = appData.systems.find(s => s.id === currentSystemId);
            system.systemData.storage.splice(idx, 1);
            saveData();
            renderStorage();
        }

        // Pump functions
        let editingPumpIdx = null;

        function addPump() {
            editingPumpIdx = null;
            showPumpForm();
        }

        function editPump(idx) {
            editingPumpIdx = idx;
            showPumpForm();
        }

        function showPumpForm() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const pump = editingPumpIdx !== null ? system.systemData.pumps[editingPumpIdx] : {};
            
            const html = `
                <div class="form-group">
                    <label class="form-label">Station Name/Location</label>
                    <input type="text" class="form-input" id="pump-name" value="${pump.name || ''}" placeholder="e.g., Pump Station 1">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Pump Count</label>
                        <input type="number" class="form-input" id="pump-count" value="${pump.count || ''}" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pump Type</label>
                        <select class="form-select" id="pump-type">
                            <option value="">Select...</option>
                            <option value="Vertical Turbine" ${pump.type === 'Vertical Turbine' ? 'selected' : ''}>Vertical Turbine</option>
                            <option value="Submersible" ${pump.type === 'Submersible' ? 'selected' : ''}>Submersible</option>
                            <option value="Booster" ${pump.type === 'Booster' ? 'selected' : ''}>Booster</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Total Capacity (GPM)</label>
                        <input type="number" class="form-input" id="pump-capacity" value="${pump.capacity || ''}" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Horsepower</label>
                        <input type="number" class="form-input" id="pump-hp" value="${pump.hp || ''}" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Service Type</label>
                    <select class="form-select" id="pump-service">
                        <option value="">Select...</option>
                        <option value="Raw Water" ${pump.service === 'Raw Water' ? 'selected' : ''}>Raw Water</option>
                        <option value="Finished Water" ${pump.service === 'Finished Water' ? 'selected' : ''}>Finished Water</option>
                        <option value="Booster" ${pump.service === 'Booster' ? 'selected' : ''}>Booster</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Pressure Zone</label>
                    <input type="text" class="form-input" id="pump-zone" value="${pump.zone || ''}" placeholder="e.g., Zone 2">
                </div>
                <div class="form-group">
                    <label class="form-label">Backup Power</label>
                    <select class="form-select" id="pump-backup">
                        <option value="">Select...</option>
                        <option value="Yes - Generator" ${pump.backupPower === 'Yes - Generator' ? 'selected' : ''}>Yes - Generator</option>
                        <option value="Yes - Portable" ${pump.backupPower === 'Yes - Portable' ? 'selected' : ''}>Yes - Portable</option>
                        <option value="No" ${pump.backupPower === 'No' ? 'selected' : ''}>No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Condition Notes</label>
                    <textarea class="form-textarea" id="pump-notes" placeholder="Maintenance schedule, condition, issues...">${pump.notes || ''}</textarea>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-primary" onclick="savePump()">Save</button>
                    <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            `;
            
            showModal(editingPumpIdx !== null ? 'Edit Pump Station' : 'Add Pump Station', html);
        }

        function savePump() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            
            const pump = {
                name: document.getElementById('pump-name').value,
                count: document.getElementById('pump-count').value,
                type: document.getElementById('pump-type').value,
                capacity: document.getElementById('pump-capacity').value,
                hp: document.getElementById('pump-hp').value,
                service: document.getElementById('pump-service').value,
                zone: document.getElementById('pump-zone').value,
                backupPower: document.getElementById('pump-backup').value,
                notes: document.getElementById('pump-notes').value
            };
            
            if (editingPumpIdx !== null) {
                system.systemData.pumps[editingPumpIdx] = pump;
            } else {
                if (!system.systemData.pumps) system.systemData.pumps = [];
                system.systemData.pumps.push(pump);
            }
            
            saveData();
            closeModal();
            renderPumps();
        }

        function deletePump(idx) {
            if (!confirm('Delete this pump station?')) return;
            const system = appData.systems.find(s => s.id === currentSystemId);
            system.systemData.pumps.splice(idx, 1);
            saveData();
            renderPumps();
        }

        // Shift Operator functions
        let editingOperatorIdx = null;

        function addShiftOperator() {
            editingOperatorIdx = null;
            showOperatorForm();
        }

        function editShiftOperator(idx) {
            editingOperatorIdx = idx;
            showOperatorForm();
        }

        function showOperatorForm() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const op = editingOperatorIdx !== null ? system.systemData.operators.shiftOperators[editingOperatorIdx] : {};
            
            const html = `
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="op-name" value="${op.name || ''}" placeholder="Full Name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cert Level</label>
                        <select class="form-select" id="op-level">
                            <option value="">Select...</option>
                            <option value="T1" ${op.certLevel === 'T1' ? 'selected' : ''}>T1</option>
                            <option value="T2" ${op.certLevel === 'T2' ? 'selected' : ''}>T2</option>
                            <option value="T3" ${op.certLevel === 'T3' ? 'selected' : ''}>T3</option>
                            <option value="T4" ${op.certLevel === 'T4' ? 'selected' : ''}>T4</option>
                            <option value="T5" ${op.certLevel === 'T5' ? 'selected' : ''}>T5</option>
                            <option value="D1" ${op.certLevel === 'D1' ? 'selected' : ''}>D1</option>
                            <option value="D2" ${op.certLevel === 'D2' ? 'selected' : ''}>D2</option>
                            <option value="D3" ${op.certLevel === 'D3' ? 'selected' : ''}>D3</option>
                            <option value="D4" ${op.certLevel === 'D4' ? 'selected' : ''}>D4</option>
                            <option value="D5" ${op.certLevel === 'D5' ? 'selected' : ''}>D5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cert Number</label>
                        <input type="text" class="form-input" id="op-cert" value="${op.certNumber || ''}" placeholder="XXXXX">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Cert Expiration</label>
                    <input type="date" class="form-input" id="op-exp" value="${op.certExp || ''}">
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-primary" onclick="saveOperator()">Save</button>
                    <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            `;
            
            showModal(editingOperatorIdx !== null ? 'Edit Shift Operator' : 'Add Shift Operator', html);
        }

        function saveOperator() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            
            const op = {
                name: document.getElementById('op-name').value,
                certLevel: document.getElementById('op-level').value,
                certNumber: document.getElementById('op-cert').value,
                certExp: document.getElementById('op-exp').value
            };
            
            if (editingOperatorIdx !== null) {
                system.systemData.operators.shiftOperators[editingOperatorIdx] = op;
            } else {
                if (!system.systemData.operators.shiftOperators) system.systemData.operators.shiftOperators = [];
                system.systemData.operators.shiftOperators.push(op);
            }
            
            saveData();
            closeModal();
            renderShiftOperators();
        }

        function deleteShiftOperator(idx) {
            if (!confirm('Delete this operator?')) return;
            const system = appData.systems.find(s => s.id === currentSystemId);
            system.systemData.operators.shiftOperators.splice(idx, 1);
            saveData();
            renderShiftOperators();
        }

        // Deficiency functions
        let editingDeficiencyIdx = null;

        function addDeficiency() {
            editingDeficiencyIdx = null;
            showDeficiencyForm();
        }

        function editDeficiency(idx) {
            editingDeficiencyIdx = idx;
            showDeficiencyForm();
        }

        function showDeficiencyForm() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const def = editingDeficiencyIdx !== null ? system.systemData.deficiencies[editingDeficiencyIdx] : {};
            
            const html = `
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Element (1-8)</label>
                        <select class="form-select" id="def-element">
                            <option value="">Select...</option>
                            <option value="1 - Sources" ${def.element === '1 - Sources' ? 'selected' : ''}>1 - Sources</option>
                            <option value="2 - Treatment" ${def.element === '2 - Treatment' ? 'selected' : ''}>2 - Treatment</option>
                            <option value="3 - Distribution" ${def.element === '3 - Distribution' ? 'selected' : ''}>3 - Distribution</option>
                            <option value="4 - Storage" ${def.element === '4 - Storage' ? 'selected' : ''}>4 - Storage</option>
                            <option value="5 - Pumps" ${def.element === '5 - Pumps' ? 'selected' : ''}>5 - Pumps</option>
                            <option value="6 - Monitoring" ${def.element === '6 - Monitoring' ? 'selected' : ''}>6 - Monitoring</option>
                            <option value="7 - Management" ${def.element === '7 - Management' ? 'selected' : ''}>7 - Management</option>
                            <option value="8 - Operators" ${def.element === '8 - Operators' ? 'selected' : ''}>8 - Operators</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="def-type">
                            <option value="">Select...</option>
                            <option value="significant" ${def.type === 'significant' ? 'selected' : ''}>Significant</option>
                            <option value="minor" ${def.type === 'minor' ? 'selected' : ''}>Minor</option>
                            <option value="recommendation" ${def.type === 'recommendation' ? 'selected' : ''}>Recommendation</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="def-description" placeholder="Detailed description of the deficiency...">${def.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Regulatory Citation</label>
                    <input type="text" class="form-input" id="def-citation" value="${def.citation || ''}" placeholder="e.g., 22 CCR ¬ß64560(c)(1)">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date Identified</label>
                        <input type="date" class="form-input" id="def-date" value="${def.dateIdentified || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Correction Due Date</label>
                        <input type="date" class="form-input" id="def-due" value="${def.dueDate || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="def-status">
                        <option value="">Select...</option>
                        <option value="open" ${def.status === 'open' ? 'selected' : ''}>Open</option>
                        <option value="progress" ${def.status === 'progress' ? 'selected' : ''}>In Progress</option>
                        <option value="closed" ${def.status === 'closed' ? 'selected' : ''}>Closed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Resolution Notes</label>
                    <textarea class="form-textarea" id="def-resolution" placeholder="Actions taken, date resolved...">${def.resolution || ''}</textarea>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-primary" onclick="saveDeficiency()">Save</button>
                    <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            `;
            
            showModal(editingDeficiencyIdx !== null ? 'Edit Deficiency' : 'Add Deficiency', html);
        }

        function saveDeficiency() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            
            const def = {
                element: document.getElementById('def-element').value,
                type: document.getElementById('def-type').value,
                description: document.getElementById('def-description').value,
                citation: document.getElementById('def-citation').value,
                dateIdentified: document.getElementById('def-date').value,
                dueDate: document.getElementById('def-due').value,
                status: document.getElementById('def-status').value,
                resolution: document.getElementById('def-resolution').value
            };
            
            if (editingDeficiencyIdx !== null) {
                system.systemData.deficiencies[editingDeficiencyIdx] = def;
            } else {
                if (!system.systemData.deficiencies) system.systemData.deficiencies = [];
                system.systemData.deficiencies.push(def);
            }
            
            saveData();
            closeModal();
            renderDeficiencies();
        }

        function deleteDeficiency(idx) {
            if (!confirm('Delete this deficiency?')) return;
            const system = appData.systems.find(s => s.id === currentSystemId);
            system.systemData.deficiencies.splice(idx, 1);
            saveData();
            renderDeficiencies();
        }
    </script>
</body>
</html>
