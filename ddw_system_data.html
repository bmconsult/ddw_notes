<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DDW System Data Manager - AI Autofill</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f2f2f7;
            color: #000;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2a5298 0%, #1e3a6b 100%);
            color: white;
            padding: max(env(safe-area-inset-top), 20px) 20px 20px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .back-btn, .import-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .import-btn {
            background: rgba(40, 167, 69, 0.3);
            border-color: rgba(40, 167, 69, 0.5);
        }

        .import-btn:hover {
            background: rgba(40, 167, 69, 0.4);
        }

        .breadcrumb {
            margin-top: 8px;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Import Status Banner */
        .import-status {
            display: none;
            padding: 12px 20px;
            background: #28a745;
            color: white;
            text-align: center;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }

        .import-status.error {
            background: #dc3545;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        #jsonFileInput {
            display: none;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            background: white;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 77px;
            z-index: 90;
        }

        .tab-btn {
            padding: 8px 14px;
            border-radius: 20px;
            background: #f2f2f7;
            border: none;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .tab-btn.active {
            background: #2a5298;
            color: white;
        }

        .tab-btn.has-data::after {
            content: '‚óè';
            position: absolute;
            top: 4px;
            right: 8px;
            font-size: 0.6rem;
            color: #28a745;
        }

        .tab-btn.active.has-data::after {
            color: #90ee90;
        }

        /* Content */
        .content {
            padding: 16px;
            padding-bottom: 80px;
        }

        .data-section {
            display: none;
        }

        .data-section.active {
            display: block;
        }

        /* Form Sections */
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #2a5298;
            padding-bottom: 12px;
            border-bottom: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #2a5298;
        }

        .form-input.autofilled, .form-select.autofilled, .form-textarea.autofilled {
            background: #e8f5e9;
            border-color: #28a745;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        /* Save Button */
        .save-btn {
            position: fixed;
            bottom: max(env(safe-area-inset-bottom), 20px);
            right: 20px;
            background: #28a745;
            color: white;
            padding: 16px 24px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
            cursor: pointer;
            z-index: 99;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .save-btn:active {
            transform: scale(0.95);
        }

        /* List Items */
        .list-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #2a5298;
        }

        .list-item.autofilled {
            background: #e8f5e9;
            border-left-color: #28a745;
        }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .list-item-title {
            font-weight: 600;
            color: #2a5298;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .add-item-btn {
            width: 100%;
            padding: 12px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        .add-item-btn:active {
            background: #1e3a6b;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8e8e93;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        /* Deficiency Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-open {
            background: #f8d7da;
            color: #721c24;
        }

        .status-progress {
            background: #fff3cd;
            color: #856404;
        }

        .status-closed {
            background: #d4edda;
            color: #155724;
        }

        .type-significant {
            background: #dc3545;
            color: white;
        }

        .type-minor {
            background: #ffc107;
            color: #000;
        }

        .type-recommendation {
            background: #17a2b8;
            color: white;
        }
    
        /* List Item Cards */
        .list-item-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .list-item-header {
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .list-item-body {
            padding: 12px 16px;
        }
        
        .list-item-body > div {
            margin-bottom: 6px;
        }
        
        .list-item-body > div:last-child {
            margin-bottom: 0;
        }
        
        .list-item-actions {
            display: flex;
            gap: 6px;
            margin-left: auto;
        }
        
        .btn-edit, .btn-delete, .btn-add {
            padding: 4px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background: #ffc107;
            color: #000;
        }
        
        .btn-edit:hover {
            background: #ffb300;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .btn-add {
            background: #28a745;
            color: white;
        }
        
        .btn-add:hover {
            background: #218838;
        }
        
        /* Badges */
        .badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-green {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-red {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-orange {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-blue {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .badge-gray {
            background: #e9ecef;
            color: #6c757d;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }
        
        .modal-close:hover,
        .modal-close:focus {
            color: #000;
        }
        
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2a5298;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            background: #6c757d;
            color: white;
            transition: all 0.2s;
        }
        
        .modal-btn:hover {
            opacity: 0.9;
        }
        
        .modal-btn-primary {
            background: #2a5298;
        }
        
        .modal-btn-primary:hover {
            background: #1e3c72;
        }

        /* Import Preview Modal Styles */
        .preview-section {
            margin-bottom: 20px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .preview-section-title {
            font-weight: 600;
            color: #2a5298;
            margin-bottom: 8px;
        }

        .preview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .preview-stat {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .preview-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2a5298;
        }

        .preview-stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 4px;
        }

        .import-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            color: #856404;
        }

</style>
</head>
<body>
    <!-- Hidden file input -->
    <input type="file" id="jsonFileInput" accept=".json" />

    <!-- Import Status Banner -->
    <div id="importStatus" class="import-status"></div>

    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1 id="headerTitle">üìä System Data</h1>
            <div class="header-actions">
                <button class="import-btn" onclick="triggerFileUpload()">ü§ñ AI Import Data</button>
                <button class="back-btn" onclick="goBack()">‚Üê Back</button>
            </div>
        </div>
        <div class="breadcrumb" id="breadcrumb">Loading...</div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="dataTabs">
        <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
        <button class="tab-btn" onclick="switchTab('permits')">Permits</button>
        <button class="tab-btn" onclick="switchTab('sources')">Sources</button>
        <button class="tab-btn" onclick="switchTab('treatment')">Treatment</button>
        <button class="tab-btn" onclick="switchTab('distribution')">Distribution</button>
        <button class="tab-btn" onclick="switchTab('storage')">Storage</button>
        <button class="tab-btn" onclick="switchTab('pumps')">Pumps</button>
        <button class="tab-btn" onclick="switchTab('monitoring')">Monitoring</button>
        <button class="tab-btn" onclick="switchTab('management')">Management</button>
        <button class="tab-btn" onclick="switchTab('operators')">Operators</button>
        <button class="tab-btn" onclick="switchTab('deficiencies')">Deficiencies</button>
        <button class="tab-btn" onclick="switchTab('inspection')">Inspection History</button>
    </div>

    <!-- Content -->
    <div class="content">
        <!-- Overview Section -->
        <div class="data-section active" id="overview-section">
            <div class="form-section">
                <div class="section-title">System Overview</div>
                <div class="form-group">
                    <label class="form-label">PWS Number</label>
                    <input type="text" class="form-input" id="pws-number" placeholder="CA0000000">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">System Classification</label>
                        <select class="form-select" id="classification">
                            <option value="">Select...</option>
                            <option value="CWS">CWS - Community</option>
                            <option value="NTNC">NTNC - Non-Transient Non-Community</option>
                            <option value="TNC">TNC - Transient Non-Community</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Population Served</label>
                        <input type="number" class="form-input" id="population" placeholder="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Service Connections</label>
                        <input type="number" class="form-input" id="connections" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ownership Type</label>
                        <select class="form-select" id="ownership">
                            <option value="">Select...</option>
                            <option value="Public">Public</option>
                            <option value="Private">Private</option>
                            <option value="Mutual">Mutual</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Primary Contact Name</label>
                    <input type="text" class="form-input" id="contact-name" placeholder="Full Name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Contact Phone</label>
                        <input type="tel" class="form-input" id="contact-phone" placeholder="(555) 555-5555">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Email</label>
                        <input type="email" class="form-input" id="contact-email" placeholder="email@example.com">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Service Area Description</label>
                    <textarea class="form-textarea" id="service-area" placeholder="Describe the service area, location, topography, climate..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">System Address/Location</label>
                    <textarea class="form-textarea" id="location" placeholder="Street address, city, county..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Last Sanitary Survey</label>
                        <input type="date" class="form-input" id="last-survey">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next Survey Due</label>
                        <input type="date" class="form-input" id="next-survey">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-title">System History & Context</div>
                <div class="form-group">
                    <label class="form-label">System History Summary</label>
                    <textarea class="form-textarea" id="system-history" rows="4" placeholder="When was the system built? Major expansions or modifications? Significant events (contamination incidents, failures, emergencies)? How has the system evolved over time?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Known Vulnerabilities & Challenges</label>
                    <textarea class="form-textarea" id="known-vulnerabilities" rows="3" placeholder="Known problem areas, aging infrastructure concerns, capacity limitations, water quality challenges, geographical constraints, etc."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Service Area Characteristics</label>
                    <textarea class="form-textarea" id="service-area-characteristics" rows="3" placeholder="Community demographics, growth trends, seasonal population changes, development plans, economic factors affecting the system..."></textarea>
                </div>
            </div>
        </div>

        <!-- Permits Section -->
        <div class="data-section" id="permits-section">
            <div class="form-section">
                <div class="section-title">Current Permit</div>
                <div class="form-group">
                    <label class="form-label">Permit Number</label>
                    <input type="text" class="form-input" id="permit-number" placeholder="02-XX-XXXX">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Issue Date</label>
                        <input type="date" class="form-input" id="permit-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Permit Status</label>
                        <select class="form-select" id="permit-status">
                            <option value="">Select...</option>
                            <option value="Active">Active</option>
                            <option value="Pending Amendment">Pending Amendment</option>
                            <option value="Expired">Expired</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Outstanding Permit Conditions</label>
                    <textarea class="form-textarea" id="permit-conditions" placeholder="List any outstanding conditions..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Amendments</div>
                <div id="amendments-list"></div>
                <button class="add-item-btn" onclick="addAmendment()">+ Add Amendment</button>
            </div>

            <div class="form-section">
                <div class="section-title">Compliance History (Past 3 Years)</div>
                <div class="form-group">
                    <label class="form-label">Violations</label>
                    <textarea class="form-textarea" id="violations" placeholder="List violations, dates, status, resolution..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">MCL Exceedances</label>
                    <textarea class="form-textarea" id="mcl-exceedances" placeholder="List MCL exceedances, contaminants, dates..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Compliance Notes</label>
                    <textarea class="form-textarea" id="compliance-notes" placeholder="Additional compliance information..."></textarea>
                </div>
            </div>
        </div>

        <!-- Sources Section -->
        <div class="data-section" id="sources-section">
            <div class="form-section">
                <div class="section-title">Source Water Overview & Protection</div>
                <div class="form-group">
                    <label class="form-label">Overall Source Type</label>
                    <select class="form-select" id="overall-source-type">
                        <option value="">Select...</option>
                        <option value="Groundwater Only">Groundwater Only</option>
                        <option value="Surface Water Only">Surface Water Only</option>
                        <option value="GWI">Groundwater Under Influence (GWI)</option>
                        <option value="Mixed">Mixed Sources</option>
                        <option value="Purchased">100% Purchased Water</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Cross-Connection Control Program</label>
                    <textarea class="form-textarea" id="ccc-program" placeholder="Describe the CCC program: coordinator, survey date, policies, backflow device testing compliance..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Source Water Protection Measures</label>
                    <textarea class="form-textarea" id="swp-measures" placeholder="Wellhead protection programs, watershed management, source water assessments..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Watershed/Aquifer Concerns</label>
                    <textarea class="form-textarea" id="source-concerns" placeholder="Known contaminants, threats, monitoring trends..."></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-title">Individual Water Sources</div>
                <div id="sources-list"></div>
                <button class="add-item-btn" onclick="addSource()">+ Add Water Source</button>
            </div>
        </div>

        <!-- Treatment Section -->
        <div class="data-section" id="treatment-section">
            <div class="form-section">
                <div class="section-title">Overall Treatment Classification & Capacity</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Treatment Classification</label>
                        <select class="form-select" id="treatment-class">
                            <option value="">Select...</option>
                            <option value="T1">T1</option>
                            <option value="T2">T2</option>
                            <option value="T3">T3</option>
                            <option value="T4">T4</option>
                            <option value="T5">T5</option>
                            <option value="None">No Treatment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Rated Capacity (MGD)</label>
                        <input type="number" step="0.01" class="form-input" id="treatment-capacity" placeholder="0.00">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">General Treatment Type</label>
                    <input type="text" class="form-input" id="treatment-type" placeholder="e.g., Conventional, Membrane, Blending">
                </div>
                <div class="form-group">
                    <label class="form-label">Treatment Processes Overview</label>
                    <textarea class="form-textarea" id="treatment-processes" placeholder="List all treatment processes used across all facilities..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Operations Plan Date</label>
                    <input type="date" class="form-input" id="ops-plan-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Overall Treatment Challenges/Notes</label>
                    <textarea class="form-textarea" id="treatment-notes" placeholder="System-wide water quality challenges, seasonal issues, performance notes..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Treatment Performance Assessment</label>
                    <textarea class="form-textarea" id="treatment-performance" rows="3" placeholder="How is treatment performing? Compliance trends? Areas of excellence? Areas needing improvement? Process optimization efforts?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Recent Improvements & Upgrades</label>
                    <textarea class="form-textarea" id="treatment-improvements" rows="3" placeholder="Recent modifications, equipment installations, process changes, capital projects completed, performance enhancements..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Treatment Facilities</div>
                <div id="treatment-facilities-list"></div>
                <button class="add-item-btn" onclick="addTreatmentFacility()">+ Add Treatment Facility</button>
            </div>

            <div class="form-section">
                <div class="section-title">Chemical Storage (System-Wide)</div>
                <div id="chemicals-list"></div>
                <button class="add-item-btn" onclick="addChemical()">+ Add Chemical</button>
            </div>
        </div>

        <!-- Distribution Section -->
        <div class="data-section" id="distribution-section">
            <div class="form-section">
                <div class="section-title">Distribution System</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Distribution Classification</label>
                        <select class="form-select" id="dist-class">
                            <option value="">Select...</option>
                            <option value="D1">D1</option>
                            <option value="D2">D2</option>
                            <option value="D3">D3</option>
                            <option value="D4">D4</option>
                            <option value="D5">D5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Pipe Miles</label>
                        <input type="number" step="0.1" class="form-input" id="pipe-miles" placeholder="0.0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Pressure Zones</label>
                    <input type="text" class="form-input" id="pressure-zones" placeholder="e.g., Zone 1, Zone 2, High Zone">
                </div>
                <div class="form-group">
                    <label class="form-label">Pipe Materials & Ages</label>
                    <textarea class="form-textarea" id="pipe-materials" placeholder="AC: 60% (avg 50 yrs), DI: 20% (avg 30 yrs), PVC: 15% (avg 20 yrs), etc."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Valve Count</label>
                        <input type="number" class="form-input" id="valve-count" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hydrant Count</label>
                        <input type="number" class="form-input" id="hydrant-count" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Valve Exercise Program</label>
                    <textarea class="form-textarea" id="valve-program" placeholder="Frequency, % exercised annually, schedule..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Flushing Program</label>
                    <textarea class="form-textarea" id="flushing-program" placeholder="Frequency, dead-end flushing schedule..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Main Break History</label>
                    <input type="text" class="form-input" id="main-breaks" placeholder="Average breaks per year">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Cross-Connection Control</div>
                <div class="form-group">
                    <label class="form-label">Program Coordinator</label>
                    <input type="text" class="form-input" id="ccc-coordinator" placeholder="Name & Certification">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Last Survey Date</label>
                        <input type="date" class="form-input" id="ccc-survey-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Backflow Device Count</label>
                        <input type="number" class="form-input" id="backflow-count" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Test Compliance Rate</label>
                    <input type="text" class="form-input" id="test-compliance" placeholder="e.g., 98%">
                </div>
            </div>
        </div>

        <!-- Storage Section -->
        <div class="data-section" id="storage-section">
            <div class="form-section">
                <div class="section-title">Overall Storage Capacity & Adequacy</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Total Storage Capacity (MG)</label>
                        <input type="number" step="0.01" class="form-input" id="total-storage-capacity" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Redundancy Adequate?</label>
                        <select class="form-select" id="storage-redundancy">
                            <option value="">Select...</option>
                            <option value="Yes">Yes - Can meet demands with largest tank out of service</option>
                            <option value="No">No - Insufficient redundancy</option>
                            <option value="Marginal">Marginal - Depends on demand</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Overall Storage System Notes</label>
                    <textarea class="form-textarea" id="storage-notes" placeholder="System-wide storage adequacy, turnover concerns, water age issues..."></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-title">Individual Storage Tanks</div>
                <div id="storage-list"></div>
                <button class="add-item-btn" onclick="addStorage()">+ Add Storage Tank</button>
            </div>
        </div>

        <!-- Pumps Section -->
        <div class="data-section" id="pumps-section">
            <div class="form-section">
                <div class="section-title">Overall Pumping Capacity & Strategy</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Total System Pumping Capacity (GPM)</label>
                        <input type="number" class="form-input" id="total-pump-capacity" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Backup Power Strategy</label>
                        <select class="form-select" id="backup-power-strategy">
                            <option value="">Select...</option>
                            <option value="All Critical">All Critical Stations Have Backup</option>
                            <option value="Partial">Partial Backup Coverage</option>
                            <option value="None">No Backup Power</option>
                            <option value="Grid Tied">Grid Tied with Manual Transfer</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Pumping System Notes</label>
                    <textarea class="form-textarea" id="pumping-notes" placeholder="Overall system reliability, redundancy strategy, concerns..."></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-title">Pump Stations & Equipment</div>
                <div id="pumps-list"></div>
                <button class="add-item-btn" onclick="addPumpStation()">+ Add Pump Station</button>
            </div>
        </div>

        <!-- Monitoring Section -->
        <div class="data-section" id="monitoring-section">
            <div class="form-section">
                <div class="section-title">Primary Standards Monitoring</div>
                <div class="form-group">
                    <label class="form-label">IOC Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="ioc-schedule" placeholder="Triennial - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">Nitrate Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="nitrate-schedule" placeholder="Quarterly/Annual - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">VOC Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="voc-schedule" placeholder="Triennial - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">SOC Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="soc-schedule" placeholder="2Q/3yrs - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">Radionuclides Schedule & Last Sample</label>
                    <input type="text" class="form-input" id="rad-schedule" placeholder="6-9 years - Last: MM/YYYY">
                </div>
                <div class="form-group">
                    <label class="form-label">Active Waivers</label>
                    <textarea class="form-textarea" id="waivers" placeholder="List waivers and expiration dates..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Bacteriological (TCR/rTCR)</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Required Samples/Month</label>
                        <input type="number" class="form-input" id="tcr-samples" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">BSSP Approval Date</label>
                        <input type="date" class="form-input" id="bssp-date">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Last TCR Detection</label>
                    <input type="date" class="form-input" id="last-tcr">
                </div>
                <div class="form-group">
                    <label class="form-label">Level 1/2 Assessments</label>
                    <textarea class="form-textarea" id="assessments" placeholder="List any assessments and dates..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Disinfection Byproducts</div>
                <div class="form-group">
                    <label class="form-label">TTHM/HAA5 Monitoring Frequency</label>
                    <select class="form-select" id="dbp-freq">
                        <option value="">Select...</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="Reduced">Reduced</option>
                        <option value="N/A">N/A</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Sample Locations</label>
                    <input type="text" class="form-input" id="dbp-locations" placeholder="Number of locations">
                </div>
                <div class="form-group">
                    <label class="form-label">Recent LRAA Values</label>
                    <input type="text" class="form-input" id="lraa-values" placeholder="TTHM: XX ¬µg/L, HAA5: XX ¬µg/L">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Lead & Copper Rule</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">LCR Schedule</label>
                        <select class="form-select" id="lcr-schedule">
                            <option value="">Select...</option>
                            <option value="Annual">Annual</option>
                            <option value="Triennial">Triennial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Sample Date</label>
                        <input type="date" class="form-input" id="lcr-date">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">90th Percentile Values</label>
                    <input type="text" class="form-input" id="lcr-90th" placeholder="Lead: XX ¬µg/L, Copper: XX ¬µg/L">
                </div>
                <div class="form-group">
                    <label class="form-label">Service Line Inventory Status</label>
                    <textarea class="form-textarea" id="service-lines" placeholder="Completion status, lead lines identified, replacement plan..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">SWTR Compliance (if applicable)</div>
                <div class="form-group">
                    <label class="form-label">CT Compliance</label>
                    <textarea class="form-textarea" id="ct-compliance" placeholder="Contact time requirements, baffling factors..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Turbidity Compliance</label>
                    <input type="text" class="form-input" id="turbidity-compliance" placeholder="CFE turbidity range">
                </div>
                <div class="form-group">
                    <label class="form-label">Monthly Reporting Status</label>
                    <select class="form-select" id="swtr-reporting">
                        <option value="">Select...</option>
                        <option value="Current">Current</option>
                        <option value="Overdue">Overdue</option>
                        <option value="N/A">N/A</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Reporting Compliance</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">eAR Submission Status</label>
                        <select class="form-select" id="ear-status">
                            <option value="">Select...</option>
                            <option value="Current">Current</option>
                            <option value="Incomplete">Incomplete</option>
                            <option value="Overdue">Overdue</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CCR Distribution Date</label>
                        <input type="date" class="form-input" id="ccr-date">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Overdue Reports</label>
                    <textarea class="form-textarea" id="overdue-reports" placeholder="List any overdue reports..."></textarea>
                </div>
            </div>
        </div>

        <!-- Management Section -->
        <div class="data-section" id="management-section">
            <div class="form-section">
                <div class="section-title">Organization</div>
                <div class="form-group">
                    <label class="form-label">Ownership Structure</label>
                    <textarea class="form-textarea" id="ownership-structure" placeholder="Describe ownership and management structure..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Staffing Levels</label>
                    <textarea class="form-textarea" id="staffing" placeholder="Number of staff, roles, adequacy..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Emergency Contact Info</label>
                    <textarea class="form-textarea" id="emergency-contact" placeholder="24/7 contact information..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Planning Documents</div>
                <div class="form-group">
                    <label class="form-label">Capital Improvement Plan Date</label>
                    <input type="date" class="form-input" id="cip-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Urban Water Management Plan Date</label>
                    <input type="date" class="form-input" id="uwmp-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Water Shortage Contingency Plan Date</label>
                    <input type="date" class="form-input" id="wscp-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Emergency Response Plan Date</label>
                    <input type="date" class="form-input" id="erp-date">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Reliability & Redundancy</div>
                <div class="form-group">
                    <label class="form-label">SCADA System</label>
                    <textarea class="form-textarea" id="scada" placeholder="SCADA capabilities, monitoring, control..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Alarm Systems</label>
                    <textarea class="form-textarea" id="alarms" placeholder="Types of alarms, monitoring, response..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Backup Power</label>
                    <textarea class="form-textarea" id="backup-power" placeholder="Generator locations, capacity, fuel type..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Redundancy Notes</label>
                    <textarea class="form-textarea" id="redundancy" placeholder="Redundant equipment, spare parts inventory..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Security</div>
                <div class="form-group">
                    <label class="form-label">Physical Security Measures</label>
                    <textarea class="form-textarea" id="physical-security" placeholder="Fencing, locks, cameras, intrusion alarms..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">IT Security Program</label>
                    <textarea class="form-textarea" id="it-security" placeholder="Cybersecurity measures, training, protocols..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Risk & Resilience Assessment Date</label>
                    <input type="date" class="form-input" id="rra-date">
                    <small style="color: #6c757d;">Required for systems >3,300 population</small>
                </div>
                <div class="form-group">
                    <label class="form-label">EPRP Update Date</label>
                    <input type="date" class="form-input" id="eprp-date">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Climate Vulnerability</div>
                <div class="form-group">
                    <label class="form-label">eAR Climate Assessment Status</label>
                    <select class="form-select" id="climate-status">
                        <option value="">Select...</option>
                        <option value="Complete">Complete</option>
                        <option value="Incomplete">Incomplete</option>
                        <option value="Not Started">Not Started</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Identified Vulnerabilities</label>
                    <textarea class="form-textarea" id="vulnerabilities" placeholder="Drought, flooding, wildfire, landslide, extreme weather..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Mitigation Actions</label>
                    <textarea class="form-textarea" id="mitigation" placeholder="Actions taken or planned to address vulnerabilities..."></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-title">System Performance & Operational Context</div>
                <div class="form-group">
                    <label class="form-label">Overall System Performance Assessment</label>
                    <textarea class="form-textarea" id="performance-assessment" rows="4" placeholder="How is the system performing overall? Trends (improving/declining)? Areas of excellence? Areas of concern? Reliability issues? Water quality performance?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Operator Comments & Concerns</label>
                    <textarea class="form-textarea" id="operator-comments" rows="3" placeholder="Staff observations, recurring problems, resource limitations, training needs, operational challenges, maintenance concerns..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Recent System Changes & Improvements</label>
                    <textarea class="form-textarea" id="recent-improvements" rows="3" placeholder="Recent modifications, equipment installations, process changes, capital projects completed in the last 2-3 years..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Future Plans & Goals</label>
                    <textarea class="form-textarea" id="future-plans" rows="3" placeholder="System vision, planned initiatives, major challenges to address, long-term goals, anticipated capital improvements..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Outstanding Issues & Actions</label>
                    <textarea class="form-textarea" id="outstanding-issues" rows="3" placeholder="Prior deficiencies and current status, compliance orders, ongoing projects, items needing follow-up..."></textarea>
                </div>
            </div>
        </div>

        <!-- Operators Section -->
        <div class="data-section" id="operators-section">
            <div class="form-section">
                <div class="section-title">Chief Treatment Operator</div>
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="chief-treatment-name" placeholder="Full Name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cert Level</label>
                        <select class="form-select" id="chief-treatment-level">
                            <option value="">Select...</option>
                            <option value="T1">T1</option>
                            <option value="T2">T2</option>
                            <option value="T3">T3</option>
                            <option value="T4">T4</option>
                            <option value="T5">T5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cert Number</label>
                        <input type="text" class="form-input" id="chief-treatment-cert" placeholder="XXXXX">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Cert Expiration</label>
                    <input type="date" class="form-input" id="chief-treatment-exp">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Chief Distribution Operator</div>
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="chief-dist-name" placeholder="Full Name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cert Level</label>
                        <select class="form-select" id="chief-dist-level">
                            <option value="">Select...</option>
                            <option value="D1">D1</option>
                            <option value="D2">D2</option>
                            <option value="D3">D3</option>
                            <option value="D4">D4</option>
                            <option value="D5">D5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cert Number</label>
                        <input type="text" class="form-input" id="chief-dist-cert" placeholder="XXXXX">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Cert Expiration</label>
                    <input type="date" class="form-input" id="chief-dist-exp">
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Shift Operators</div>
                <div id="shift-operators-list"></div>
                <button class="add-item-btn" onclick="addShiftOperator()">+ Add Shift Operator</button>
            </div>

            <div class="form-section">
                <div class="section-title">Staffing</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Required Treatment Cert</label>
                        <input type="text" class="form-input" id="req-treatment-cert" placeholder="e.g., T3">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Required Distribution Cert</label>
                        <input type="text" class="form-input" id="req-dist-cert" placeholder="e.g., D3">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Staffing Adequacy Notes</label>
                    <textarea class="form-textarea" id="staffing-notes" placeholder="Number of operators, 24/7 coverage, succession planning..."></textarea>
                </div>
            </div>
        </div>

        <!-- Deficiencies Section -->
        <div class="data-section" id="deficiencies-section">
            <div class="form-section">
                <div class="section-title">Previous Deficiencies</div>
                <div id="deficiencies-list"></div>
                <button class="add-item-btn" onclick="addDeficiency()">+ Add Deficiency</button>
            </div>
        </div>

        <!-- Inspection History Section -->
        <div class="data-section" id="inspection-section">
            <div class="form-section">
                <div class="section-title">Prior Sanitary Survey</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Previous Survey Date</label>
                        <input type="date" class="form-input" id="prior-survey-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Inspector Name</label>
                        <input type="text" class="form-input" id="prior-inspector" placeholder="Name of inspector">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Key Findings from Prior Survey</label>
                    <textarea class="form-textarea" id="prior-findings" rows="4" placeholder="Significant findings, deficiencies identified, major recommendations from the previous sanitary survey..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Resolution of Prior Issues</label>
                    <textarea class="form-textarea" id="prior-resolutions" rows="3" placeholder="What was done to address previous findings? Status of prior deficiencies? Actions taken since last survey?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Continuing Issues</label>
                    <textarea class="form-textarea" id="continuing-issues" rows="3" placeholder="Any issues from prior surveys that remain unresolved or are recurring concerns?"></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Current Inspection Planning</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Current Inspection Date</label>
                        <input type="date" class="form-input" id="current-inspection-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Inspector(s)</label>
                        <input type="text" class="form-input" id="current-inspectors" placeholder="Name(s) of inspector(s)">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Pre-Inspection Notes</label>
                    <textarea class="form-textarea" id="pre-inspection-notes" rows="3" placeholder="Items to focus on, areas of concern to investigate, follow-up from prior survey, questions to ask..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Follow-Up Items</label>
                    <textarea class="form-textarea" id="follow-up-items" rows="3" placeholder="Items requiring follow-up after this inspection, scheduled re-inspections, outstanding information requests..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">Compliance History Context</div>
                <div class="form-group">
                    <label class="form-label">Historical Violations</label>
                    <textarea class="form-textarea" id="historical-violations" rows="3" placeholder="Summary of significant violations from past 5-10 years, patterns, trends, resolutions..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Enforcement Actions</label>
                    <textarea class="form-textarea" id="enforcement-actions" rows="3" placeholder="Prior enforcement actions (ACOs, CAOs, etc.), current compliance orders, enforcement history..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">System Responsiveness</label>
                    <textarea class="form-textarea" id="system-responsiveness" rows="3" placeholder="How responsive is the system to regulatory requirements? Track record of addressing issues? Quality of communication with DDW?"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <button class="save-btn" onclick="saveAllData()">üíæ Save All</button>

    <script>
        // App State
        let appData = {
            systems: [],
            version: '4.0'
        };

        let currentSystemId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Get system ID from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            currentSystemId = urlParams.get('systemId');
            
            if (!currentSystemId) {
                alert('No system selected');
                window.location.href = 'ddw_field_inspector.html';
                return;
            }
            
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system) {
                alert('System not found');
                window.location.href = 'ddw_field_inspector.html';
                return;
            }
            
            // Initialize system data structure if not exists
            if (!system.systemData) {
                system.systemData = {
                    overview: {},
                    permits: { amendments: [] },
                    sources: {
                        overallType: '',
                        cccProgram: '',
                        swpMeasures: '',
                        concerns: '',
                        list: [] // Individual sources
                    },
                    treatment: { 
                        classification: '',
                        capacity: '',
                        type: '',
                        processes: '',
                        opsPlanDate: '',
                        notes: '',
                        facilities: [], // Individual treatment facilities
                        chemicals: [] // System-wide chemicals
                    },
                    distribution: {},
                    storage: {
                        totalCapacity: '',
                        redundancyAdequate: '',
                        notes: '',
                        tanks: [] // Individual tanks
                    },
                    pumps: {
                        totalCapacity: '',
                        backupPowerStrategy: '',
                        notes: '',
                        stations: [] // Individual pump stations, each with pumps array
                    },
                    monitoring: {},
                    management: {},
                    operators: { chief: {}, shift: [] },
                    deficiencies: []
                };
            }
            
            updateHeader();
            loadAllData();
        });

        // Data persistence
        function loadData() {
            const savedData = localStorage.getItem('ddwFieldInspectorV4');
            if (savedData) {
                appData = JSON.parse(savedData);
            }
        }

        function saveData() {
            localStorage.setItem('ddwFieldInspectorV4', JSON.stringify(appData));
        }

        // Navigation
        function updateHeader() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (system) {
                document.getElementById('headerTitle').textContent = system.name;
                document.getElementById('breadcrumb').textContent = 'System Data Management';
            }
        }

        function goBack() {
            window.location.href = 'ddw_field_inspector.html';
        }

        // ========== FILE UPLOAD & AUTOFILL FUNCTIONS ==========
        
        // Setup file input handler
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('jsonFileInput').addEventListener('change', handleFileUpload);
            updateTabIndicators();
        });
        
        function triggerFileUpload() {
            document.getElementById('jsonFileInput').click();
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showImportStatus('Please select a JSON file', true);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    showImportPreview(importData);
                } catch (error) {
                    showImportStatus('Error reading JSON file: ' + error.message, true);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }
        
        function showImportPreview(importData) {
            const stats = {
                sections: 0,
                sources: importData.sources?.list?.length || 0,
                facilities: importData.treatment?.facilities?.length || 0,
                tanks: importData.storage?.tanks?.length || 0,
                stations: importData.pumps?.stations?.length || 0,
                deficiencies: importData.deficiencies?.length || 0,
                totalFields: 0,
                filledFields: 0
            };
            
            const sections = ['overview', 'permits', 'distribution', 'monitoring', 'management', 'operators', 'inspectionHistory'];
            sections.forEach(section => {
                if (importData[section]) {
                    stats.sections++;
                    Object.values(importData[section]).forEach(val => {
                        if (typeof val === 'string' || typeof val === 'number') {
                            stats.totalFields++;
                            if (val && val !== '') stats.filledFields++;
                        }
                    });
                }
            });
            
            const completeness = stats.totalFields > 0 ? Math.round((stats.filledFields / stats.totalFields) * 100) : 0;
            
            // Detect if this is a non-standard format (like SDWIS)
            const isNonStandard = completeness === 0 && (
                importData.meta || 
                importData.locations || 
                importData.samples ||
                (Object.keys(importData).length > 0 && !importData.overview)
            );
            
            let previewContent = '';
            
            if (isNonStandard) {
                // Non-standard format detected - show encouraging message
                previewContent = `
                    <h2 class="modal-title">ü§ñ AI Import Preview</h2>
                    
                    <div class="import-warning" style="background: #e7f3ff; border-color: #2a5298; color: #1e3a6b;">
                        <strong>üéØ Non-Standard Format Detected!</strong><br>
                        This appears to be raw data (like SDWIS, monitoring data, or custom format). 
                        <strong>The AI can still extract and map this data intelligently!</strong>
                    </div>
                    
                    <div class="preview-section">
                        <div class="preview-section-title">AI Will Analyze:</div>
                        <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                            <li>‚úÖ <strong>Water quality data</strong> ‚Üí Monitoring schedules and results</li>
                            <li>‚úÖ <strong>Sample locations</strong> ‚Üí Source names (wells, intakes)</li>
                            <li>‚úÖ <strong>Dates and values</strong> ‚Üí Last sampling dates, compliance data</li>
                            <li>‚úÖ <strong>Structured extraction</strong> ‚Üí Pulls relevant info from complex data</li>
                        </ul>
                    </div>
                    
                    <div class="preview-section" style="background: #fff3cd; border: 1px solid #ffc107; padding: 12px; border-radius: 8px;">
                        <strong>üí° Note:</strong> The AI is designed to understand semantic meaning, not just structure. 
                        Even if the preview shows 0%, the AI can extract relevant data from your file!
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 24px;">
                        <button onclick="executeImport(window.importDataTemp)" class="modal-btn modal-btn-primary" style="flex: 1;">
                            ü§ñ Let AI Extract Data
                        </button>
                        <button onclick="hideModal()" class="modal-btn">Cancel</button>
                    </div>
                `;
            } else {
                // Standard format
                previewContent = `
                    <h2 class="modal-title">üì• Import Preview</h2>
                    
                    <div class="import-warning">
                        ü§ñ <strong>AI-Powered Import:</strong> Claude will intelligently analyze your data and map it to the correct form fields, handling field name variations and extracting structured data. Empty fields only will be populated.
                    </div>
                    
                    <div class="preview-section">
                        <div class="preview-section-title">Data Quality</div>
                        <div class="preview-stats">
                            <div class="preview-stat">
                                <div class="preview-stat-value">${completeness}%</div>
                                <div class="preview-stat-label">Completeness</div>
                            </div>
                            <div class="preview-stat">
                                <div class="preview-stat-value">${stats.sections}/12</div>
                                <div class="preview-stat-label">Sections</div>
                            </div>
                            <div class="preview-stat">
                                <div class="preview-stat-value">${stats.filledFields}</div>
                                <div class="preview-stat-label">Fields to Fill</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="preview-section">
                        <div class="preview-section-title">Items to Import</div>
                        <div class="preview-stats">
                            ${stats.sources > 0 ? `<div class="preview-stat"><div class="preview-stat-value">${stats.sources}</div><div class="preview-stat-label">Sources</div></div>` : ''}
                            ${stats.facilities > 0 ? `<div class="preview-stat"><div class="preview-stat-value">${stats.facilities}</div><div class="preview-stat-label">Facilities</div></div>` : ''}
                            ${stats.tanks > 0 ? `<div class="preview-stat"><div class="preview-stat-value">${stats.tanks}</div><div class="preview-stat-label">Tanks</div></div>` : ''}
                            ${stats.stations > 0 ? `<div class="preview-stat"><div class="preview-stat-value">${stats.stations}</div><div class="preview-stat-label">Pump Stations</div></div>` : ''}
                            ${stats.deficiencies > 0 ? `<div class="preview-stat"><div class="preview-stat-value">${stats.deficiencies}</div><div class="preview-stat-label">Deficiencies</div></div>` : ''}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 24px;">
                        <button onclick="executeImport(window.importDataTemp)" class="modal-btn modal-btn-primary" style="flex: 1;">ü§ñ AI Import Data</button>
                        <button onclick="hideModal()" class="modal-btn">Cancel</button>
                    </div>
                `;
            }
            
            showModal(previewContent);
            
            window.importDataTemp = importData;
        }
        
        async function executeImport(importData) {
            hideModal();
            showImportStatus('ü§ñ Analyzing data with Claude AI...', false);
            
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system.systemData) {
                system.systemData = getCurrentSystemData();
            }
            
            // Extract form schema from actual HTML
            const formSchema = extractFormSchema();
            
            // Use Claude to intelligently map the data
            await intelligentDataMapping(importData, formSchema, system);
            
            delete window.importDataTemp;
        }
        
        function extractFormSchema() {
            const schema = {};
            
            // Define sections to extract
            const sections = ['overview', 'permits', 'sources', 'treatment', 'distribution', 
                            'storage', 'pumps', 'monitoring', 'management', 'operators', 'inspection'];
            
            sections.forEach(section => {
                const sectionEl = document.getElementById(section + '-section');
                if (!sectionEl) return;
                
                const fields = [];
                sectionEl.querySelectorAll('input, select, textarea').forEach(field => {
                    if (field.id) {
                        const label = field.closest('.form-group')?.querySelector('label')?.textContent || field.id;
                        fields.push({
                            id: field.id,
                            label: label.trim(),
                            type: field.tagName.toLowerCase() === 'select' ? 'select' : (field.type || 'text')
                        });
                    }
                });
                
                if (fields.length > 0) {
                    schema[section] = fields;
                }
            });
            
            return schema;
        }
        
        async function intelligentDataMapping(importData, formSchema, system) {
            try {
                const prompt = `You are a data mapping expert for water system inspection data. I need you to intelligently map imported JSON data to form fields.

IMPORTED DATA:
${JSON.stringify(importData, null, 2)}

TARGET FORM SCHEMA (by section):
${JSON.stringify(formSchema, null, 2)}

TASK:
Analyze the imported data and create mappings to form field IDs. For each piece of data:
1. Understand what the data represents (e.g., "pwsNumber" is a PWS system number, "locations" might contain water source names)
2. Find the best matching form field by comparing data field names/values to form field labels/IDs
3. Handle variations (e.g., "pipeMiles", "totalMiles", "total-miles" all map to pipe length field)
4. Extract values from nested objects when needed
5. Handle non-standard formats (SDWIS, monitoring data, etc.) - look for semantic meaning:
   - "Copper Sample Results" or "Lead Sample Results" ‚Üí LCR monitoring data
   - Location names with "WELL", "INTAKE", "SOURCE" ‚Üí water sources
   - Sample dates and analyte data ‚Üí monitoring schedules
   - Calculate values if needed (e.g., 90th percentile from sample arrays)
6. For arrays (sources.list, treatment.facilities, etc.), note them separately
7. Create source entries from location names if applicable

OUTPUT FORMAT (JSON only, no other text):
{
  "fieldMappings": {
    "section-name": {
      "form-field-id": {
        "value": "data value to map",
        "confidence": "high|medium|low",
        "dataPath": "path in import data (e.g., 'overview.pwsNumber')"
      }
    }
  },
  "arrayMappings": {
    "sources": ["importData.sources.list"],
    "facilities": ["importData.treatment.facilities"],
    "tanks": ["importData.storage.tanks"],
    "stations": ["importData.pumps.stations"],
    "deficiencies": ["importData.deficiencies"],
    "amendments": ["importData.permits.amendments"]
  },
  "summary": {
    "totalMappings": 0,
    "highConfidence": 0,
    "mediumConfidence": 0,
    "lowConfidence": 0
  }
}

Rules:
- Only map to empty form fields
- Match based on semantic meaning, not just exact field names
- High confidence: exact match or obvious mapping
- Medium confidence: reasonable inference needed
- Low confidence: best guess but uncertain
- Skip fields where no reasonable mapping exists
- For SDWIS/monitoring data: Extract well/source names from location names and create source entries
- For sample data: Use most recent dates for "last sampling" fields
- For LCR data: Calculate 90th percentile if multiple samples present
- Return ONLY valid JSON, no markdown, no explanations
- Low confidence: best guess but uncertain
- Skip fields where no reasonable mapping exists
- Return ONLY valid JSON, no markdown, no explanations`;

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 4000,
                        messages: [{
                            role: "user",
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Claude API error: ${response.status}`);
                }

                const data = await response.json();
                let responseText = data.content[0].text;
                
                // Clean markdown if present
                responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                
                const mappings = JSON.parse(responseText);
                
                // Apply the mappings
                applyIntelligentMappings(mappings, importData, system);
                
            } catch (error) {
                console.error('LLM mapping error:', error);
                showImportStatus('‚ùå Error: ' + error.message, true);
                
                // Fallback to basic mapping
                showImportStatus('‚ö†Ô∏è Falling back to basic mapping...', false);
                executeBasicImport(importData, system);
            }
        }
        
        function applyIntelligentMappings(mappings, importData, system) {
            let fieldsUpdated = 0;
            let itemsAdded = 0;
            
            // Apply field mappings
            if (mappings.fieldMappings) {
                Object.keys(mappings.fieldMappings).forEach(section => {
                    if (!system.systemData[section]) {
                        system.systemData[section] = {};
                    }
                    
                    Object.keys(mappings.fieldMappings[section]).forEach(fieldId => {
                        const mapping = mappings.fieldMappings[section][fieldId];
                        const field = document.getElementById(fieldId);
                        
                        if (field && mapping.value && (!field.value || field.value === '')) {
                            field.value = mapping.value;
                            field.classList.add('autofilled');
                            
                            // Also save to systemData using the data path
                            const pathParts = mapping.dataPath.split('.');
                            const dataKey = pathParts[pathParts.length - 1];
                            system.systemData[section][dataKey] = mapping.value;
                            
                            fieldsUpdated++;
                        }
                    });
                });
            }
            
            // Apply array mappings
            if (mappings.arrayMappings) {
                // Sources
                if (mappings.arrayMappings.sources && importData.sources?.list) {
                    if (!system.systemData.sources) system.systemData.sources = { list: [] };
                    importData.sources.list.forEach(source => {
                        source.imported = true;
                        system.systemData.sources.list.push(source);
                        itemsAdded++;
                    });
                }
                
                // Treatment facilities
                if (mappings.arrayMappings.facilities && importData.treatment?.facilities) {
                    if (!system.systemData.treatment.facilities) system.systemData.treatment.facilities = [];
                    importData.treatment.facilities.forEach(facility => {
                        facility.imported = true;
                        system.systemData.treatment.facilities.push(facility);
                        itemsAdded++;
                    });
                }
                
                // Storage tanks
                if (mappings.arrayMappings.tanks && importData.storage?.tanks) {
                    if (!system.systemData.storage.tanks) system.systemData.storage.tanks = [];
                    importData.storage.tanks.forEach(tank => {
                        tank.imported = true;
                        system.systemData.storage.tanks.push(tank);
                        itemsAdded++;
                    });
                }
                
                // Pump stations
                if (mappings.arrayMappings.stations && importData.pumps?.stations) {
                    if (!system.systemData.pumps.stations) system.systemData.pumps.stations = [];
                    importData.pumps.stations.forEach(station => {
                        station.imported = true;
                        system.systemData.pumps.stations.push(station);
                        itemsAdded++;
                    });
                }
                
                // Deficiencies
                if (mappings.arrayMappings.deficiencies && importData.deficiencies) {
                    if (!system.systemData.deficiencies) system.systemData.deficiencies = [];
                    importData.deficiencies.forEach(def => {
                        def.imported = true;
                        system.systemData.deficiencies.push(def);
                        itemsAdded++;
                    });
                }
                
                // Amendments
                if (mappings.arrayMappings.amendments && importData.permits?.amendments) {
                    if (!system.systemData.permits.amendments) system.systemData.permits.amendments = [];
                    importData.permits.amendments.forEach(amend => {
                        amend.imported = true;
                        system.systemData.permits.amendments.push(amend);
                        itemsAdded++;
                    });
                }
            }
            
            // Save and update
            saveData();
            loadAllData();
            updateTabIndicators();
            
            const summary = mappings.summary || {};
            showImportStatus(
                `‚úÖ AI Import Complete! ${fieldsUpdated} fields populated, ${itemsAdded} items added. ` +
                `(${summary.highConfidence || 0} high confidence, ${summary.mediumConfidence || 0} medium, ${summary.lowConfidence || 0} low)`,
                false
            );
        }
        
        // ========== DATA CLEANING UTILITIES ==========
        
        function cleanValue(value, fieldType = 'text') {
            if (!value || value === '') return '';
            
            // Convert to string for cleaning
            let cleaned = String(value).trim();
            
            // Clean based on field type
            if (fieldType === 'date') {
                return normalizeDate(cleaned);
            } else if (fieldType === 'number') {
                return extractNumber(cleaned);
            } else {
                return cleaned;
            }
        }
        
        function normalizeDate(dateStr) {
            if (!dateStr) return '';
            
            // Try to parse various date formats and convert to YYYY-MM-DD
            const formats = [
                // MM/DD/YYYY or M/D/YYYY
                /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/,
                // YYYY-MM-DD (already correct)
                /^(\d{4})-(\d{2})-(\d{2})$/,
                // MM-DD-YYYY
                /^(\d{1,2})-(\d{1,2})-(\d{4})$/,
                // ISO format with time
                /^(\d{4})-(\d{2})-(\d{2})T/
            ];
            
            dateStr = dateStr.trim();
            
            // Check if already in correct format
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            // Handle ISO format with time
            if (dateStr.includes('T')) {
                return dateStr.split('T')[0];
            }
            
            // Try MM/DD/YYYY format
            const slashMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if (slashMatch) {
                const [_, month, day, year] = slashMatch;
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            
            // Try MM-DD-YYYY format
            const dashMatch = dateStr.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
            if (dashMatch) {
                const [_, month, day, year] = dashMatch;
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            
            // If we can't parse it, return original (better than empty)
            console.warn('Could not normalize date:', dateStr);
            return dateStr;
        }
        
        function extractNumber(value) {
            if (!value) return '';
            
            // Convert to string
            let str = String(value).trim();
            
            // Remove common units and extract just the number
            // e.g., "1.5 MG" -> "1.5", "500 GPM" -> "500"
            const numberMatch = str.match(/^([\d,.]+)/);
            if (numberMatch) {
                // Remove commas and return
                return numberMatch[1].replace(/,/g, '');
            }
            
            return str;
        }
        
        function getFieldType(fieldId) {
            // Determine field type from ID
            if (fieldId.includes('date') || fieldId.includes('exp') || fieldId.includes('survey')) {
                return 'date';
            }
            if (fieldId.includes('count') || fieldId.includes('capacity') || 
                fieldId.includes('population') || fieldId.includes('connections') ||
                fieldId.includes('miles')) {
                return 'number';
            }
            return 'text';
        }
        
        function findDataValue(importData, section, possibleKeys) {
            // Try to find a value using multiple possible key variations
            if (!importData[section]) return null;
            
            const sectionData = importData[section];
            
            // Try each possible key
            for (const key of possibleKeys) {
                if (sectionData[key] !== undefined && sectionData[key] !== null && sectionData[key] !== '') {
                    return sectionData[key];
                }
            }
            
            return null;
        }
        
        function createFlexibleMappings() {
            // Enhanced mappings with multiple possible data keys for each field
            return {
                'overview': {
                    'pws-number': ['pwsNumber', 'pws_number', 'pwsId', 'systemNumber', 'system_id'],
                    'classification': ['classification', 'systemClassification', 'class', 'system_class'],
                    'population': ['population', 'populationServed', 'pop', 'population_served'],
                    'connections': ['connections', 'serviceConnections', 'conn', 'service_connections', 'connectionCount'],
                    'ownership': ['ownership', 'ownershipType', 'owner', 'ownership_type'],
                    'contact-name': ['contactName', 'contact_name', 'primaryContact', 'contact'],
                    'contact-phone': ['contactPhone', 'contact_phone', 'phone', 'phoneNumber'],
                    'contact-email': ['contactEmail', 'contact_email', 'email', 'emailAddress'],
                    'service-area': ['serviceArea', 'service_area', 'area', 'serviceRegion'],
                    'location': ['location', 'address', 'systemLocation', 'system_location'],
                    'last-survey': ['lastSurvey', 'last_survey', 'lastSurveyDate', 'priorSurveyDate', 'prior_survey_date'],
                    'next-survey': ['nextSurvey', 'next_survey', 'nextSurveyDate', 'upcoming_survey']
                },
                'permits': {
                    'permit-number': ['permitNumber', 'permit_number', 'permit', 'permitId'],
                    'permit-date': ['permitDate', 'permit_date', 'dateIssued', 'issue_date'],
                    'permit-status': ['permitStatus', 'permit_status', 'status'],
                    'permit-conditions': ['permitConditions', 'permit_conditions', 'conditions'],
                    'violations': ['violations', 'violationHistory', 'violation_history'],
                    'mcl-exceedances': ['mclExceedances', 'mcl_exceedances', 'exceedances', 'mclViolations'],
                    'compliance-notes': ['complianceNotes', 'compliance_notes', 'notes', 'complianceHistory']
                },
                'treatment': {
                    'treatment-class': ['classification', 'class', 'treatmentClass', 'treatment_class'],
                    'treatment-capacity': ['capacity', 'treatmentCapacity', 'treatment_capacity', 'maxCapacity'],
                    'treatment-type': ['type', 'treatmentType', 'treatment_type', 'processType'],
                    'treatment-processes': ['processes', 'treatmentProcesses', 'treatment_processes', 'processList'],
                    'ops-plan-date': ['opsPlanDate', 'ops_plan_date', 'operationsPlanDate', 'planDate'],
                    'treatment-notes': ['notes', 'treatmentNotes', 'treatment_notes', 'additionalInfo']
                },
                'distribution': {
                    'dist-class': ['classification', 'class', 'distClass', 'dist_class'],
                    'total-miles': ['pipeMiles', 'totalMiles', 'total_miles', 'pipelineMiles', 'miles', 'mains_miles'],
                    'pressure-zones': ['pressureZones', 'pressure_zones', 'zones', 'numberOfZones'],
                    'pipe-types': ['pipeMaterials', 'pipe_materials', 'pipeTypes', 'materials', 'pipe_types'],
                    'valve-count': ['valveCount', 'valve_count', 'valves', 'numberOfValves'],
                    'hydrant-count': ['hydrantCount', 'hydrant_count', 'hydrants', 'numberOfHydrants'],
                    'valve-program': ['valveProgram', 'valve_program', 'valveMaintenance'],
                    'flushing-program': ['flushingProgram', 'flushing_program', 'mainFlushing'],
                    'main-breaks': ['mainBreaks', 'main_breaks', 'breaks', 'breakHistory'],
                    'ccc-coordinator': ['cccCoordinator', 'ccc_coordinator', 'coordinator'],
                    'ccc-survey-date': ['cccSurveyDate', 'ccc_survey_date', 'cccDate', 'surveyDate'],
                    'backflow-count': ['backflowCount', 'backflow_count', 'backflows', 'assemblies'],
                    'test-compliance': ['testCompliance', 'test_compliance', 'compliance', 'testingCompliance']
                },
                'storage': {
                    'total-storage-capacity': ['totalCapacity', 'total_capacity', 'capacity', 'storageCapacity'],
                    'storage-redundancy': ['redundancyAdequate', 'redundancy_adequate', 'redundancy', 'hasRedundancy'],
                    'storage-notes': ['notes', 'storageNotes', 'storage_notes', 'additionalInfo']
                },
                'pumps': {
                    'total-pump-capacity': ['totalCapacity', 'total_capacity', 'capacity', 'pumpCapacity'],
                    'backup-power-strategy': ['backupPowerStrategy', 'backup_power_strategy', 'backupPower', 'emergencyPower'],
                    'pumping-notes': ['notes', 'pumpingNotes', 'pumping_notes', 'additionalInfo']
                },
                'monitoring': {
                    'ioc-schedule': ['iocSchedule', 'ioc_schedule', 'ioc', 'inorganics'],
                    'nitrate-schedule': ['nitrateSchedule', 'nitrate_schedule', 'nitrate'],
                    'voc-schedule': ['vocSchedule', 'voc_schedule', 'voc', 'volatiles'],
                    'soc-schedule': ['socSchedule', 'soc_schedule', 'soc', 'synthetics'],
                    'rad-schedule': ['radSchedule', 'rad_schedule', 'radionuclides', 'rad'],
                    'waivers': ['waivers', 'waiver', 'waiverStatus'],
                    'tcr-samples': ['tcrSamples', 'tcr_samples', 'tcr', 'bacteriaSamples'],
                    'bssp-date': ['bsspDate', 'bssp_date', 'sampleSitingPlan'],
                    'last-tcr': ['lastTcr', 'last_tcr', 'lastTcrDate', 'recentTcr'],
                    'assessments': ['assessments', 'assessment', 'levelAssessments'],
                    'dbp-frequency': ['dbpFreq', 'dbp_freq', 'dbpFrequency', 'dbp_frequency'],
                    'dbp-locations': ['dbpLocations', 'dbp_locations', 'dbpSites'],
                    'lraa-values': ['lraaValues', 'lraa_values', 'lraa'],
                    'lcr-schedule': ['lcrSchedule', 'lcr_schedule', 'lcr', 'leadCopper'],
                    'lcr-date': ['lcrDate', 'lcr_date', 'lastLcrDate', 'lcrSampleDate'],
                    'lcr-90th': ['lcr90th', 'lcr_90th', 'ninetiethPercentile', '90thPercentile'],
                    'service-lines': ['serviceLines', 'service_lines', 'leadLines', 'lineInventory'],
                    'ct-compliance': ['ctCompliance', 'ct_compliance', 'contactTime'],
                    'turbidity-compliance': ['turbidityCompliance', 'turbidity_compliance', 'turbidity'],
                    'swtr-reporting': ['swtrReporting', 'swtr_reporting', 'swtr'],
                    'ear-status': ['earStatus', 'ear_status', 'ear', 'electronicReporting'],
                    'ccr-date': ['ccrDate', 'ccr_date', 'consumerReport', 'reportDate'],
                    'overdue-reports': ['overdueReports', 'overdue_reports', 'overdue', 'lateReports']
                },
                'management': {
                    'ownership-structure': ['ownershipStructure', 'ownership_structure', 'structure'],
                    'staffing': ['staffing', 'staff', 'staffingLevels'],
                    'emergency-contact': ['emergencyContact', 'emergency_contact', 'emergencyPhone'],
                    'cip-date': ['cipDate', 'cip_date', 'capitalPlan', 'improvementPlan'],
                    'uwmp-date': ['uwmpDate', 'uwmp_date', 'waterManagementPlan'],
                    'wscp-date': ['wscpDate', 'wscp_date', 'contingencyPlan'],
                    'erp-date': ['erpDate', 'erp_date', 'emergencyPlan'],
                    'scada': ['scada', 'scadaSystem', 'automation'],
                    'alarms': ['alarms', 'alarmSystem', 'monitoring'],
                    'backup-power': ['backupPower', 'backup_power', 'emergencyPower'],
                    'redundancy': ['redundancy', 'systemRedundancy', 'backupSystems'],
                    'physical-security': ['physicalSecurity', 'physical_security', 'facilitySecurity'],
                    'it-security': ['itSecurity', 'it_security', 'cyberSecurity'],
                    'rra-date': ['rraDate', 'rra_date', 'riskAssessment'],
                    'eprp-date': ['eprpDate', 'eprp_date', 'preparedness'],
                    'climate-status': ['climateStatus', 'climate_status', 'climateAdaptation'],
                    'vulnerabilities': ['vulnerabilities', 'vulnerability', 'riskFactors'],
                    'mitigation': ['mitigation', 'mitigationStrategies', 'riskMitigation']
                },
                'operators': {
                    'chief-treatment-name': ['chiefTreatmentName', 'chief_treatment_name', 'treatmentOperator'],
                    'chief-treatment-level': ['chiefTreatmentLevel', 'chief_treatment_level', 'treatmentLevel'],
                    'chief-treatment-cert': ['chiefTreatmentCert', 'chief_treatment_cert', 'treatmentCert'],
                    'chief-treatment-exp': ['chiefTreatmentExp', 'chief_treatment_exp', 'treatmentExpiration'],
                    'chief-dist-name': ['chiefDistName', 'chief_dist_name', 'distOperator'],
                    'chief-dist-level': ['chiefDistLevel', 'chief_dist_level', 'distLevel'],
                    'chief-dist-cert': ['chiefDistCert', 'chief_dist_cert', 'distCert'],
                    'chief-dist-exp': ['chiefDistExp', 'chief_dist_exp', 'distExpiration'],
                    'req-treatment-cert': ['reqTreatmentCert', 'req_treatment_cert', 'requiredTreatmentCert'],
                    'req-dist-cert': ['reqDistCert', 'req_dist_cert', 'requiredDistCert'],
                    'staffing-notes': ['staffingNotes', 'staffing_notes', 'notes']
                },
                'inspectionHistory': {
                    'prior-survey-date': ['priorSurveyDate', 'prior_survey_date', 'lastInspection'],
                    'prior-inspector': ['priorInspector', 'prior_inspector', 'inspector'],
                    'prior-findings': ['priorFindings', 'prior_findings', 'findings', 'lastFindings'],
                    'prior-resolutions': ['priorResolutions', 'prior_resolutions', 'resolutions'],
                    'continuing-issues': ['continuingIssues', 'continuing_issues', 'openIssues'],
                    'current-inspection-date': ['currentInspectionDate', 'current_inspection_date', 'inspectionDate'],
                    'current-inspectors': ['currentInspectors', 'current_inspectors', 'inspectors'],
                    'pre-inspection-notes': ['preInspectionNotes', 'pre_inspection_notes', 'notes'],
                    'follow-up-items': ['followUpItems', 'follow_up_items', 'followUp'],
                    'historical-violations': ['historicalViolations', 'historical_violations', 'violations'],
                    'enforcement-actions': ['enforcementActions', 'enforcement_actions', 'enforcement'],
                    'system-responsiveness': ['systemResponsiveness', 'system_responsiveness', 'responsiveness']
                }
            };
        }
        
        // ========== ENHANCED BASIC IMPORT ==========
        
        function executeBasicImport(importData, system) {
            // Fallback basic mapping with flexible data cleaning
            let fieldsUpdated = 0;
            let itemsAdded = 0;
            
            console.log('Using basic fallback import with flexible data cleaning...');
            
            // Use the flexible mappings
            const fieldMappings = createFlexibleMappings();
            
            // Import fields for each section
            Object.keys(fieldMappings).forEach(section => {
                if (importData[section]) {
                    if (!system.systemData[section]) {
                        system.systemData[section] = {};
                    }
                    
                    Object.keys(fieldMappings[section]).forEach(htmlId => {
                        const possibleKeys = fieldMappings[section][htmlId];
                        const currentValue = system.systemData[section][possibleKeys[0]]; // Use first key as storage key
                        
                        // Try to find value using any of the possible keys
                        let importValue = findDataValue(importData, section, possibleKeys);
                        
                        if ((!currentValue || currentValue === '') && importValue && importValue !== '') {
                            // Determine field type for cleaning
                            const fieldType = getFieldType(htmlId);
                            
                            // Clean the value based on type
                            const cleanedValue = cleanValue(importValue, fieldType);
                            
                            if (cleanedValue !== '') {
                                // Save to system data using first key as standard
                                system.systemData[section][possibleKeys[0]] = cleanedValue;
                                
                                // Update form field if it exists
                                const field = document.getElementById(htmlId);
                                if (field) {
                                    field.value = cleanedValue;
                                    field.classList.add('autofilled');
                                }
                                fieldsUpdated++;
                                console.log(`‚úì Mapped ${section}.${possibleKeys[0]}: ${cleanedValue}`);
                            }
                        }
                    });
                }
            });
            
            // Import sources overview
            if (importData.sources) {
                if (!system.systemData.sources) {
                    system.systemData.sources = { list: [] };
                }
                ['overallType', 'cccProgram', 'swpMeasures', 'concerns'].forEach(field => {
                    if ((!system.systemData.sources[field] || system.systemData.sources[field] === '') && importData.sources[field]) {
                        system.systemData.sources[field] = importData.sources[field];
                        fieldsUpdated++;
                    }
                });
            }
            
            // Import arrays
            if (importData.sources?.list && Array.isArray(importData.sources.list)) {
                importData.sources.list.forEach(source => {
                    source.imported = true; // Mark as imported
                    system.systemData.sources.list.push(source);
                    itemsAdded++;
                });
            }
            
            if (importData.treatment?.facilities && Array.isArray(importData.treatment.facilities)) {
                if (!system.systemData.treatment.facilities) {
                    system.systemData.treatment.facilities = [];
                }
                importData.treatment.facilities.forEach(facility => {
                    facility.imported = true;
                    system.systemData.treatment.facilities.push(facility);
                    itemsAdded++;
                });
            }
            
            if (importData.treatment?.chemicals && Array.isArray(importData.treatment.chemicals)) {
                if (!system.systemData.treatment.chemicals) {
                    system.systemData.treatment.chemicals = [];
                }
                importData.treatment.chemicals.forEach(chemical => {
                    chemical.imported = true;
                    system.systemData.treatment.chemicals.push(chemical);
                    itemsAdded++;
                });
            }
            
            if (importData.storage?.tanks && Array.isArray(importData.storage.tanks)) {
                if (!system.systemData.storage.tanks) {
                    system.systemData.storage.tanks = [];
                }
                importData.storage.tanks.forEach(tank => {
                    tank.imported = true;
                    system.systemData.storage.tanks.push(tank);
                    itemsAdded++;
                });
            }
            
            if (importData.pumps?.stations && Array.isArray(importData.pumps.stations)) {
                if (!system.systemData.pumps.stations) {
                    system.systemData.pumps.stations = [];
                }
                importData.pumps.stations.forEach(station => {
                    station.imported = true;
                    system.systemData.pumps.stations.push(station);
                    itemsAdded++;
                });
            }
            
            if (importData.deficiencies && Array.isArray(importData.deficiencies)) {
                if (!system.systemData.deficiencies) {
                    system.systemData.deficiencies = [];
                }
                importData.deficiencies.forEach(def => {
                    def.imported = true;
                    system.systemData.deficiencies.push(def);
                    itemsAdded++;
                });
            }
            
            if (importData.permits?.amendments && Array.isArray(importData.permits.amendments)) {
                if (!system.systemData.permits.amendments) {
                    system.systemData.permits.amendments = [];
                }
                importData.permits.amendments.forEach(amend => {
                    amend.imported = true;
                    system.systemData.permits.amendments.push(amend);
                    itemsAdded++;
                });
            }
            
            // Save and update
            saveData();
            loadAllData();
            updateTabIndicators();
            hideModal();
            showImportStatus(`‚úÖ Import Complete! ${fieldsUpdated} fields populated, ${itemsAdded} items added.`, false);
            
            delete window.importDataTemp;
        }
        
        function showImportStatus(message, isError = false) {
            const statusEl = document.getElementById('importStatus');
            statusEl.textContent = message;
            statusEl.className = 'import-status' + (isError ? ' error' : '');
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
        
        function updateTabIndicators() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system?.systemData) return;
            
            const tabs = {
                'overview': hasData(system.systemData.overview),
                'permits': hasData(system.systemData.permits) || (system.systemData.permits?.amendments?.length > 0),
                'sources': (system.systemData.sources?.list?.length > 0) || hasData(system.systemData.sources),
                'treatment': (system.systemData.treatment?.facilities?.length > 0) || hasData(system.systemData.treatment),
                'distribution': hasData(system.systemData.distribution),
                'storage': (system.systemData.storage?.tanks?.length > 0) || hasData(system.systemData.storage),
                'pumps': (system.systemData.pumps?.stations?.length > 0) || hasData(system.systemData.pumps),
                'monitoring': hasData(system.systemData.monitoring),
                'management': hasData(system.systemData.management),
                'operators': hasData(system.systemData.operators),
                'deficiencies': (system.systemData.deficiencies?.length > 0),
                'inspection': hasData(system.systemData.inspectionHistory)
            };
            
            Object.keys(tabs).forEach(tabName => {
                const tabBtn = document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`);
                if (tabBtn) {
                    if (tabs[tabName]) {
                        tabBtn.classList.add('has-data');
                    } else {
                        tabBtn.classList.remove('has-data');
                    }
                }
            });
        }
        
        function hasData(obj) {
            if (!obj) return false;
            return Object.values(obj).some(val => {
                if (Array.isArray(val)) return val.length > 0;
                return val && val !== '';
            });
        }
        
        // ========== END AUTOFILL FUNCTIONS ==========


        // Tab switching
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update sections
            document.querySelectorAll('.data-section').forEach(section => section.classList.remove('active'));
            document.getElementById(tab + '-section').classList.add('active');
        }

        // Load all data into forms
        function loadAllData() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system || !system.systemData) return;
            
            const data = system.systemData;
            
            // Overview
            if (data.overview) {
                setValueIfExists('pws-number', data.overview.pwsNumber);
                setValueIfExists('classification', data.overview.classification);
                setValueIfExists('population', data.overview.population);
                setValueIfExists('connections', data.overview.connections);
                setValueIfExists('ownership', data.overview.ownership);
                setValueIfExists('contact-name', data.overview.contactName);
                setValueIfExists('contact-phone', data.overview.contactPhone);
                setValueIfExists('contact-email', data.overview.contactEmail);
                setValueIfExists('service-area', data.overview.serviceArea);
                setValueIfExists('location', data.overview.location);
                setValueIfExists('last-survey', data.overview.lastSurvey);
                setValueIfExists('next-survey', data.overview.nextSurvey);
                setValueIfExists('system-history', data.overview.systemHistory);
                setValueIfExists('known-vulnerabilities', data.overview.knownVulnerabilities);
                setValueIfExists('service-area-characteristics', data.overview.serviceAreaCharacteristics);
            }
            
            // Permits
            if (data.permits) {
                setValueIfExists('permit-number', data.permits.permitNumber);
                setValueIfExists('permit-date', data.permits.permitDate);
                setValueIfExists('permit-status', data.permits.permitStatus);
                setValueIfExists('permit-conditions', data.permits.permitConditions);
                setValueIfExists('violations', data.permits.violations);
                setValueIfExists('mcl-exceedances', data.permits.mclExceedances);
                setValueIfExists('compliance-notes', data.permits.complianceNotes);
                renderAmendments();
            }
            
            // Sources
            if (data.sources) {
                setValueIfExists('overall-source-type', data.sources.overallType);
                setValueIfExists('ccc-program', data.sources.cccProgram);
                setValueIfExists('swp-measures', data.sources.swpMeasures);
                setValueIfExists('source-concerns', data.sources.concerns);
            }
            renderSources();
            
            // Treatment
            if (data.treatment) {
                setValueIfExists('treatment-class', data.treatment.classification);
                setValueIfExists('treatment-capacity', data.treatment.capacity);
                setValueIfExists('treatment-type', data.treatment.type);
                setValueIfExists('treatment-processes', data.treatment.processes);
                setValueIfExists('ops-plan-date', data.treatment.opsPlanDate);
                setValueIfExists('treatment-notes', data.treatment.notes);
                setValueIfExists('treatment-performance', data.treatment.performance);
                setValueIfExists('treatment-improvements', data.treatment.improvements);
                renderTreatmentFacilities();
                renderChemicals();
            }
            
            // Distribution
            if (data.distribution) {
                setValueIfExists('dist-class', data.distribution.classification);
                setValueIfExists('pipe-miles', data.distribution.pipeMiles);
                setValueIfExists('pressure-zones', data.distribution.pressureZones);
                setValueIfExists('pipe-materials', data.distribution.pipeMaterials);
                setValueIfExists('valve-count', data.distribution.valveCount);
                setValueIfExists('hydrant-count', data.distribution.hydrantCount);
                setValueIfExists('valve-program', data.distribution.valveProgram);
                setValueIfExists('flushing-program', data.distribution.flushingProgram);
                setValueIfExists('main-breaks', data.distribution.mainBreaks);
                setValueIfExists('ccc-coordinator', data.distribution.cccCoordinator);
                setValueIfExists('ccc-survey-date', data.distribution.cccSurveyDate);
                setValueIfExists('backflow-count', data.distribution.backflowCount);
                setValueIfExists('test-compliance', data.distribution.testCompliance);
            }
            
            // Storage
            if (data.storage) {
                setValueIfExists('total-storage-capacity', data.storage.totalCapacity);
                setValueIfExists('storage-redundancy', data.storage.redundancyAdequate);
                setValueIfExists('storage-notes', data.storage.notes);
            }
            renderStorage();
            
            // Pumps
            if (data.pumps) {
                setValueIfExists('total-pump-capacity', data.pumps.totalCapacity);
                setValueIfExists('backup-power-strategy', data.pumps.backupPowerStrategy);
                setValueIfExists('pumping-notes', data.pumps.notes);
            }
            renderPumps();
            
            // Monitoring
            if (data.monitoring) {
                setValueIfExists('ioc-schedule', data.monitoring.iocSchedule);
                setValueIfExists('nitrate-schedule', data.monitoring.nitrateSchedule);
                setValueIfExists('voc-schedule', data.monitoring.vocSchedule);
                setValueIfExists('soc-schedule', data.monitoring.socSchedule);
                setValueIfExists('rad-schedule', data.monitoring.radSchedule);
                setValueIfExists('waivers', data.monitoring.waivers);
                setValueIfExists('tcr-samples', data.monitoring.tcrSamples);
                setValueIfExists('bssp-date', data.monitoring.bsspDate);
                setValueIfExists('last-tcr', data.monitoring.lastTcr);
                setValueIfExists('assessments', data.monitoring.assessments);
                setValueIfExists('dbp-freq', data.monitoring.dbpFreq);
                setValueIfExists('dbp-locations', data.monitoring.dbpLocations);
                setValueIfExists('lraa-values', data.monitoring.lraaValues);
                setValueIfExists('lcr-schedule', data.monitoring.lcrSchedule);
                setValueIfExists('lcr-date', data.monitoring.lcrDate);
                setValueIfExists('lcr-90th', data.monitoring.lcr90th);
                setValueIfExists('service-lines', data.monitoring.serviceLines);
                setValueIfExists('ct-compliance', data.monitoring.ctCompliance);
                setValueIfExists('turbidity-compliance', data.monitoring.turbidityCompliance);
                setValueIfExists('swtr-reporting', data.monitoring.swtrReporting);
                setValueIfExists('ear-status', data.monitoring.earStatus);
                setValueIfExists('ccr-date', data.monitoring.ccrDate);
                setValueIfExists('overdue-reports', data.monitoring.overdueReports);
            }
            
            // Management
            if (data.management) {
                setValueIfExists('ownership-structure', data.management.ownershipStructure);
                setValueIfExists('staffing', data.management.staffing);
                setValueIfExists('emergency-contact', data.management.emergencyContact);
                setValueIfExists('cip-date', data.management.cipDate);
                setValueIfExists('uwmp-date', data.management.uwmpDate);
                setValueIfExists('wscp-date', data.management.wscpDate);
                setValueIfExists('erp-date', data.management.erpDate);
                setValueIfExists('scada', data.management.scada);
                setValueIfExists('alarms', data.management.alarms);
                setValueIfExists('backup-power', data.management.backupPower);
                setValueIfExists('redundancy', data.management.redundancy);
                setValueIfExists('physical-security', data.management.physicalSecurity);
                setValueIfExists('it-security', data.management.itSecurity);
                setValueIfExists('rra-date', data.management.rraDate);
                setValueIfExists('eprp-date', data.management.eprpDate);
                setValueIfExists('climate-status', data.management.climateStatus);
                setValueIfExists('vulnerabilities', data.management.vulnerabilities);
                setValueIfExists('mitigation', data.management.mitigation);
                setValueIfExists('performance-assessment', data.management.performanceAssessment);
                setValueIfExists('operator-comments', data.management.operatorComments);
                setValueIfExists('recent-improvements', data.management.recentImprovements);
                setValueIfExists('future-plans', data.management.futurePlans);
                setValueIfExists('outstanding-issues', data.management.outstandingIssues);
            }
            
            // Operators
            if (data.operators) {
                setValueIfExists('chief-treatment-name', data.operators.chiefTreatmentName);
                setValueIfExists('chief-treatment-level', data.operators.chiefTreatmentLevel);
                setValueIfExists('chief-treatment-cert', data.operators.chiefTreatmentCert);
                setValueIfExists('chief-treatment-exp', data.operators.chiefTreatmentExp);
                setValueIfExists('chief-dist-name', data.operators.chiefDistName);
                setValueIfExists('chief-dist-level', data.operators.chiefDistLevel);
                setValueIfExists('chief-dist-cert', data.operators.chiefDistCert);
                setValueIfExists('chief-dist-exp', data.operators.chiefDistExp);
                setValueIfExists('req-treatment-cert', data.operators.reqTreatmentCert);
                setValueIfExists('req-dist-cert', data.operators.reqDistCert);
                setValueIfExists('staffing-notes', data.operators.staffingNotes);
                renderShiftOperators();
            }
            
            // Deficiencies
            renderDeficiencies();
            
            // Inspection History
            if (data.inspectionHistory) {
                setValueIfExists('prior-survey-date', data.inspectionHistory.priorSurveyDate);
                setValueIfExists('prior-inspector', data.inspectionHistory.priorInspector);
                setValueIfExists('prior-findings', data.inspectionHistory.priorFindings);
                setValueIfExists('prior-resolutions', data.inspectionHistory.priorResolutions);
                setValueIfExists('continuing-issues', data.inspectionHistory.continuingIssues);
                setValueIfExists('current-inspection-date', data.inspectionHistory.currentInspectionDate);
                setValueIfExists('current-inspectors', data.inspectionHistory.currentInspectors);
                setValueIfExists('pre-inspection-notes', data.inspectionHistory.preInspectionNotes);
                setValueIfExists('follow-up-items', data.inspectionHistory.followUpItems);
                setValueIfExists('historical-violations', data.inspectionHistory.historicalViolations);
                setValueIfExists('enforcement-actions', data.inspectionHistory.enforcementActions);
                setValueIfExists('system-responsiveness', data.inspectionHistory.systemResponsiveness);
            }
        }

        function setValueIfExists(id, value) {
            const element = document.getElementById(id);
            if (element && value !== undefined && value !== null) {
                element.value = value;
            }
        }

        // Save all data
        function saveAllData() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system) return;
            
            if (!system.systemData) {
                system.systemData = {};
            }
            
            // Overview
            system.systemData.overview = {
                pwsNumber: document.getElementById('pws-number').value,
                classification: document.getElementById('classification').value,
                population: document.getElementById('population').value,
                connections: document.getElementById('connections').value,
                ownership: document.getElementById('ownership').value,
                contactName: document.getElementById('contact-name').value,
                contactPhone: document.getElementById('contact-phone').value,
                contactEmail: document.getElementById('contact-email').value,
                serviceArea: document.getElementById('service-area').value,
                location: document.getElementById('location').value,
                lastSurvey: document.getElementById('last-survey').value,
                nextSurvey: document.getElementById('next-survey').value
            };
            
            // Permits
            if (!system.systemData.permits) system.systemData.permits = { amendments: [] };
            system.systemData.permits.permitNumber = document.getElementById('permit-number').value;
            system.systemData.permits.permitDate = document.getElementById('permit-date').value;
            system.systemData.permits.permitStatus = document.getElementById('permit-status').value;
            system.systemData.permits.permitConditions = document.getElementById('permit-conditions').value;
            system.systemData.permits.violations = document.getElementById('violations').value;
            system.systemData.permits.mclExceedances = document.getElementById('mcl-exceedances').value;
            system.systemData.permits.complianceNotes = document.getElementById('compliance-notes').value;
            
            // Treatment
            if (!system.systemData.treatment) system.systemData.treatment = { chemicals: [] };
            system.systemData.treatment.classification = document.getElementById('treatment-class').value;
            system.systemData.treatment.capacity = document.getElementById('treatment-capacity').value;
            system.systemData.treatment.type = document.getElementById('treatment-type').value;
            system.systemData.treatment.processes = document.getElementById('treatment-processes').value;
            system.systemData.treatment.opsPlanDate = document.getElementById('ops-plan-date').value;
            system.systemData.treatment.notes = document.getElementById('treatment-notes').value;
            
            // Distribution
            if (!system.systemData.distribution) system.systemData.distribution = {};
            system.systemData.distribution.classification = document.getElementById('dist-class').value;
            system.systemData.distribution.pipeMiles = document.getElementById('pipe-miles').value;
            system.systemData.distribution.pressureZones = document.getElementById('pressure-zones').value;
            system.systemData.distribution.pipeMaterials = document.getElementById('pipe-materials').value;
            system.systemData.distribution.valveCount = document.getElementById('valve-count').value;
            system.systemData.distribution.hydrantCount = document.getElementById('hydrant-count').value;
            system.systemData.distribution.valveProgram = document.getElementById('valve-program').value;
            system.systemData.distribution.flushingProgram = document.getElementById('flushing-program').value;
            system.systemData.distribution.mainBreaks = document.getElementById('main-breaks').value;
            system.systemData.distribution.cccCoordinator = document.getElementById('ccc-coordinator').value;
            system.systemData.distribution.cccSurveyDate = document.getElementById('ccc-survey-date').value;
            system.systemData.distribution.backflowCount = document.getElementById('backflow-count').value;
            system.systemData.distribution.testCompliance = document.getElementById('test-compliance').value;
            
            // Monitoring
            if (!system.systemData.monitoring) system.systemData.monitoring = {};
            system.systemData.monitoring.iocSchedule = document.getElementById('ioc-schedule').value;
            system.systemData.monitoring.nitrateSchedule = document.getElementById('nitrate-schedule').value;
            system.systemData.monitoring.vocSchedule = document.getElementById('voc-schedule').value;
            system.systemData.monitoring.socSchedule = document.getElementById('soc-schedule').value;
            system.systemData.monitoring.radSchedule = document.getElementById('rad-schedule').value;
            system.systemData.monitoring.waivers = document.getElementById('waivers').value;
            system.systemData.monitoring.tcrSamples = document.getElementById('tcr-samples').value;
            system.systemData.monitoring.bsspDate = document.getElementById('bssp-date').value;
            system.systemData.monitoring.lastTcr = document.getElementById('last-tcr').value;
            system.systemData.monitoring.assessments = document.getElementById('assessments').value;
            system.systemData.monitoring.dbpFreq = document.getElementById('dbp-freq').value;
            system.systemData.monitoring.dbpLocations = document.getElementById('dbp-locations').value;
            system.systemData.monitoring.lraaValues = document.getElementById('lraa-values').value;
            system.systemData.monitoring.lcrSchedule = document.getElementById('lcr-schedule').value;
            system.systemData.monitoring.lcrDate = document.getElementById('lcr-date').value;
            system.systemData.monitoring.lcr90th = document.getElementById('lcr-90th').value;
            system.systemData.monitoring.serviceLines = document.getElementById('service-lines').value;
            system.systemData.monitoring.ctCompliance = document.getElementById('ct-compliance').value;
            system.systemData.monitoring.turbidityCompliance = document.getElementById('turbidity-compliance').value;
            system.systemData.monitoring.swtrReporting = document.getElementById('swtr-reporting').value;
            system.systemData.monitoring.earStatus = document.getElementById('ear-status').value;
            system.systemData.monitoring.ccrDate = document.getElementById('ccr-date').value;
            system.systemData.monitoring.overdueReports = document.getElementById('overdue-reports').value;
            
            // Management
            if (!system.systemData.management) system.systemData.management = {};
            system.systemData.management.ownershipStructure = document.getElementById('ownership-structure').value;
            system.systemData.management.staffing = document.getElementById('staffing').value;
            system.systemData.management.emergencyContact = document.getElementById('emergency-contact').value;
            system.systemData.management.cipDate = document.getElementById('cip-date').value;
            system.systemData.management.uwmpDate = document.getElementById('uwmp-date').value;
            system.systemData.management.wscpDate = document.getElementById('wscp-date').value;
            system.systemData.management.erpDate = document.getElementById('erp-date').value;
            system.systemData.management.scada = document.getElementById('scada').value;
            system.systemData.management.alarms = document.getElementById('alarms').value;
            system.systemData.management.backupPower = document.getElementById('backup-power').value;
            system.systemData.management.redundancy = document.getElementById('redundancy').value;
            system.systemData.management.physicalSecurity = document.getElementById('physical-security').value;
            system.systemData.management.itSecurity = document.getElementById('it-security').value;
            system.systemData.management.rraDate = document.getElementById('rra-date').value;
            system.systemData.management.eprpDate = document.getElementById('eprp-date').value;
            system.systemData.management.climateStatus = document.getElementById('climate-status').value;
            system.systemData.management.vulnerabilities = document.getElementById('vulnerabilities').value;
            system.systemData.management.mitigation = document.getElementById('mitigation').value;
            
            // Operators
            if (!system.systemData.operators) system.systemData.operators = { shiftOperators: [] };
            system.systemData.operators.chiefTreatmentName = document.getElementById('chief-treatment-name').value;
            system.systemData.operators.chiefTreatmentLevel = document.getElementById('chief-treatment-level').value;
            system.systemData.operators.chiefTreatmentCert = document.getElementById('chief-treatment-cert').value;
            system.systemData.operators.chiefTreatmentExp = document.getElementById('chief-treatment-exp').value;
            system.systemData.operators.chiefDistName = document.getElementById('chief-dist-name').value;
            system.systemData.operators.chiefDistLevel = document.getElementById('chief-dist-level').value;
            system.systemData.operators.chiefDistCert = document.getElementById('chief-dist-cert').value;
            system.systemData.operators.chiefDistExp = document.getElementById('chief-dist-exp').value;
            system.systemData.operators.reqTreatmentCert = document.getElementById('req-treatment-cert').value;
            system.systemData.operators.reqDistCert = document.getElementById('req-dist-cert').value;
            system.systemData.operators.staffingNotes = document.getElementById('staffing-notes').value;
            
            saveData();
            
            // Visual feedback
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úì Saved!';
            btn.style.background = '#28a745';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        // Placeholder render functions (to be implemented)
        function renderAmendments() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            const container = document.getElementById('amendments-list');
            if (!system.systemData.permits.amendments || system.systemData.permits.amendments.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><div style="color: #8e8e93;">No amendments added yet</div></div>';
            } else {
                // Will implement full rendering later
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px;">Amendments list (coming soon)</div>';
            }
        }

        // ========== RENDERING FUNCTIONS ==========
        
        // Amendments
        function renderAmendments() {
            const container = document.getElementById('amendments-list');
            if (!currentSystemData.permits || !currentSystemData.permits.amendments || currentSystemData.permits.amendments.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No amendments added yet</div>';
                return;
            }
            container.innerHTML = currentSystemData.permits.amendments.map((amend, i) => `
                <div class="list-item-card">
                    <div class="list-item-header">
                        <strong>Amendment #${amend.number || i+1}</strong>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editAmendment(${i})">Edit</button>
                            <button class="btn-delete" onclick="deleteAmendment(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>Date:</strong> ${amend.date || 'N/A'}</div>
                        <div><strong>Purpose:</strong> ${amend.purpose || 'N/A'}</div>
                    </div>
                </div>
            `).join('');
        }

        function addAmendment() {
            showModal(`
                <h3>Add Amendment</h3>
                <div class="form-group">
                    <label>Amendment Number</label>
                    <input type="text" id="modal-amend-number" class="form-input" placeholder="e.g., 1, 2, 3">
                </div>
                <div class="form-group">
                    <label>Date Issued</label>
                    <input type="date" id="modal-amend-date" class="form-input">
                </div>
                <div class="form-group">
                    <label>Purpose</label>
                    <textarea id="modal-amend-purpose" class="form-textarea" rows="3" placeholder="Reason for amendment..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveAmendment()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveAmendment(index = null) {
            const amendment = {
                number: document.getElementById('modal-amend-number').value,
                date: document.getElementById('modal-amend-date').value,
                purpose: document.getElementById('modal-amend-purpose').value
            };
            
            if (!currentSystemData.permits) currentSystemData.permits = {};
            if (!currentSystemData.permits.amendments) currentSystemData.permits.amendments = [];
            
            if (index !== null) {
                currentSystemData.permits.amendments[index] = amendment;
            } else {
                currentSystemData.permits.amendments.push(amendment);
            }
            
            hideModal();
            renderAmendments();
            saveData();
        }

        function editAmendment(index) {
            const amend = currentSystemData.permits.amendments[index];
            showModal(`
                <h3>Edit Amendment</h3>
                <div class="form-group">
                    <label>Amendment Number</label>
                    <input type="text" id="modal-amend-number" class="form-input" value="${amend.number || ''}">
                </div>
                <div class="form-group">
                    <label>Date Issued</label>
                    <input type="date" id="modal-amend-date" class="form-input" value="${amend.date || ''}">
                </div>
                <div class="form-group">
                    <label>Purpose</label>
                    <textarea id="modal-amend-purpose" class="form-textarea" rows="3">${amend.purpose || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveAmendment(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteAmendment(index) {
            if (confirm('Delete this amendment?')) {
                currentSystemData.permits.amendments.splice(index, 1);
                renderAmendments();
                saveData();
            }
        }

        // Sources (with well construction details)
        function renderSources() {
            const container = document.getElementById('sources-list');
            if (!currentSystemData.sources || !currentSystemData.sources.list || currentSystemData.sources.list.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No sources added yet</div>';
                return;
            }
            container.innerHTML = currentSystemData.sources.list.map((src, i) => `
                <div class="list-item-card ${src.imported ? 'autofilled' : ''}">
                    <div class="list-item-header">
                        <strong>${src.name || 'Unnamed Source'}</strong> 
                        <span class="badge badge-${src.status === 'Active' ? 'green' : 'gray'}">${src.status || 'Unknown'}</span>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editSource(${i})">Edit</button>
                            <button class="btn-delete" onclick="deleteSource(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>PS Code:</strong> ${src.psCode || 'N/A'}</div>
                        <div><strong>Type:</strong> ${src.type || 'N/A'} | <strong>Capacity:</strong> ${src.capacity || 'N/A'} MGD</div>
                        ${src.constructionDate ? `<div><strong>Construction:</strong> ${src.constructionDate}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function addSource() {
            showModal(`
                <h3>Add Water Source</h3>
                <div class="form-group">
                    <label>Source Name *</label>
                    <input type="text" id="modal-src-name" class="form-input" placeholder="e.g., Well #1, Surface Water Intake">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>PS Code</label>
                        <input type="text" id="modal-src-ps" class="form-input" placeholder="CA#######_###_###">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-src-type" class="form-select">
                            <option value="">Select...</option>
                            <option>Groundwater</option>
                            <option>Surface Water</option>
                            <option>Purchased</option>
                            <option>Emergency</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Status</label>
                        <select id="modal-src-status" class="form-select">
                            <option>Active</option>
                            <option>Standby</option>
                            <option>Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Capacity (MGD)</label>
                        <input type="number" step="0.01" id="modal-src-capacity" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Construction Date</label>
                    <input type="date" id="modal-src-date" class="form-input">
                </div>
                <div class="form-group">
                    <label>Well Details (if GW)</label>
                    <textarea id="modal-src-well" class="form-textarea" rows="3" placeholder="Casing depth, diameter, material; Annular seal depth; Screen depth and slot size"></textarea>
                </div>
                <div class="form-group">
                    <label>DWSAP Evaluation Date</label>
                    <input type="date" id="modal-src-dwsap" class="form-input">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-src-notes" class="form-textarea" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveSource()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveSource(index = null) {
            const source = {
                name: document.getElementById('modal-src-name').value,
                psCode: document.getElementById('modal-src-ps').value,
                type: document.getElementById('modal-src-type').value,
                status: document.getElementById('modal-src-status').value,
                capacity: document.getElementById('modal-src-capacity').value,
                constructionDate: document.getElementById('modal-src-date').value,
                wellDetails: document.getElementById('modal-src-well').value,
                dwsapDate: document.getElementById('modal-src-dwsap').value,
                notes: document.getElementById('modal-src-notes').value
            };
            
            if (!currentSystemData.sources) currentSystemData.sources = { list: [] };
            if (!currentSystemData.sources.list) currentSystemData.sources.list = [];
            
            if (index !== null) {
                currentSystemData.sources.list[index] = source;
            } else {
                currentSystemData.sources.list.push(source);
            }
            
            hideModal();
            renderSources();
            saveData();
        }

        function editSource(index) {
            const src = currentSystemData.sources.list[index];
            showModal(`
                <h3>Edit Water Source</h3>
                <div class="form-group">
                    <label>Source Name *</label>
                    <input type="text" id="modal-src-name" class="form-input" value="${src.name || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>PS Code</label>
                        <input type="text" id="modal-src-ps" class="form-input" value="${src.psCode || ''}">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-src-type" class="form-select">
                            <option value="">Select...</option>
                            <option ${src.type === 'Groundwater' ? 'selected' : ''}>Groundwater</option>
                            <option ${src.type === 'Surface Water' ? 'selected' : ''}>Surface Water</option>
                            <option ${src.type === 'Purchased' ? 'selected' : ''}>Purchased</option>
                            <option ${src.type === 'Emergency' ? 'selected' : ''}>Emergency</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Status</label>
                        <select id="modal-src-status" class="form-select">
                            <option ${src.status === 'Active' ? 'selected' : ''}>Active</option>
                            <option ${src.status === 'Standby' ? 'selected' : ''}>Standby</option>
                            <option ${src.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Capacity (MGD)</label>
                        <input type="number" step="0.01" id="modal-src-capacity" class="form-input" value="${src.capacity || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Construction Date</label>
                    <input type="date" id="modal-src-date" class="form-input" value="${src.constructionDate || ''}">
                </div>
                <div class="form-group">
                    <label>Well Details (if GW)</label>
                    <textarea id="modal-src-well" class="form-textarea" rows="3">${src.wellDetails || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>DWSAP Evaluation Date</label>
                    <input type="date" id="modal-src-dwsap" class="form-input" value="${src.dwsapDate || ''}">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-src-notes" class="form-textarea" rows="2">${src.notes || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveSource(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteSource(index) {
            if (confirm('Delete this source?')) {
                currentSystemData.sources.list.splice(index, 1);
                renderSources();
                saveData();
            }
        }

        // ========== TREATMENT FACILITIES ==========
        function renderTreatmentFacilities() {
            const container = document.getElementById('treatment-facilities-list');
            if (!currentSystemData.treatment || !currentSystemData.treatment.facilities || currentSystemData.treatment.facilities.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No treatment facilities added yet</div>';
                return;
            }
            container.innerHTML = currentSystemData.treatment.facilities.map((facility, i) => `
                <div class="list-item-card" style="border-left: 4px solid #28a745;">
                    <div class="list-item-header" style="background: #f0fff0;">
                        <strong style="color: #28a745;">üè≠ ${facility.name || 'Unnamed Facility'}</strong>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editTreatmentFacility(${i})">Edit Facility</button>
                            <button class="btn-delete" onclick="deleteTreatmentFacility(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>Capacity:</strong> ${facility.capacity || 'N/A'} MGD | <strong>Classification:</strong> ${facility.classification || 'N/A'}</div>
                        <div><strong>Processes:</strong> ${facility.processes || 'N/A'}</div>
                        ${facility.location ? `<div><strong>Location:</strong> ${facility.location}</div>` : ''}
                        
                        <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>Individual Filters/Processes (${(facility.filters || []).length})</strong>
                                <button class="btn-add" style="font-size: 0.85rem; padding: 4px 12px;" onclick="addIndividualFilter(${i})">+ Add Filter</button>
                            </div>
                            ${(facility.filters || []).length === 0 ? 
                                '<div style="color: #8e8e93; text-align: center; padding: 10px;">No filters/processes added</div>' :
                                facility.filters.map((filter, j) => `
                                    <div style="border: 1px solid #e9ecef; padding: 8px; margin: 5px 0; border-radius: 4px; background: #fafafa;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <strong>${filter.name || `Filter #${j+1}`}</strong>
                                                ${filter.type ? ` | ${filter.type}` : ''}
                                                ${filter.capacity ? ` | ${filter.capacity} MGD` : ''}
                                                ${filter.media ? ` | ${filter.media}` : ''}
                                            </div>
                                            <div>
                                                <button class="btn-edit" style="font-size: 0.8rem; padding: 2px 8px;" onclick="editIndividualFilter(${i}, ${j})">Edit</button>
                                                <button class="btn-delete" style="font-size: 0.8rem; padding: 2px 8px;" onclick="deleteIndividualFilter(${i}, ${j})">Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addTreatmentFacility() {
            showModal(`
                <h3>Add Treatment Facility</h3>
                <div class="form-group">
                    <label>Facility Name *</label>
                    <input type="text" id="modal-facility-name" class="form-input" placeholder="e.g., Main WTP, Well #1 Chlorination">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="modal-facility-location" class="form-input" placeholder="Address or description">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity (MGD)</label>
                        <input type="number" step="0.01" id="modal-facility-capacity" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Classification</label>
                        <select id="modal-facility-class" class="form-select">
                            <option value="">Select...</option>
                            <option value="T1">T1</option>
                            <option value="T2">T2</option>
                            <option value="T3">T3</option>
                            <option value="T4">T4</option>
                            <option value="T5">T5</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Treatment Processes</label>
                    <textarea id="modal-facility-processes" class="form-textarea" rows="3" placeholder="e.g., Coagulation, Sedimentation, Filtration, Disinfection"></textarea>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-facility-notes" class="form-textarea" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveTreatmentFacility()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveTreatmentFacility(index = null) {
            const facility = {
                name: document.getElementById('modal-facility-name').value,
                location: document.getElementById('modal-facility-location').value,
                capacity: document.getElementById('modal-facility-capacity').value,
                classification: document.getElementById('modal-facility-class').value,
                processes: document.getElementById('modal-facility-processes').value,
                notes: document.getElementById('modal-facility-notes').value,
                filters: []
            };
            
            if (!currentSystemData.treatment.facilities) {
                currentSystemData.treatment.facilities = [];
            }
            
            if (index !== null) {
                // Preserve existing filters when editing facility
                facility.filters = currentSystemData.treatment.facilities[index].filters || [];
                currentSystemData.treatment.facilities[index] = facility;
            } else {
                currentSystemData.treatment.facilities.push(facility);
            }
            
            hideModal();
            renderTreatmentFacilities();
            saveData();
        }

        function editTreatmentFacility(index) {
            const facility = currentSystemData.treatment.facilities[index];
            showModal(`
                <h3>Edit Treatment Facility</h3>
                <div class="form-group">
                    <label>Facility Name *</label>
                    <input type="text" id="modal-facility-name" class="form-input" value="${facility.name || ''}">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="modal-facility-location" class="form-input" value="${facility.location || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity (MGD)</label>
                        <input type="number" step="0.01" id="modal-facility-capacity" class="form-input" value="${facility.capacity || ''}">
                    </div>
                    <div class="form-group">
                        <label>Classification</label>
                        <select id="modal-facility-class" class="form-select">
                            <option value="">Select...</option>
                            <option value="T1" ${facility.classification === 'T1' ? 'selected' : ''}>T1</option>
                            <option value="T2" ${facility.classification === 'T2' ? 'selected' : ''}>T2</option>
                            <option value="T3" ${facility.classification === 'T3' ? 'selected' : ''}>T3</option>
                            <option value="T4" ${facility.classification === 'T4' ? 'selected' : ''}>T4</option>
                            <option value="T5" ${facility.classification === 'T5' ? 'selected' : ''}>T5</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Treatment Processes</label>
                    <textarea id="modal-facility-processes" class="form-textarea" rows="3">${facility.processes || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-facility-notes" class="form-textarea" rows="2">${facility.notes || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveTreatmentFacility(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteTreatmentFacility(index) {
            if (confirm('Delete this treatment facility and all its filters?')) {
                currentSystemData.treatment.facilities.splice(index, 1);
                renderTreatmentFacilities();
                saveData();
            }
        }

        // Individual Filters (nested within treatment facilities)
        function addIndividualFilter(facilityIndex) {
            showModal(`
                <h3>Add Individual Filter/Process</h3>
                <p style="color: #666; margin-bottom: 15px;">Adding to: <strong>${currentSystemData.treatment.facilities[facilityIndex].name}</strong></p>
                <div class="form-group">
                    <label>Filter Name/ID *</label>
                    <input type="text" id="modal-filter-name" class="form-input" placeholder="e.g., Filter #1, Rapid Sand Filter A">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-filter-type" class="form-select">
                            <option value="">Select...</option>
                            <option value="Rapid Sand">Rapid Sand Filter</option>
                            <option value="Dual Media">Dual Media Filter</option>
                            <option value="Pressure Filter">Pressure Filter</option>
                            <option value="Membrane">Membrane (UF/MF)</option>
                            <option value="Slow Sand">Slow Sand Filter</option>
                            <option value="Cartridge">Cartridge Filter</option>
                            <option value="Bag Filter">Bag Filter</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Capacity (MGD)</label>
                        <input type="number" step="0.001" id="modal-filter-capacity" class="form-input" placeholder="0.000">
                    </div>
                </div>
                <div class="form-group">
                    <label>Filter Media</label>
                    <input type="text" id="modal-filter-media" class="form-input" placeholder="e.g., 24 in sand / 12 in anthracite">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Current Turbidity (NTU)</label>
                        <input type="number" step="0.01" id="modal-filter-turbidity" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Condition</label>
                        <select id="modal-filter-condition" class="form-select">
                            <option value="">Select...</option>
                            <option value="Good">Good</option>
                            <option value="Fair">Fair</option>
                            <option value="Poor">Poor</option>
                            <option value="Out of Service">Out of Service</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Backwash Frequency (days)</label>
                        <input type="number" id="modal-filter-backwash" class="form-input" placeholder="e.g., 3">
                    </div>
                    <div class="form-group">
                        <label>Last Media Replacement</label>
                        <input type="date" id="modal-filter-media-date" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Performance Notes</label>
                    <textarea id="modal-filter-notes" class="form-textarea" rows="2" placeholder="Filter performance, issues, maintenance needs..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveIndividualFilter(${facilityIndex})" class="modal-btn modal-btn-primary">Save Filter</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveIndividualFilter(facilityIndex, filterIndex = null) {
            const filter = {
                name: document.getElementById('modal-filter-name').value,
                type: document.getElementById('modal-filter-type').value,
                capacity: document.getElementById('modal-filter-capacity').value,
                media: document.getElementById('modal-filter-media').value,
                turbidity: document.getElementById('modal-filter-turbidity').value,
                condition: document.getElementById('modal-filter-condition').value,
                backwashFrequency: document.getElementById('modal-filter-backwash').value,
                lastMediaReplacement: document.getElementById('modal-filter-media-date').value,
                notes: document.getElementById('modal-filter-notes').value
            };
            
            if (!currentSystemData.treatment.facilities[facilityIndex].filters) {
                currentSystemData.treatment.facilities[facilityIndex].filters = [];
            }
            
            if (filterIndex !== null) {
                currentSystemData.treatment.facilities[facilityIndex].filters[filterIndex] = filter;
            } else {
                currentSystemData.treatment.facilities[facilityIndex].filters.push(filter);
            }
            
            hideModal();
            renderTreatmentFacilities();
            saveData();
        }

        function editIndividualFilter(facilityIndex, filterIndex) {
            const filter = currentSystemData.treatment.facilities[facilityIndex].filters[filterIndex];
            showModal(`
                <h3>Edit Individual Filter/Process</h3>
                <p style="color: #666; margin-bottom: 15px;">Editing filter in: <strong>${currentSystemData.treatment.facilities[facilityIndex].name}</strong></p>
                <div class="form-group">
                    <label>Filter Name/ID *</label>
                    <input type="text" id="modal-filter-name" class="form-input" value="${filter.name || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-filter-type" class="form-select">
                            <option value="">Select...</option>
                            <option value="Rapid Sand" ${filter.type === 'Rapid Sand' ? 'selected' : ''}>Rapid Sand Filter</option>
                            <option value="Dual Media" ${filter.type === 'Dual Media' ? 'selected' : ''}>Dual Media Filter</option>
                            <option value="Pressure Filter" ${filter.type === 'Pressure Filter' ? 'selected' : ''}>Pressure Filter</option>
                            <option value="Membrane" ${filter.type === 'Membrane' ? 'selected' : ''}>Membrane (UF/MF)</option>
                            <option value="Slow Sand" ${filter.type === 'Slow Sand' ? 'selected' : ''}>Slow Sand Filter</option>
                            <option value="Cartridge" ${filter.type === 'Cartridge' ? 'selected' : ''}>Cartridge Filter</option>
                            <option value="Bag Filter" ${filter.type === 'Bag Filter' ? 'selected' : ''}>Bag Filter</option>
                            <option value="Other" ${filter.type === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Capacity (MGD)</label>
                        <input type="number" step="0.001" id="modal-filter-capacity" class="form-input" value="${filter.capacity || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Filter Media</label>
                    <input type="text" id="modal-filter-media" class="form-input" value="${filter.media || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Current Turbidity (NTU)</label>
                        <input type="number" step="0.01" id="modal-filter-turbidity" class="form-input" value="${filter.turbidity || ''}">
                    </div>
                    <div class="form-group">
                        <label>Condition</label>
                        <select id="modal-filter-condition" class="form-select">
                            <option value="">Select...</option>
                            <option value="Good" ${filter.condition === 'Good' ? 'selected' : ''}>Good</option>
                            <option value="Fair" ${filter.condition === 'Fair' ? 'selected' : ''}>Fair</option>
                            <option value="Poor" ${filter.condition === 'Poor' ? 'selected' : ''}>Poor</option>
                            <option value="Out of Service" ${filter.condition === 'Out of Service' ? 'selected' : ''}>Out of Service</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Backwash Frequency (days)</label>
                        <input type="number" id="modal-filter-backwash" class="form-input" value="${filter.backwashFrequency || ''}">
                    </div>
                    <div class="form-group">
                        <label>Last Media Replacement</label>
                        <input type="date" id="modal-filter-media-date" class="form-input" value="${filter.lastMediaReplacement || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Performance Notes</label>
                    <textarea id="modal-filter-notes" class="form-textarea" rows="2">${filter.notes || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveIndividualFilter(${facilityIndex}, ${filterIndex})" class="modal-btn modal-btn-primary">Save Changes</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteIndividualFilter(facilityIndex, filterIndex) {
            if (confirm('Delete this filter?')) {
                currentSystemData.treatment.facilities[facilityIndex].filters.splice(filterIndex, 1);
                renderTreatmentFacilities();
                saveData();
            }
        }

        // Chemicals
        function renderChemicals() {
            const container = document.getElementById('chemicals-list');
            if (!currentSystemData.treatment || !currentSystemData.treatment.chemicals || currentSystemData.treatment.chemicals.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No chemicals added yet</div>';
                return;
            }
            container.innerHTML = currentSystemData.treatment.chemicals.map((chem, i) => `
                <div class="list-item-card">
                    <div class="list-item-header">
                        <strong>${chem.name || 'Unnamed Chemical'}</strong>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editChemical(${i})">Edit</button>
                            <button class="btn-delete" onclick="deleteChemical(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>NSF 60 Cert:</strong> ${chem.nsfCert || 'N/A'}</div>
                        <div><strong>Dosage:</strong> ${chem.dosage || 'N/A'} | <strong>Storage:</strong> ${chem.storage || 'N/A'}</div>
                    </div>
                </div>
            `).join('');
        }

        function addChemical() {
            showModal(`
                <h3>Add Chemical</h3>
                <div class="form-group">
                    <label>Chemical Name *</label>
                    <input type="text" id="modal-chem-name" class="form-input" placeholder="e.g., Chlorine, Sodium Hydroxide">
                </div>
                <div class="form-group">
                    <label>NSF 60 Certification #</label>
                    <input type="text" id="modal-chem-nsf" class="form-input">
                </div>
                <div class="form-group">
                    <label>Dosage Rate</label>
                    <input type="text" id="modal-chem-dosage" class="form-input" placeholder="e.g., 2-4 mg/L">
                </div>
                <div class="form-group">
                    <label>Storage Volume</label>
                    <input type="text" id="modal-chem-storage" class="form-input" placeholder="e.g., 5000 gallons">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveChemical()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveChemical(index = null) {
            const chemical = {
                name: document.getElementById('modal-chem-name').value,
                nsfCert: document.getElementById('modal-chem-nsf').value,
                dosage: document.getElementById('modal-chem-dosage').value,
                storage: document.getElementById('modal-chem-storage').value
            };
            
            if (!currentSystemData.treatment) currentSystemData.treatment = {};
            if (!currentSystemData.treatment.chemicals) currentSystemData.treatment.chemicals = [];
            
            if (index !== null) {
                currentSystemData.treatment.chemicals[index] = chemical;
            } else {
                currentSystemData.treatment.chemicals.push(chemical);
            }
            
            hideModal();
            renderChemicals();
            saveData();
        }

        function editChemical(index) {
            const chem = currentSystemData.treatment.chemicals[index];
            showModal(`
                <h3>Edit Chemical</h3>
                <div class="form-group">
                    <label>Chemical Name *</label>
                    <input type="text" id="modal-chem-name" class="form-input" value="${chem.name || ''}">
                </div>
                <div class="form-group">
                    <label>NSF 60 Certification #</label>
                    <input type="text" id="modal-chem-nsf" class="form-input" value="${chem.nsfCert || ''}">
                </div>
                <div class="form-group">
                    <label>Dosage Rate</label>
                    <input type="text" id="modal-chem-dosage" class="form-input" value="${chem.dosage || ''}">
                </div>
                <div class="form-group">
                    <label>Storage Volume</label>
                    <input type="text" id="modal-chem-storage" class="form-input" value="${chem.storage || ''}">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveChemical(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteChemical(index) {
            if (confirm('Delete this chemical?')) {
                currentSystemData.treatment.chemicals.splice(index, 1);
                renderChemicals();
                saveData();
            }
        }

        // Storage
        function renderStorage() {
            const container = document.getElementById('storage-list');
            if (!currentSystemData.storage || !currentSystemData.storage.tanks || currentSystemData.storage.tanks.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No storage tanks added yet</div>';
                return;
            }
            container.innerHTML = currentSystemData.storage.tanks.map((tank, i) => `
                <div class="list-item-card">
                    <div class="list-item-header">
                        <strong>${tank.name || 'Unnamed Tank'}</strong>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editStorage(${i})">Edit</button>
                            <button class="btn-delete" onclick="deleteStorage(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>Type:</strong> ${tank.type || 'N/A'} | <strong>Material:</strong> ${tank.material || 'N/A'}</div>
                        <div><strong>Capacity:</strong> ${tank.capacity || 'N/A'} MG | <strong>Zone:</strong> ${tank.zone || 'N/A'}</div>
                        <div><strong>Year Built:</strong> ${tank.year || 'N/A'}</div>
                    </div>
                </div>
            `).join('');
        }

        function addStorage() {
            showModal(`
                <h3>Add Storage Tank</h3>
                <div class="form-group">
                    <label>Tank Name *</label>
                    <input type="text" id="modal-tank-name" class="form-input" placeholder="e.g., Reservoir #1">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-tank-type" class="form-select">
                            <option value="">Select...</option>
                            <option>Elevated</option>
                            <option>Ground</option>
                            <option>Standby</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Material</label>
                        <select id="modal-tank-material" class="form-select">
                            <option value="">Select...</option>
                            <option>Steel</option>
                            <option>Concrete</option>
                            <option>Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity (MG)</label>
                        <input type="number" step="0.1" id="modal-tank-capacity" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Pressure Zone</label>
                        <input type="text" id="modal-tank-zone" class="form-input">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Year Built</label>
                        <input type="number" id="modal-tank-year" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Last Inspection</label>
                        <input type="date" id="modal-tank-insp" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Last Cleaning</label>
                    <input type="date" id="modal-tank-clean" class="form-input">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-tank-notes" class="form-textarea" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveStorage()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveStorage(index = null) {
            const tank = {
                name: document.getElementById('modal-tank-name').value,
                type: document.getElementById('modal-tank-type').value,
                material: document.getElementById('modal-tank-material').value,
                capacity: document.getElementById('modal-tank-capacity').value,
                zone: document.getElementById('modal-tank-zone').value,
                year: document.getElementById('modal-tank-year').value,
                lastInspection: document.getElementById('modal-tank-insp').value,
                lastCleaning: document.getElementById('modal-tank-clean').value,
                notes: document.getElementById('modal-tank-notes').value
            };
            
            if (!currentSystemData.storage) currentSystemData.storage = { tanks: [] };
            if (!currentSystemData.storage.tanks) currentSystemData.storage.tanks = [];
            
            if (index !== null) {
                currentSystemData.storage.tanks[index] = tank;
            } else {
                currentSystemData.storage.tanks.push(tank);
            }
            
            hideModal();
            renderStorage();
            saveData();
        }

        function editStorage(index) {
            const tank = currentSystemData.storage.tanks[index];
            showModal(`
                <h3>Edit Storage Tank</h3>
                <div class="form-group">
                    <label>Tank Name *</label>
                    <input type="text" id="modal-tank-name" class="form-input" value="${tank.name || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-tank-type" class="form-select">
                            <option value="">Select...</option>
                            <option ${tank.type === 'Elevated' ? 'selected' : ''}>Elevated</option>
                            <option ${tank.type === 'Ground' ? 'selected' : ''}>Ground</option>
                            <option ${tank.type === 'Standby' ? 'selected' : ''}>Standby</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Material</label>
                        <select id="modal-tank-material" class="form-select">
                            <option value="">Select...</option>
                            <option ${tank.material === 'Steel' ? 'selected' : ''}>Steel</option>
                            <option ${tank.material === 'Concrete' ? 'selected' : ''}>Concrete</option>
                            <option ${tank.material === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity (MG)</label>
                        <input type="number" step="0.1" id="modal-tank-capacity" class="form-input" value="${tank.capacity || ''}">
                    </div>
                    <div class="form-group">
                        <label>Pressure Zone</label>
                        <input type="text" id="modal-tank-zone" class="form-input" value="${tank.zone || ''}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Year Built</label>
                        <input type="number" id="modal-tank-year" class="form-input" value="${tank.year || ''}">
                    </div>
                    <div class="form-group">
                        <label>Last Inspection</label>
                        <input type="date" id="modal-tank-insp" class="form-input" value="${tank.lastInspection || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Last Cleaning</label>
                    <input type="date" id="modal-tank-clean" class="form-input" value="${tank.lastCleaning || ''}">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-tank-notes" class="form-textarea" rows="2">${tank.notes || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveStorage(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteStorage(index) {
            if (confirm('Delete this storage tank?')) {
                currentSystemData.storage.tanks.splice(index, 1);
                renderStorage();
                saveData();
            }
        }

        // ========== PUMP STATIONS WITH NESTED INDIVIDUAL PUMPS ==========
        function renderPumps() {
            const container = document.getElementById('pumps-list');
            if (!currentSystemData.pumps || !currentSystemData.pumps.stations || currentSystemData.pumps.stations.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No pump stations added yet</div>';
                return;
            }
            container.innerHTML = currentSystemData.pumps.stations.map((station, i) => `
                <div class="list-item-card" style="border-left: 4px solid #fd7e14;">
                    <div class="list-item-header" style="background: #fff8f2;">
                        <strong style="color: #fd7e14;">üîß ${station.name || 'Unnamed Station'}</strong>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editPumpStation(${i})">Edit Station</button>
                            <button class="btn-delete" onclick="deletePumpStation(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>Location:</strong> ${station.location || 'N/A'}</div>
                        <div><strong>Service:</strong> ${station.serviceType || 'N/A'} | <strong>Zone:</strong> ${station.zone || 'N/A'}</div>
                        <div><strong>Backup Power:</strong> ${station.backupPower || 'N/A'}</div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>Individual Pumps (${(station.pumps || []).length})</strong>
                                <button class="btn-add" style="font-size: 0.85rem; padding: 4px 12px;" onclick="addIndividualPump(${i})">+ Add Pump</button>
                            </div>
                            ${(station.pumps || []).length === 0 ? 
                                '<div style="color: #8e8e93; text-align: center; padding: 10px;">No pumps added</div>' :
                                station.pumps.map((pump, j) => `
                                    <div style="border: 1px solid #e9ecef; padding: 8px; margin: 5px 0; border-radius: 4px; background: #fafafa;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <strong>${pump.name || `Pump #${j+1}`}</strong>
                                                ${pump.type ? ` | ${pump.type}` : ''}
                                                ${pump.hp ? ` | ${pump.hp} HP` : ''}
                                                ${pump.capacity ? ` | ${pump.capacity} GPM` : ''}
                                            </div>
                                            <div>
                                                <button class="btn-edit" style="font-size: 0.8rem; padding: 2px 8px;" onclick="editIndividualPump(${i}, ${j})">Edit</button>
                                                <button class="btn-delete" style="font-size: 0.8rem; padding: 2px 8px;" onclick="deleteIndividualPump(${i}, ${j})">Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addPumpStation() {
            showModal(`
                <h3>Add Pump Station</h3>
                <div class="form-group">
                    <label>Station Name *</label>
                    <input type="text" id="modal-station-name" class="form-input" placeholder="e.g., Wellhead PS, Zone 2 Booster">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="modal-station-location" class="form-input" placeholder="e.g., 123 Main St">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Service Type</label>
                        <select id="modal-station-service" class="form-select">
                            <option value="">Select...</option>
                            <option>Raw Water</option>
                            <option>Finished Water</option>
                            <option>Booster</option>
                            <option>High Service</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pressure Zone</label>
                        <input type="text" id="modal-station-zone" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Backup Power</label>
                    <select id="modal-station-backup" class="form-select">
                        <option value="">Select...</option>
                        <option>Generator</option>
                        <option>Portable Generator</option>
                        <option>None</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-station-notes" class="form-textarea" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="savePumpStation()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function savePumpStation(index = null) {
            const station = {
                name: document.getElementById('modal-station-name').value,
                location: document.getElementById('modal-station-location').value,
                serviceType: document.getElementById('modal-station-service').value,
                zone: document.getElementById('modal-station-zone').value,
                backupPower: document.getElementById('modal-station-backup').value,
                notes: document.getElementById('modal-station-notes').value,
                pumps: []
            };
            
            if (!currentSystemData.pumps) currentSystemData.pumps = { stations: [] };
            if (!currentSystemData.pumps.stations) currentSystemData.pumps.stations = [];
            
            if (index !== null) {
                station.pumps = currentSystemData.pumps.stations[index].pumps || [];
                currentSystemData.pumps.stations[index] = station;
            } else {
                currentSystemData.pumps.stations.push(station);
            }
            
            hideModal();
            renderPumps();
            saveData();
        }

        function editPumpStation(index) {
            const station = currentSystemData.pumps.stations[index];
            showModal(`
                <h3>Edit Pump Station</h3>
                <div class="form-group">
                    <label>Station Name *</label>
                    <input type="text" id="modal-station-name" class="form-input" value="${station.name || ''}">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="modal-station-location" class="form-input" value="${station.location || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Service Type</label>
                        <select id="modal-station-service" class="form-select">
                            <option value="">Select...</option>
                            <option ${station.serviceType === 'Raw Water' ? 'selected' : ''}>Raw Water</option>
                            <option ${station.serviceType === 'Finished Water' ? 'selected' : ''}>Finished Water</option>
                            <option ${station.serviceType === 'Booster' ? 'selected' : ''}>Booster</option>
                            <option ${station.serviceType === 'High Service' ? 'selected' : ''}>High Service</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pressure Zone</label>
                        <input type="text" id="modal-station-zone" class="form-input" value="${station.zone || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Backup Power</label>
                    <select id="modal-station-backup" class="form-select">
                        <option value="">Select...</option>
                        <option ${station.backupPower === 'Generator' ? 'selected' : ''}>Generator</option>
                        <option ${station.backupPower === 'Portable Generator' ? 'selected' : ''}>Portable Generator</option>
                        <option ${station.backupPower === 'None' ? 'selected' : ''}>None</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-station-notes" class="form-textarea" rows="2">${station.notes || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="savePumpStation(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deletePumpStation(index) {
            if (confirm('Delete this pump station and all its pumps?')) {
                currentSystemData.pumps.stations.splice(index, 1);
                renderPumps();
                saveData();
            }
        }

        // Individual Pumps (nested within stations)
        function addIndividualPump(stationIndex) {
            showModal(`
                <h3>Add Individual Pump</h3>
                <p style="color: #666; margin-bottom: 15px;">Adding pump to: <strong>${currentSystemData.pumpStations[stationIndex].name}</strong></p>
                <div class="form-group">
                    <label>Pump Name/ID *</label>
                    <input type="text" id="modal-pump-name" class="form-input" placeholder="e.g., Pump A, Pump #1">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-pump-type" class="form-select">
                            <option value="">Select...</option>
                            <option>Vertical Turbine</option>
                            <option>Submersible</option>
                            <option>Centrifugal</option>
                            <option>Booster</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Horsepower (HP)</label>
                        <input type="number" id="modal-pump-hp" class="form-input">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity (GPM)</label>
                        <input type="number" id="modal-pump-capacity" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="modal-pump-status" class="form-select">
                            <option>Active</option>
                            <option>Standby</option>
                            <option>Out of Service</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-pump-notes" class="form-textarea" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveIndividualPump(${stationIndex})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveIndividualPump(stationIndex, pumpIndex = null) {
            const pump = {
                name: document.getElementById('modal-pump-name').value,
                type: document.getElementById('modal-pump-type').value,
                hp: document.getElementById('modal-pump-hp').value,
                capacity: document.getElementById('modal-pump-capacity').value,
                status: document.getElementById('modal-pump-status').value,
                notes: document.getElementById('modal-pump-notes').value
            };
            
            if (!currentSystemData.pumps.stations[stationIndex].pumps) {
                currentSystemData.pumps.stations[stationIndex].pumps = [];
            }
            
            if (pumpIndex !== null) {
                currentSystemData.pumps.stations[stationIndex].pumps[pumpIndex] = pump;
            } else {
                currentSystemData.pumps.stations[stationIndex].pumps.push(pump);
            }
            
            hideModal();
            renderPumps();
            saveData();
        }

        function editIndividualPump(stationIndex, pumpIndex) {
            const pump = currentSystemData.pumps.stations[stationIndex].pumps[pumpIndex];
            showModal(`
                <h3>Edit Individual Pump</h3>
                <p style="color: #666; margin-bottom: 15px;">Editing pump in: <strong>${currentSystemData.pumps.stations[stationIndex].name}</strong></p>
                <div class="form-group">
                    <label>Pump Name/ID *</label>
                    <input type="text" id="modal-pump-name" class="form-input" value="${pump.name || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="modal-pump-type" class="form-select">
                            <option value="">Select...</option>
                            <option ${pump.type === 'Vertical Turbine' ? 'selected' : ''}>Vertical Turbine</option>
                            <option ${pump.type === 'Submersible' ? 'selected' : ''}>Submersible</option>
                            <option ${pump.type === 'Centrifugal' ? 'selected' : ''}>Centrifugal</option>
                            <option ${pump.type === 'Booster' ? 'selected' : ''}>Booster</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Horsepower (HP)</label>
                        <input type="number" id="modal-pump-hp" class="form-input" value="${pump.hp || ''}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity (GPM)</label>
                        <input type="number" id="modal-pump-capacity" class="form-input" value="${pump.capacity || ''}">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="modal-pump-status" class="form-select">
                            <option ${pump.status === 'Active' ? 'selected' : ''}>Active</option>
                            <option ${pump.status === 'Standby' ? 'selected' : ''}>Standby</option>
                            <option ${pump.status === 'Out of Service' ? 'selected' : ''}>Out of Service</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="modal-pump-notes" class="form-textarea" rows="2">${pump.notes || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveIndividualPump(${stationIndex}, ${pumpIndex})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteIndividualPump(stationIndex, pumpIndex) {
            if (confirm('Delete this pump?')) {
                currentSystemData.pumps.stations[stationIndex].pumps.splice(pumpIndex, 1);
                renderPumps();
                saveData();
            }
        }

        // Shift Operators
        function renderShiftOperators() {
            const container = document.getElementById('shift-operators-list');
            if (!currentSystemData.operators || !currentSystemData.operators.shift || currentSystemData.operators.shift.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No shift operators added yet</div>';
                return;
            }
            container.innerHTML = currentSystemData.operators.shift.map((op, i) => `
                <div class="list-item-card">
                    <div class="list-item-header">
                        <strong>${op.name || 'Unnamed Operator'}</strong>
                        <span class="badge badge-blue">${op.certLevel || 'N/A'}</span>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editShiftOperator(${i})">Edit</button>
                            <button class="btn-delete" onclick="deleteShiftOperator(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>Cert #:</strong> ${op.certNumber || 'N/A'} | <strong>Expires:</strong> ${op.expiration || 'N/A'}</div>
                    </div>
                </div>
            `).join('');
        }

        function addShiftOperator() {
            showModal(`
                <h3>Add Shift Operator</h3>
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="modal-op-name" class="form-input" placeholder="Full Name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cert Level</label>
                        <select id="modal-op-level" class="form-select">
                            <option value="">Select...</option>
                            <option>T1</option>
                            <option>T2</option>
                            <option>T3</option>
                            <option>T4</option>
                            <option>T5</option>
                            <option>D1</option>
                            <option>D2</option>
                            <option>D3</option>
                            <option>D4</option>
                            <option>D5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cert Number</label>
                        <input type="text" id="modal-op-cert" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Expiration Date</label>
                    <input type="date" id="modal-op-exp" class="form-input">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveShiftOperator()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveShiftOperator(index = null) {
            const operator = {
                name: document.getElementById('modal-op-name').value,
                certLevel: document.getElementById('modal-op-level').value,
                certNumber: document.getElementById('modal-op-cert').value,
                expiration: document.getElementById('modal-op-exp').value
            };
            
            if (!currentSystemData.operators) currentSystemData.operators = {};
            if (!currentSystemData.operators.shift) currentSystemData.operators.shift = [];
            
            if (index !== null) {
                currentSystemData.operators.shift[index] = operator;
            } else {
                currentSystemData.operators.shift.push(operator);
            }
            
            hideModal();
            renderShiftOperators();
            saveData();
        }

        function editShiftOperator(index) {
            const op = currentSystemData.operators.shift[index];
            showModal(`
                <h3>Edit Shift Operator</h3>
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="modal-op-name" class="form-input" value="${op.name || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cert Level</label>
                        <select id="modal-op-level" class="form-select">
                            <option value="">Select...</option>
                            <option ${op.certLevel === 'T1' ? 'selected' : ''}>T1</option>
                            <option ${op.certLevel === 'T2' ? 'selected' : ''}>T2</option>
                            <option ${op.certLevel === 'T3' ? 'selected' : ''}>T3</option>
                            <option ${op.certLevel === 'T4' ? 'selected' : ''}>T4</option>
                            <option ${op.certLevel === 'T5' ? 'selected' : ''}>T5</option>
                            <option ${op.certLevel === 'D1' ? 'selected' : ''}>D1</option>
                            <option ${op.certLevel === 'D2' ? 'selected' : ''}>D2</option>
                            <option ${op.certLevel === 'D3' ? 'selected' : ''}>D3</option>
                            <option ${op.certLevel === 'D4' ? 'selected' : ''}>D4</option>
                            <option ${op.certLevel === 'D5' ? 'selected' : ''}>D5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cert Number</label>
                        <input type="text" id="modal-op-cert" class="form-input" value="${op.certNumber || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Expiration Date</label>
                    <input type="date" id="modal-op-exp" class="form-input" value="${op.expiration || ''}">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveShiftOperator(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteShiftOperator(index) {
            if (confirm('Delete this shift operator?')) {
                currentSystemData.operators.shift.splice(index, 1);
                renderShiftOperators();
                saveData();
            }
        }

        // Deficiencies
        function renderDeficiencies() {
            const container = document.getElementById('deficiencies-list');
            if (!currentSystemData.deficiencies || currentSystemData.deficiencies.length === 0) {
                container.innerHTML = '<div style="color: #8e8e93; padding: 20px; text-align: center;">No deficiencies added yet</div>';
                return;
            }
            
            const typeColors = { 'Significant': 'red', 'Minor': 'orange', 'Recommendation': 'blue' };
            const statusColors = { 'Open': 'red', 'In Progress': 'orange', 'Closed': 'green' };
            
            container.innerHTML = currentSystemData.deficiencies.map((def, i) => `
                <div class="list-item-card">
                    <div class="list-item-header">
                        <strong>Element ${def.element || '?'}</strong>
                        <span class="badge badge-${typeColors[def.type] || 'gray'}">${def.type || 'N/A'}</span>
                        <span class="badge badge-${statusColors[def.status] || 'gray'}">${def.status || 'Unknown'}</span>
                        <div class="list-item-actions">
                            <button class="btn-edit" onclick="editDeficiency(${i})">Edit</button>
                            <button class="btn-delete" onclick="deleteDeficiency(${i})">Delete</button>
                        </div>
                    </div>
                    <div class="list-item-body">
                        <div><strong>Description:</strong> ${def.description || 'N/A'}</div>
                        ${def.citation ? `<div><strong>Citation:</strong> ${def.citation}</div>` : ''}
                        ${def.dueDate ? `<div><strong>Due:</strong> ${def.dueDate}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function addDeficiency() {
            showModal(`
                <h3>Add Deficiency</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Element (1-8) *</label>
                        <select id="modal-def-element" class="form-select">
                            <option value="">Select...</option>
                            <option value="1">1 - Sources</option>
                            <option value="2">2 - Treatment</option>
                            <option value="3">3 - Distribution</option>
                            <option value="4">4 - Storage</option>
                            <option value="5">5 - Pumps</option>
                            <option value="6">6 - Monitoring</option>
                            <option value="7">7 - Management</option>
                            <option value="8">8 - Operators</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="modal-def-type" class="form-select">
                            <option value="">Select...</option>
                            <option>Significant</option>
                            <option>Minor</option>
                            <option>Recommendation</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="modal-def-desc" class="form-textarea" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Regulatory Citation</label>
                    <input type="text" id="modal-def-citation" class="form-input" placeholder="e.g., 22 CCR ¬ß64560">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Date Identified</label>
                        <input type="date" id="modal-def-date" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="modal-def-due" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Status *</label>
                    <select id="modal-def-status" class="form-select">
                        <option>Open</option>
                        <option>In Progress</option>
                        <option>Resolved</option>
                        <option>Closed</option>
                        <option>Ongoing</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Target Completion Date</label>
                        <input type="date" id="modal-def-target" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Actual Completion Date</label>
                        <input type="date" id="modal-def-completed" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Corrective Action Taken</label>
                    <textarea id="modal-def-action" class="form-textarea" rows="2" placeholder="What was done to address this deficiency?"></textarea>
                </div>
                <div class="form-group">
                    <label>Resolution Notes</label>
                    <textarea id="modal-def-resolution" class="form-textarea" rows="2" placeholder="Additional notes on resolution, verification, follow-up needed..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveDeficiency()" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function saveDeficiency(index = null) {
            const deficiency = {
                element: document.getElementById('modal-def-element').value,
                type: document.getElementById('modal-def-type').value,
                description: document.getElementById('modal-def-desc').value,
                citation: document.getElementById('modal-def-citation').value,
                dateIdentified: document.getElementById('modal-def-date').value,
                dueDate: document.getElementById('modal-def-due').value,
                status: document.getElementById('modal-def-status').value,
                targetCompletion: document.getElementById('modal-def-target').value,
                actualCompletion: document.getElementById('modal-def-completed').value,
                correctiveAction: document.getElementById('modal-def-action').value,
                resolution: document.getElementById('modal-def-resolution').value
            };
            
            if (!currentSystemData.deficiencies) currentSystemData.deficiencies = [];
            
            if (index !== null) {
                currentSystemData.deficiencies[index] = deficiency;
            } else {
                currentSystemData.deficiencies.push(deficiency);
            }
            
            hideModal();
            renderDeficiencies();
            saveData();
        }

        function editDeficiency(index) {
            const def = currentSystemData.deficiencies[index];
            showModal(`
                <h3>Edit Deficiency</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Element (1-8) *</label>
                        <select id="modal-def-element" class="form-select">
                            <option value="">Select...</option>
                            <option value="1" ${def.element === '1' ? 'selected' : ''}>1 - Sources</option>
                            <option value="2" ${def.element === '2' ? 'selected' : ''}>2 - Treatment</option>
                            <option value="3" ${def.element === '3' ? 'selected' : ''}>3 - Distribution</option>
                            <option value="4" ${def.element === '4' ? 'selected' : ''}>4 - Storage</option>
                            <option value="5" ${def.element === '5' ? 'selected' : ''}>5 - Pumps</option>
                            <option value="6" ${def.element === '6' ? 'selected' : ''}>6 - Monitoring</option>
                            <option value="7" ${def.element === '7' ? 'selected' : ''}>7 - Management</option>
                            <option value="8" ${def.element === '8' ? 'selected' : ''}>8 - Operators</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="modal-def-type" class="form-select">
                            <option value="">Select...</option>
                            <option ${def.type === 'Significant' ? 'selected' : ''}>Significant</option>
                            <option ${def.type === 'Minor' ? 'selected' : ''}>Minor</option>
                            <option ${def.type === 'Recommendation' ? 'selected' : ''}>Recommendation</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="modal-def-desc" class="form-textarea" rows="3">${def.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Regulatory Citation</label>
                    <input type="text" id="modal-def-citation" class="form-input" value="${def.citation || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Date Identified</label>
                        <input type="date" id="modal-def-date" class="form-input" value="${def.dateIdentified || ''}">
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="modal-def-due" class="form-input" value="${def.dueDate || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Status *</label>
                    <select id="modal-def-status" class="form-select">
                        <option ${def.status === 'Open' ? 'selected' : ''}>Open</option>
                        <option ${def.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                        <option ${def.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                        <option ${def.status === 'Closed' ? 'selected' : ''}>Closed</option>
                        <option ${def.status === 'Ongoing' ? 'selected' : ''}>Ongoing</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Target Completion Date</label>
                        <input type="date" id="modal-def-target" class="form-input" value="${def.targetCompletion || ''}">
                    </div>
                    <div class="form-group">
                        <label>Actual Completion Date</label>
                        <input type="date" id="modal-def-completed" class="form-input" value="${def.actualCompletion || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Corrective Action Taken</label>
                    <textarea id="modal-def-action" class="form-textarea" rows="2">${def.correctiveAction || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Resolution Notes</label>
                    <textarea id="modal-def-resolution" class="form-textarea" rows="2">${def.resolution || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveDeficiency(${index})" class="modal-btn modal-btn-primary">Save</button>
                    <button onclick="hideModal()" class="modal-btn">Cancel</button>
                </div>
            `);
        }

        function deleteDeficiency(index) {
            if (confirm('Delete this deficiency?')) {
                currentSystemData.deficiencies.splice(index, 1);
                renderDeficiencies();
                saveData();
            }
        }
        
        // ========== MODAL FUNCTIONS ==========
        
        function showModal(content) {
            const modal = document.getElementById('globalModal');
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = content;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function hideModal() {
            const modal = document.getElementById('globalModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('globalModal');
            if (event.target === modal) {
                hideModal();
            }
        }
        
        // ========== HELPER FUNCTION FOR CURRENT SYSTEM DATA ==========
        
        function getCurrentSystemData() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system) return null;
            
            if (!system.systemData) {
                system.systemData = {
                    overview: {},
                    permits: { amendments: [] },
                    sources: {
                        overallType: '',
                        cccProgram: '',
                        swpMeasures: '',
                        concerns: '',
                        list: []
                    },
                    treatment: {
                        classification: '',
                        capacity: '',
                        type: '',
                        processes: '',
                        opsPlanDate: '',
                        notes: '',
                        facilities: [],
                        chemicals: []
                    },
                    distribution: {},
                    storage: {
                        totalCapacity: '',
                        redundancyAdequate: '',
                        notes: '',
                        tanks: []
                    },
                    pumps: {
                        totalCapacity: '',
                        backupPowerStrategy: '',
                        notes: '',
                        stations: []
                    },
                    monitoring: {},
                    management: {},
                    operators: { chief: {}, shift: [] },
                    deficiencies: [],
                    inspectionHistory: {}
                };
            }
            
            // Migration: Convert old data structures to new ones
            if (system.systemData.sources && Array.isArray(system.systemData.sources)) {
                system.systemData.sources = {
                    overallType: '',
                    cccProgram: '',
                    swpMeasures: '',
                    concerns: '',
                    list: system.systemData.sources
                };
            }
            
            if (system.systemData.storage && Array.isArray(system.systemData.storage)) {
                system.systemData.storage = {
                    totalCapacity: '',
                    redundancyAdequate: '',
                    notes: '',
                    tanks: system.systemData.storage
                };
            }
            
            if (system.systemData.pumps && Array.isArray(system.systemData.pumps)) {
                system.systemData.pumps = {
                    totalCapacity: '',
                    backupPowerStrategy: '',
                    notes: '',
                    stations: system.systemData.pumps
                };
            }
            
            if (system.systemData.pumpStations) {
                if (!system.systemData.pumps || Array.isArray(system.systemData.pumps)) {
                    system.systemData.pumps = {
                        totalCapacity: '',
                        backupPowerStrategy: '',
                        notes: '',
                        stations: system.systemData.pumpStations
                    };
                }
                delete system.systemData.pumpStations;
            }
            
            // Ensure nested structures exist
            if (!system.systemData.sources.list) system.systemData.sources.list = [];
            if (!system.systemData.storage.tanks) system.systemData.storage.tanks = [];
            if (!system.systemData.pumps.stations) system.systemData.pumps.stations = [];
            if (!system.systemData.treatment.facilities) system.systemData.treatment.facilities = [];
            
            // Ensure each treatment facility has a filters array
            if (system.systemData.treatment.facilities) {
                system.systemData.treatment.facilities.forEach(facility => {
                    if (!facility.filters) facility.filters = [];
                });
            }
            
            return system.systemData;
        }
        
        // Create a proxy for easy access
        Object.defineProperty(window, 'currentSystemData', {
            get: function() {
                return getCurrentSystemData();
            }
        });
        
    </script>
    
    <!-- Global Modal -->
    <div id="globalModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="hideModal()">&times;</span>
            <div id="modalBody">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>
</body>
</html>
