<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DDW Field Inspector</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f2f2f7;
            color: #000;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2a5298 0%, #1e3a6b 100%);
            color: white;
            padding: max(env(safe-area-inset-top), 20px) 20px 20px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .back-btn, .settings-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            border: none;
        }

        .settings-btn {
            width: 40px;
            height: 40px;
            padding: 0;
            justify-content: center;
            font-size: 1.2rem;
        }

        .breadcrumb {
            margin-top: 8px;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Screens */
        .screen {
            display: none;
            min-height: calc(100vh - 100px);
            padding-bottom: 80px;
        }

        .screen.active {
            display: block;
        }

        /* Content */
        .content {
            padding: 16px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2a5298;
        }

        .card-meta {
            font-size: 0.85rem;
            color: #8e8e93;
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .card-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-issue {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-good {
            background: #d4edda;
            color: #155724;
        }

        /* Add Button */
        .add-btn {
            position: fixed;
            bottom: max(env(safe-area-inset-bottom), 20px);
            right: 20px;
            background: #2a5298;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 2rem;
            box-shadow: 0 4px 12px rgba(42, 82, 152, 0.4);
            cursor: pointer;
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: flex-end;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: max(env(safe-area-inset-bottom), 20px);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close-btn {
            background: #f2f2f7;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            color: #8e8e93;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 14px;
            border: 1px solid #e5e5ea;
            border-radius: 12px;
            font-size: 1rem;
            background: #f2f2f7;
            font-family: inherit;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #2a5298;
            background: white;
        }

        .save-btn {
            background: #2a5298;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
        }

        .voice-btn {
            background: #34c759;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            margin-bottom: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .voice-btn.recording {
            background: #ff3b30;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Checklist */
        .checklist-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .checklist-section-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #2c3e50;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .checklist-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .checklist-item label {
            flex: 1;
            cursor: pointer;
            font-size: 0.95rem;
        }

        /* Condition Rating */
        .condition-rating {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .condition-btn {
            padding: 12px 8px;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            background: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .condition-btn.selected {
            border-color: currentColor;
        }

        .condition-btn.good.selected {
            background: #d4edda;
            color: #155724;
            border-color: #155724;
        }

        .condition-btn.fair.selected {
            background: #fff3cd;
            color: #856404;
            border-color: #856404;
        }

        .condition-btn.poor.selected {
            background: #f8d7da;
            color: #721c24;
            border-color: #721c24;
        }

        .condition-btn.issue.selected {
            background: #f8d7da;
            color: #721c24;
            border-color: #721c24;
            font-weight: 700;
        }

        /* Photo Upload */
        .photo-upload-area {
            border: 2px dashed #e5e5ea;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f2f2f7;
        }

        .photo-upload-area:active {
            background: #e5e5ea;
        }

        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        .photo-preview {
            position: relative;
            aspect-ratio: 1;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .photo-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8e8e93;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        /* Element Tabs */
        .element-tabs {
            display: flex;
            overflow-x: auto;
            background: white;
            padding: 8px 8px 0 8px;
            gap: 6px;
            -webkit-overflow-scrolling: touch;
            border-bottom: 1px solid #e5e5ea;
        }

        .element-tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            flex-shrink: 0;
            background: #f2f2f7;
            border: none;
            padding: 12px 20px;
            border-radius: 12px 12px 0 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: #8e8e93;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .tab-btn.active {
            background: #2a5298;
            color: white;
        }

        .tab-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ff3b30;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Asset Card */
        .asset-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
        }

        .asset-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .asset-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2a5298;
        }

        .asset-card-status {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .asset-card-info {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .element-section {
            display: none;
        }

        .element-section.active {
            display: block;
        }

        .section-header {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #2c3e50;
        }

        .quick-add-btn {
            background: white;
            color: #2a5298;
            border: 2px dashed #2a5298;
            border-radius: 12px;
            padding: 16px;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            margin-bottom: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .quick-add-btn:active {
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1 id="headerTitle">üö∞ Systems</h1>
            <div class="header-actions">
                <button class="back-btn" id="backBtn" style="display: none;" onclick="goBack()">‚Üê Back</button>
                <button class="settings-btn" onclick="showSettings()">‚öô</button>
            </div>
        </div>
        <div class="breadcrumb" id="breadcrumb" style="display: none;"></div>
    </div>

    <!-- Systems Screen -->
    <div class="screen active" id="systemsScreen">
        <div class="content" id="systemsList"></div>
        <button class="add-btn" onclick="showAddSystemModal()">+</button>
    </div>

    <!-- Inspections Screen -->
    <div class="screen" id="inspectionsScreen">
        <div class="content" id="inspectionsList"></div>
        <button class="add-btn" onclick="showAddInspectionModal()">+</button>
    </div>

    <!-- Field Inspector Screen -->
    <div class="screen" id="fieldInspectorScreen">
        <div class="element-tabs">
            <button class="tab-btn active" data-element="sources" onclick="switchElement('sources')">Sources</button>
            <button class="tab-btn" data-element="treatment" onclick="switchElement('treatment')">Treatment</button>
            <button class="tab-btn" data-element="storage" onclick="switchElement('storage')">Storage</button>
            <button class="tab-btn" data-element="pumps" onclick="switchElement('pumps')">Pumps</button>
            <button class="tab-btn" data-element="distribution" onclick="switchElement('distribution')">Distribution</button>
            <button class="tab-btn" data-element="management" onclick="switchElement('management')">Management</button>
            <button class="tab-btn" data-element="operators" onclick="switchElement('operators')">Operators</button>
        </div>
        <div class="content">
            <!-- Sources -->
            <div class="element-section active" id="sources-section">
                <div class="section-header">üï≥Ô∏è Wells & Groundwater Sources</div>
                <button class="quick-add-btn" onclick="addAsset('well')">‚ûï Add Well</button>
                <div id="wells-list"></div>
                
                <div class="section-header" style="margin-top: 24px;">üåä Surface Water Sources</div>
                <button class="quick-add-btn" onclick="addAsset('surface_water')">‚ûï Add Surface Water Intake</button>
                <div id="surface_water-list"></div>
            </div>

            <!-- Treatment -->
            <div class="element-section" id="treatment-section">
                <div class="section-header">üè≠ Treatment Plants</div>
                <button class="quick-add-btn" onclick="addAsset('treatment_plant')">‚ûï Add Treatment Plant</button>
                <div id="treatment_plant-list"></div>
            </div>

            <!-- Storage -->
            <div class="element-section" id="storage-section">
                <div class="section-header">üíß Storage Tanks</div>
                <button class="quick-add-btn" onclick="addAsset('storage_tank')">‚ûï Add Storage Tank</button>
                <div id="storage_tank-list"></div>
            </div>

            <!-- Pumps -->
            <div class="element-section" id="pumps-section">
                <div class="section-header">üöø Pump Stations</div>
                <button class="quick-add-btn" onclick="addAsset('pump_station')">‚ûï Add Pump Station</button>
                <div id="pump_station-list"></div>
            </div>

            <!-- Distribution -->
            <div class="element-section" id="distribution-section">
                <div class="section-header">üîß Distribution System</div>
                <button class="quick-add-btn" onclick="addAsset('distribution_general')">‚ûï Add Observation</button>
                <div id="distribution_general-list"></div>
            </div>

            <!-- Management -->
            <div class="element-section" id="management-section">
                <div class="section-header">üìã Management & Operations</div>
                <button class="quick-add-btn" onclick="addAsset('management_general')">‚ûï Add Observation</button>
                <div id="management_general-list"></div>
            </div>

            <!-- Operators -->
            <div class="element-section" id="operators-section">
                <div class="section-header">üë∑ Operators</div>
                <button class="quick-add-btn" onclick="addAsset('operator')">‚ûï Add Operator</button>
                <div id="operator-list"></div>
            </div>
        </div>
    </div>

    <!-- Modals will be added dynamically -->
    <div id="modalContainer"></div>

    <script>
        // Global state
        let currentScreen = 'systems';
        let currentSystemId = null;
        let currentInspectionId = null;
        let currentElement = 'sources';
        let currentAssetType = null;
        let currentAssetId = null;
        let currentPhotos = [];
        let recognition = null;

        // Data structure
        let appData = {
            systems: []
        };

        // Asset type definitions with inspection checklists
        const assetTypes = {
            well: {
                name: 'Well',
                icon: 'üï≥Ô∏è',
                fields: [
                    { id: 'name', label: 'Well Name/Number', type: 'text', required: true },
                    { id: 'location', label: 'Location', type: 'text' }
                ],
                checklist: [
                    { id: 'wellhead_sealed', label: 'Wellhead properly sealed', section: 'Physical Condition' },
                    { id: 'sanitary_seal', label: 'Sanitary seal intact', section: 'Physical Condition' },
                    { id: 'vent_screened', label: 'Vent present and screened', section: 'Physical Condition' },
                    { id: 'fenced', label: 'Fenced and secured', section: 'Security' },
                    { id: 'fence_condition', label: 'Fence in good condition', section: 'Security' },
                    { id: 'vegetation', label: 'Vegetation clearance adequate', section: 'Sanitary Protection' },
                    { id: 'drainage', label: 'Proper drainage away from wellhead', section: 'Sanitary Protection' },
                    { id: 'no_cross_connections', label: 'No visible cross-connections', section: 'Sanitary Protection' },
                    { id: 'signage', label: 'Proper signage present', section: 'Security' }
                ]
            },
            surface_water: {
                name: 'Surface Water Intake',
                icon: 'üåä',
                fields: [
                    { id: 'name', label: 'Intake Name', type: 'text', required: true },
                    { id: 'location', label: 'Location', type: 'text' }
                ],
                checklist: [
                    { id: 'screened', label: 'Intake properly screened', section: 'Physical Condition' },
                    { id: 'screens_clean', label: 'Screens clean and intact', section: 'Physical Condition' },
                    { id: 'structure_sound', label: 'Structure in good condition', section: 'Physical Condition' },
                    { id: 'fenced', label: 'Fenced and secured', section: 'Security' },
                    { id: 'signage', label: 'Proper signage present', section: 'Security' },
                    { id: 'monitoring', label: 'Source water monitoring equipment functional', section: 'Operations' }
                ]
            },
            treatment_plant: {
                name: 'Treatment Plant',
                icon: 'üè≠',
                fields: [
                    { id: 'name', label: 'Plant Name', type: 'text', required: true },
                    { id: 'treatment_type', label: 'Treatment Type', type: 'text' }
                ],
                checklist: [
                    { id: 'filters_operational', label: 'Filters operational', section: 'Process Equipment' },
                    { id: 'chemical_feed', label: 'Chemical feed systems working', section: 'Process Equipment' },
                    { id: 'monitoring_equipment', label: 'Monitoring equipment operational', section: 'Process Equipment' },
                    { id: 'chemical_storage', label: 'Chemical storage properly secured', section: 'Safety' },
                    { id: 'spill_containment', label: 'Spill containment in place', section: 'Safety' },
                    { id: 'eyewash_shower', label: 'Eyewash/safety shower accessible', section: 'Safety' },
                    { id: 'sds_available', label: 'SDS sheets available and accessible', section: 'Safety' },
                    { id: 'ventilation', label: 'Adequate ventilation', section: 'Safety' },
                    { id: 'building_condition', label: 'Building in good condition', section: 'Physical Condition' },
                    { id: 'secured', label: 'Facility secured/locked', section: 'Security' }
                ]
            },
            storage_tank: {
                name: 'Storage Tank',
                icon: 'üíß',
                fields: [
                    { id: 'name', label: 'Tank Name', type: 'text', required: true },
                    { id: 'capacity', label: 'Capacity (gallons)', type: 'text' }
                ],
                checklist: [
                    { id: 'vent_present', label: 'Vent present', section: 'Sanitary Protection' },
                    { id: 'vent_screened', label: 'Vent properly screened (24 mesh)', section: 'Sanitary Protection' },
                    { id: 'overflow_screened', label: 'Overflow properly screened', section: 'Sanitary Protection' },
                    { id: 'overflow_discharged', label: 'Overflow discharges to approved location', section: 'Sanitary Protection' },
                    { id: 'hatch_secured', label: 'Hatch secured/locked', section: 'Security' },
                    { id: 'hatch_gasket', label: 'Hatch gasket in good condition', section: 'Physical Condition' },
                    { id: 'exterior_condition', label: 'Exterior coating/paint condition good', section: 'Physical Condition' },
                    { id: 'no_rust', label: 'No significant rust/corrosion', section: 'Physical Condition' },
                    { id: 'ladder_condition', label: 'Access ladder in good condition', section: 'Safety' },
                    { id: 'fence_condition', label: 'Fence/security in good condition', section: 'Security' },
                    { id: 'drainage', label: 'Proper drainage around tank', section: 'Sanitary Protection' },
                    { id: 'level_indicator', label: 'Level indicator operational', section: 'Operations' }
                ]
            },
            pump_station: {
                name: 'Pump Station',
                icon: 'üöø',
                fields: [
                    { id: 'name', label: 'Station Name', type: 'text', required: true },
                    { id: 'location', label: 'Location', type: 'text' }
                ],
                checklist: [
                    { id: 'pumps_running', label: 'Pumps running without unusual noise/vibration', section: 'Equipment Operation' },
                    { id: 'no_leaks', label: 'No visible leaks', section: 'Equipment Operation' },
                    { id: 'check_valve', label: 'Check valve condition good', section: 'Equipment Operation' },
                    { id: 'pressure_gauges', label: 'Pressure gauges functional', section: 'Equipment Operation' },
                    { id: 'backup_power', label: 'Backup generator present', section: 'Reliability' },
                    { id: 'generator_fuel', label: 'Generator fuel level adequate', section: 'Reliability' },
                    { id: 'generator_tested', label: 'Evidence of generator testing', section: 'Reliability' },
                    { id: 'ventilation', label: 'Adequate ventilation', section: 'Safety' },
                    { id: 'secured', label: 'Facility secured/locked', section: 'Security' },
                    { id: 'alarms', label: 'Alarm system functional', section: 'Operations' },
                    { id: 'controls', label: 'Control panel operational', section: 'Operations' }
                ]
            },
            distribution_general: {
                name: 'Distribution Observation',
                icon: 'üîß',
                fields: [
                    { id: 'location', label: 'Location', type: 'text', required: true },
                    { id: 'observation_type', label: 'Type', type: 'select', options: [
                        'Hydrant',
                        'Valve',
                        'Main Line',
                        'Service Connection',
                        'Cross-Connection',
                        'General'
                    ]}
                ],
                checklist: []
            },
            management_general: {
                name: 'Management Observation',
                icon: 'üìã',
                fields: [
                    { id: 'topic', label: 'Topic', type: 'text', required: true },
                    { id: 'category', label: 'Category', type: 'select', options: [
                        'Organization',
                        'Financial',
                        'Planning',
                        'Reliability',
                        'Security',
                        'General'
                    ]}
                ],
                checklist: []
            },
            operator: {
                name: 'Operator',
                icon: 'üë∑',
                fields: [
                    { id: 'name', label: 'Operator Name', type: 'text', required: true },
                    { id: 'role', label: 'Role', type: 'select', options: [
                        'Chief Operator - Treatment',
                        'Chief Operator - Distribution',
                        'Shift Operator',
                        'Other'
                    ]},
                    { id: 'certification', label: 'Certification Level', type: 'text' },
                    { id: 'cert_number', label: 'Certificate Number', type: 'text' },
                    { id: 'cert_expiry', label: 'Expiration Date', type: 'date' }
                ],
                checklist: [
                    { id: 'cert_current', label: 'Certification current and valid', section: 'Compliance' },
                    { id: 'grade_adequate', label: 'Grade meets system requirements', section: 'Compliance' },
                    { id: 'onsite_available', label: 'Available for onsite duties', section: 'Staffing' }
                ]
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Initialize speech recognition
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    const noteText = document.getElementById('observationsText');
                    if (noteText) {
                        noteText.value += (noteText.value ? ' ' : '') + transcript;
                    }
                };
                
                recognition.onerror = function(event) {
                    if (event.error === 'not-allowed') {
                        alert('Microphone access denied. Please allow microphone access.');
                    }
                };
                
                recognition.onend = function() {
                    const voiceBtn = document.getElementById('voiceBtn');
                    if (voiceBtn) {
                        voiceBtn.classList.remove('recording');
                        voiceBtn.innerHTML = '<span>üé§</span><span>Tap to use voice</span>';
                    }
                };
            }
            
            renderSystems();
        });

        // Data persistence
        function loadData() {
            const savedData = localStorage.getItem('ddwFieldInspector');
            if (savedData) {
                appData = JSON.parse(savedData);
            }
        }

        function saveData() {
            localStorage.setItem('ddwFieldInspector', JSON.stringify(appData));
        }

        // Navigation
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screen + 'Screen').classList.add('active');
            currentScreen = screen;
            updateHeader();
        }

        function updateHeader() {
            const backBtn = document.getElementById('backBtn');
            const headerTitle = document.getElementById('headerTitle');
            const breadcrumb = document.getElementById('breadcrumb');
            
            if (currentScreen === 'systems') {
                backBtn.style.display = 'none';
                headerTitle.textContent = 'üö∞ Systems';
                breadcrumb.style.display = 'none';
            } else if (currentScreen === 'inspections') {
                backBtn.style.display = 'flex';
                const system = appData.systems.find(s => s.id === currentSystemId);
                headerTitle.textContent = system ? system.name : 'Inspections';
                breadcrumb.style.display = 'block';
                breadcrumb.textContent = 'Select an inspection';
            } else if (currentScreen === 'fieldInspector') {
                backBtn.style.display = 'flex';
                const system = appData.systems.find(s => s.id === currentSystemId);
                const inspection = system?.inspections.find(i => i.id === currentInspectionId);
                if (inspection) {
                    const dateParts = inspection.date.split('-');
                    const localDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                    headerTitle.textContent = localDate.toLocaleDateString();
                } else {
                    headerTitle.textContent = 'Field Inspector';
                }
                breadcrumb.style.display = 'block';
                breadcrumb.textContent = system ? system.name : '';
            }
        }

        function goBack() {
            if (currentScreen === 'fieldInspector') {
                currentInspectionId = null;
                showInspections(currentSystemId);
            } else if (currentScreen === 'inspections') {
                currentSystemId = null;
                showScreen('systems');
                renderSystems();
            }
        }

        // Systems
        function renderSystems() {
            const container = document.getElementById('systemsList');
            
            if (appData.systems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üö∞</div>
                        <div>No systems yet</div>
                        <div style="font-size: 0.85rem; margin-top: 8px;">Tap + to add your first water system</div>
                    </div>
                `;
            } else {
                container.innerHTML = appData.systems.map(system => {
                    const inspectionCount = system.inspections.length;
                    const totalAssets = system.inspections.reduce((sum, insp) => sum + (insp.assets?.length || 0), 0);
                    
                    return `
                        <div class="card" onclick="showInspections('${system.id}')">
                            <div class="card-title">${system.name}</div>
                            <div class="card-meta">
                                <span>${inspectionCount} inspection${inspectionCount !== 1 ? 's' : ''}</span>
                                <span class="card-badge">${totalAssets} assets inspected</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function showAddSystemModal() {
            const modal = createModal('Add System', `
                <form id="addSystemForm" onsubmit="saveSystem(event)">
                    <div class="form-group">
                        <label class="form-label">System Name</label>
                        <input type="text" class="form-input" id="systemNameInput" placeholder="e.g., Pine Valley Water District" required>
                    </div>
                    <button type="submit" class="save-btn">Create System</button>
                </form>
            `);
            showModal(modal);
        }

        function saveSystem(event) {
            event.preventDefault();
            
            const system = {
                id: Date.now().toString(),
                name: document.getElementById('systemNameInput').value,
                inspections: [],
                createdAt: new Date().toISOString()
            };
            
            appData.systems.push(system);
            saveData();
            closeModal();
            renderSystems();
        }

        // Inspections
        function showInspections(systemId) {
            currentSystemId = systemId;
            showScreen('inspections');
            renderInspections();
        }

        function renderInspections() {
            const container = document.getElementById('inspectionsList');
            const system = appData.systems.find(s => s.id === currentSystemId);
            
            if (!system) return;
            
            if (system.inspections.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div>No inspections yet</div>
                        <div style="font-size: 0.85rem; margin-top: 8px;">Tap + to start a new inspection</div>
                    </div>
                `;
            } else {
                container.innerHTML = system.inspections
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .map(inspection => {
                        const assets = inspection.assets || [];
                        const issueCount = assets.filter(a => a.condition === 'poor' || a.condition === 'issue').length;
                        
                        const dateParts = inspection.date.split('-');
                        const localDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                        
                        return `
                            <div class="card" onclick="showFieldInspector('${inspection.id}')">
                                <div class="card-title">${localDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                                <div class="card-meta">
                                    <span>${assets.length} assets</span>
                                    ${issueCount > 0 ? `<span class="card-badge badge-issue">‚ö†Ô∏è ${issueCount} issues</span>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
            }
        }

        function showAddInspectionModal() {
            const modal = createModal('New Inspection', `
                <form id="addInspectionForm" onsubmit="saveInspection(event)">
                    <div class="form-group">
                        <label class="form-label">Inspection Date</label>
                        <input type="date" class="form-input" id="inspectionDateInput" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <button type="submit" class="save-btn">Start Inspection</button>
                </form>
            `);
            showModal(modal);
        }

        function saveInspection(event) {
            event.preventDefault();
            
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system) return;
            
            const inspection = {
                id: Date.now().toString(),
                date: document.getElementById('inspectionDateInput').value,
                assets: [],
                createdAt: new Date().toISOString()
            };
            
            system.inspections.push(inspection);
            saveData();
            closeModal();
            
            // Automatically open the new inspection
            showFieldInspector(inspection.id);
        }

        // Field Inspector
        function showFieldInspector(inspectionId) {
            currentInspectionId = inspectionId;
            showScreen('fieldInspector');
            renderAssets();
        }

        function switchElement(element) {
            currentElement = element;
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-element="${element}"]`).classList.add('active');
            
            document.querySelectorAll('.element-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(element + '-section').classList.add('active');
        }

        function renderAssets() {
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system) return;
            
            const inspection = system.inspections.find(i => i.id === currentInspectionId);
            if (!inspection) return;
            
            if (!inspection.assets) inspection.assets = [];
            
            // Render each asset type
            Object.keys(assetTypes).forEach(assetType => {
                const container = document.getElementById(assetType + '-list');
                if (!container) return;
                
                const assets = inspection.assets.filter(a => a.type === assetType);
                
                if (assets.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #8e8e93; font-size: 0.9rem;">
                            No ${assetTypes[assetType].name.toLowerCase()}s added yet
                        </div>
                    `;
                } else {
                    container.innerHTML = assets.map(asset => renderAssetCard(asset)).join('');
                }
            });
        }

        function renderAssetCard(asset) {
            const assetTypeDef = assetTypes[asset.type];
            const statusClass = asset.condition === 'good' ? 'badge-good' : 
                               asset.condition === 'fair' ? 'badge-warning' :
                               asset.condition === 'poor' ? 'badge-issue' :
                               asset.condition === 'issue' ? 'badge-issue' : 'card-badge';
            
            const statusLabel = asset.condition === 'good' ? '‚úì Good' :
                               asset.condition === 'fair' ? '‚ö† Fair' :
                               asset.condition === 'poor' ? '‚ö†Ô∏è Poor' :
                               asset.condition === 'issue' ? 'üö® Major Issue' :
                               'Not assessed';
            
            const checkedItems = Object.values(asset.checklist || {}).filter(v => v === true).length;
            const totalItems = assetTypeDef.checklist.length;
            
            return `
                <div class="asset-card" onclick="editAsset('${asset.id}')">
                    <div class="asset-card-header">
                        <div class="asset-card-title">${assetTypeDef.icon} ${asset.data.name || 'Unnamed'}</div>
                        <div class="asset-card-status ${statusClass}">${statusLabel}</div>
                    </div>
                    ${asset.data.location ? `<div class="asset-card-info">üìç ${asset.data.location}</div>` : ''}
                    ${totalItems > 0 ? `<div class="asset-card-info">‚úì ${checkedItems}/${totalItems} items checked</div>` : ''}
                    ${asset.photos?.length > 0 ? `<div class="asset-card-info">üì∑ ${asset.photos.length} photo${asset.photos.length !== 1 ? 's' : ''}</div>` : ''}
                </div>
            `;
        }

        function addAsset(assetType) {
            currentAssetType = assetType;
            currentAssetId = null;
            currentPhotos = [];
            showAssetModal(assetType);
        }

        function editAsset(assetId) {
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system) return;
            
            const inspection = system.inspections.find(i => i.id === currentInspectionId);
            if (!inspection) return;
            
            const asset = inspection.assets.find(a => a.id === assetId);
            if (!asset) return;
            
            currentAssetType = asset.type;
            currentAssetId = assetId;
            currentPhotos = asset.photos || [];
            showAssetModal(asset.type, asset);
        }

        function showAssetModal(assetType, existingAsset = null) {
            const assetTypeDef = assetTypes[assetType];
            const isEdit = existingAsset !== null;
            
            // Build form fields
            let fieldsHTML = assetTypeDef.fields.map(field => {
                const value = existingAsset?.data[field.id] || '';
                
                if (field.type === 'select') {
                    return `
                        <div class="form-group">
                            <label class="form-label">${field.label}${field.required ? ' *' : ''}</label>
                            <select class="form-select" id="field_${field.id}" ${field.required ? 'required' : ''}>
                                <option value="">Select...</option>
                                ${field.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else {
                    return `
                        <div class="form-group">
                            <label class="form-label">${field.label}${field.required ? ' *' : ''}</label>
                            <input type="${field.type}" class="form-input" id="field_${field.id}" value="${value}" ${field.required ? 'required' : ''}>
                        </div>
                    `;
                }
            }).join('');
            
            // Build checklist
            let checklistHTML = '';
            if (assetTypeDef.checklist.length > 0) {
                const sections = [...new Set(assetTypeDef.checklist.map(item => item.section))];
                
                checklistHTML = sections.map(section => {
                    const items = assetTypeDef.checklist.filter(item => item.section === section);
                    return `
                        <div class="checklist-section">
                            <div class="checklist-section-title">${section}</div>
                            ${items.map(item => {
                                const checked = existingAsset?.checklist?.[item.id] || false;
                                return `
                                    <div class="checklist-item">
                                        <input type="checkbox" id="check_${item.id}" ${checked ? 'checked' : ''}>
                                        <label for="check_${item.id}">${item.label}</label>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }).join('');
            }
            
            // Condition rating
            const currentCondition = existingAsset?.condition || '';
            const conditionHTML = `
                <div class="form-group">
                    <label class="form-label">Overall Condition</label>
                    <div class="condition-rating">
                        <button type="button" class="condition-btn good ${currentCondition === 'good' ? 'selected' : ''}" onclick="selectCondition('good')">‚úì Good</button>
                        <button type="button" class="condition-btn fair ${currentCondition === 'fair' ? 'selected' : ''}" onclick="selectCondition('fair')">‚ö† Fair</button>
                        <button type="button" class="condition-btn poor ${currentCondition === 'poor' ? 'selected' : ''}" onclick="selectCondition('poor')">‚ö†Ô∏è Poor</button>
                        <button type="button" class="condition-btn issue ${currentCondition === 'issue' ? 'selected' : ''}" onclick="selectCondition('issue')">üö® Major Issue</button>
                    </div>
                </div>
            `;
            
            // Voice and observations
            const observations = existingAsset?.observations || '';
            const observationsHTML = `
                <div class="form-group">
                    <label class="form-label">Observations & Notes</label>
                    <button type="button" class="voice-btn" id="voiceBtn" onclick="toggleVoiceInput()">
                        <span>üé§</span><span>Tap to use voice</span>
                    </button>
                    <textarea class="form-textarea" id="observationsText" placeholder="Add any additional observations, deficiencies, or notes...">${observations}</textarea>
                </div>
            `;
            
            // Photos
            const photoHTML = `
                <div class="form-group">
                    <label class="form-label">Photos</label>
                    <input type="file" id="photoInput" accept="image/*" multiple capture="environment" style="display: none;" onchange="handlePhotoUpload(event)">
                    <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                        <div>üì∑ Tap to add photos</div>
                    </div>
                    <div class="photo-preview-grid" id="photoPreviewGrid">${renderPhotoGrid()}</div>
                </div>
            `;
            
            const modalContent = `
                <form id="assetForm" onsubmit="saveAsset(event)">
                    ${fieldsHTML}
                    ${checklistHTML}
                    ${conditionHTML}
                    ${observationsHTML}
                    ${photoHTML}
                    <button type="submit" class="save-btn">${isEdit ? 'Update' : 'Save'} ${assetTypeDef.name}</button>
                    ${isEdit ? `<button type="button" onclick="deleteAsset('${existingAsset.id}')" style="margin-top: 12px; background: #ff3b30;" class="save-btn">Delete ${assetTypeDef.name}</button>` : ''}
                </form>
            `;
            
            const modal = createModal(`${isEdit ? 'Edit' : 'Add'} ${assetTypeDef.name}`, modalContent);
            showModal(modal);
        }

        let selectedCondition = '';
        function selectCondition(condition) {
            selectedCondition = condition;
            document.querySelectorAll('.condition-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function toggleVoiceInput() {
            if (!recognition) {
                alert('Voice input not supported on this browser.');
                return;
            }
            
            const voiceBtn = document.getElementById('voiceBtn');
            
            if (voiceBtn.classList.contains('recording')) {
                recognition.stop();
            } else {
                voiceBtn.classList.add('recording');
                voiceBtn.innerHTML = '<span>üî¥</span><span>Listening... (tap to stop)</span>';
                recognition.start();
            }
        }

        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentPhotos.push(e.target.result);
                    document.getElementById('photoPreviewGrid').innerHTML = renderPhotoGrid();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderPhotoGrid() {
            return currentPhotos.map((photo, index) => `
                <div class="photo-preview">
                    <img src="${photo}" alt="Photo ${index + 1}">
                    <button class="photo-remove" onclick="removePhoto(${index})">√ó</button>
                </div>
            `).join('');
        }

        function removePhoto(index) {
            currentPhotos.splice(index, 1);
            document.getElementById('photoPreviewGrid').innerHTML = renderPhotoGrid();
        }

        function saveAsset(event) {
            event.preventDefault();
            
            const system = appData.systems.find(s => s.id === currentSystemId);
            if (!system) return;
            
            const inspection = system.inspections.find(i => i.id === currentInspectionId);
            if (!inspection) return;
            
            const assetTypeDef = assetTypes[currentAssetType];
            
            // Collect field data
            const data = {};
            assetTypeDef.fields.forEach(field => {
                data[field.id] = document.getElementById('field_' + field.id).value;
            });
            
            // Collect checklist data
            const checklist = {};
            assetTypeDef.checklist.forEach(item => {
                checklist[item.id] = document.getElementById('check_' + item.id)?.checked || false;
            });
            
            const asset = {
                id: currentAssetId || Date.now().toString(),
                type: currentAssetType,
                data: data,
                checklist: checklist,
                condition: selectedCondition,
                observations: document.getElementById('observationsText').value,
                photos: [...currentPhotos],
                timestamp: new Date().toISOString()
            };
            
            if (currentAssetId) {
                // Update existing
                const index = inspection.assets.findIndex(a => a.id === currentAssetId);
                if (index !== -1) {
                    inspection.assets[index] = asset;
                }
            } else {
                // Add new
                inspection.assets.push(asset);
            }
            
            saveData();
            closeModal();
            renderAssets();
            
            // Reset
            currentAssetId = null;
            currentPhotos = [];
            selectedCondition = '';
        }

        function deleteAsset(assetId) {
            if (confirm('Delete this asset inspection?')) {
                const system = appData.systems.find(s => s.id === currentSystemId);
                if (!system) return;
                
                const inspection = system.inspections.find(i => i.id === currentInspectionId);
                if (!inspection) return;
                
                inspection.assets = inspection.assets.filter(a => a.id !== assetId);
                saveData();
                closeModal();
                renderAssets();
            }
        }

        // Modal helpers
        function createModal(title, content) {
            return `
                <div class="modal active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">${title}</h2>
                            <button class="close-btn" onclick="closeModal()">√ó</button>
                        </div>
                        ${content}
                    </div>
                </div>
            `;
        }

        function showModal(modalHTML) {
            document.getElementById('modalContainer').innerHTML = modalHTML;
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
            currentPhotos = [];
            selectedCondition = '';
        }

        // Settings
        function showSettings() {
            const modal = createModal('‚öô Settings', `
                <div style="padding: 20px 0;">
                    <div class="form-group">
                        <label class="form-label">Export Data</label>
                        <button class="form-input" onclick="exportAllData()" style="text-align: left; cursor: pointer; background: white; border: 1px solid #e5e5ea;">
                            üì§ Export All Data
                        </button>
                        <small style="color: #8e8e93; display: block; margin-top: 8px;">Download all systems, inspections, and assets as JSON</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data Management</label>
                        <button class="form-input" onclick="clearAllData()" style="text-align: left; cursor: pointer; background: white; border: 1px solid #e5e5ea; color: #ff3b30;">
                            üóë Clear All Data
                        </button>
                        <small style="color: #8e8e93; display: block; margin-top: 8px;">Permanently delete all data (use Export first!)</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">About</label>
                        <div style="background: #f2f2f7; padding: 12px; border-radius: 8px; font-size: 0.9rem; line-height: 1.6;">
                            <p><strong>DDW Field Inspector v3.0</strong></p>
                            <p style="margin-top: 8px;">Comprehensive asset-based inspection tool for California DDW water system sanitary surveys.</p>
                            <p style="margin-top: 8px; color: #8e8e93;">All data stored locally on your device.</p>
                        </div>
                    </div>
                </div>
            `);
            showModal(modal);
        }

        function exportAllData() {
            const filename = `DDW_FieldInspector_${new Date().toISOString().split('T')[0]}.json`;
            const dataStr = JSON.stringify(appData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportLink = document.createElement('a');
            exportLink.setAttribute('href', dataUri);
            exportLink.setAttribute('download', filename);
            exportLink.click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL data?\n\nThis cannot be undone!\n\nConsider using Export first.')) {
                if (confirm('Really delete everything? This is your last chance!')) {
                    appData = { systems: [] };
                    saveData();
                    closeModal();
                    currentSystemId = null;
                    currentInspectionId = null;
                    showScreen('systems');
                    renderSystems();
                    alert('All data deleted.');
                }
            }
        }
    </script>
</body>
</html>
